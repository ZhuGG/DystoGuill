<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TRAME DOUCE — Guillotière (v6.2)</title>
<style>
:root{--bg:#0a0c12;--p:#121826;--p2:#0d1320;--ink:#e9f0ff;--mut:#a6b7d4;--line:#1b2436;
--a:#9cf6ff;--b:#ffc2e9;--warn:#ffbe6e;--bad:#ff6b7a;--good:#7cffb5;--info:#7fb3ff;
--neu:#6ad0ff;--vol:#ff78a8;--som:#ffc76e;--cin:#92ffcc;--sh:0 10px 30px rgba(0,0,0,.35)}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6}
a{color:var(--a)}
.header{position:sticky;top:0;z-index:5;display:flex;gap:12px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(18,24,38,.92),rgba(18,24,38,.66));backdrop-filter:blur(8px)}
.header .title{font-weight:800;letter-spacing:.6px}
.badge{display:inline-block;border:1px solid #2a3a58;background:var(--p2);color:var(--mut);padding:2px 8px;border-radius:999px;font-size:12px}
.grid{display:grid;gap:12px;grid-template-columns:260px 1fr 320px;max-width:1300px;margin:auto;padding:12px}
.col{background:var(--p);border:1px solid var(--line);border-radius:14px;box-shadow:var(--sh);overflow:hidden}
.pad{padding:12px}.row{display:flex;gap:8px;flex-wrap:wrap}.sectionTitle{color:var(--mut);font-size:12px;text-transform:uppercase;margin:0 0 6px}
.tabbtn{padding:8px 12px;border:1px solid #2a3a58;background:linear-gradient(180deg,#151e31,#233355);border-radius:12px;color:var(--ink);cursor:pointer;font-weight:700}
.tabbtn[aria-pressed="true"]{outline:2px solid var(--a)}
/* stats */
.stat{display:grid;grid-template-columns:26px 1fr 24px;align-items:center;background:var(--p2);border:1px solid var(--line);border-radius:10px;padding:6px;min-width:118px}
.stat .dot{width:18px;height:18px;border-radius:5px} .stat .name{font-size:11px;color:var(--mut);text-transform:uppercase} .stat .val{font-weight:800;text-align:right}
.neu .dot{background:var(--neu)} .neu .val{color:var(--neu)} .vol .dot{background:var(--vol)} .vol .val{color:var(--vol)} .som .dot{background:var(--som)} .som .val{color:var(--som)} .cin .dot{background:var(--cin)} .cin .val{color:var(--cin)}
/* gauges */
.resbar{display:flex;gap:8px}.res{flex:1;background:var(--p2);border:1px solid var(--line);border-radius:10px;overflow:hidden}
.res .lbl{font-size:12px;color:var(--mut);padding:6px 8px;border-bottom:1px solid var(--line)} .meter{height:6px;background:var(--line)}
.fill{height:6px;background:linear-gradient(90deg,var(--a),var(--b))}.fill.bad{background:linear-gradient(90deg,var(--bad),var(--warn))}
/* story */
.storyImage{position:relative;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#0a0e13}
.storyImage img{width:100%;height:200px;object-fit:cover;filter:contrast(1.05) saturate(1.1) brightness(.88)}
.storyImage .legend{position:absolute;left:10px;bottom:10px;background:rgba(10,14,19,.7);padding:6px 8px;border-radius:8px;border:1px solid var(--line);color:var(--mut);font-size:12px}
.storyBody{background:var(--p2);border:1px solid var(--line);border-radius:14px;padding:14px}
.choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.choice{position:relative;border:1px solid #2a3a58;background:linear-gradient(180deg,#151e31,#233355);padding:10px 12px;border-radius:12px;cursor:pointer}
.choice:hover{outline:2px solid var(--a)} .choice small{display:block;color:var(--mut)}
.choice .tags{position:absolute;right:8px;top:8px;display:flex;gap:6px;flex-wrap:wrap}
.tag{padding:2px 6px;border-radius:999px;border:1px solid var(--line);font-size:11px;background:rgba(255,255,255,.03)}
.attr-NEU{border-left:4px solid var(--neu)} .attr-VOL{border-left:4px solid var(--vol)} .attr-SOM{border-left:4px solid var(--som)} .attr-CIN{border-left:4px solid var(--cin)}
/* ascii + logs */
.ascii{font-family:Consolas,Menlo,monospace;font-size:12px;background:#0b0f15;border:1px solid var(--line);border-radius:12px;padding:10px;white-space:pre-wrap;color:#b9c7da}
.log{height:360px;overflow:auto;background:var(--p2);border:1px solid var(--line);border-radius:12px;padding:8px}
.timeline{height:160px;overflow:auto;background:var(--p2);border:1px solid var(--line);border-radius:12px;padding:8px}
.timeline .item{margin:4px 0;padding:8px;border-left:3px solid var(--b);background:rgba(255,255,255,.02);border-radius:8px}
.timeline .when{color:var(--mut);font-size:12px}
/* tests + dés */
.testPanel{margin-top:10px;border:1px dashed #2a3a58;border-radius:12px;padding:8px 10px;background:rgba(255,255,255,.02)}
#diceOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99}
.diceWrap{background:var(--p);border:1px solid var(--line);border-radius:14px;padding:16px;min-width:300px;text-align:center}
.cubes{display:flex;gap:16px;justify-content:center;margin:10px 0 4px 0}
.cube{width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg,#1b2330,#0b1017);border:1px solid #273243;display:grid;place-items:center;font-size:40px;color:#fff}
.anim{animation:roll 1s ease-in-out infinite}@keyframes roll{0%{transform:rotate(0)}33%{transform:rotate(12deg)}66%{transform:rotate(-9deg)}100%{transform:rotate(0)}
/* modals */
.modalScreen{position:fixed;inset:0;background:rgba(10,14,19,.88);display:flex;align-items:center;justify-content:center;z-index:101}
.modalBox{background:var(--p);border:1px solid var(--line);padding:16px;border-radius:16px;max-width:1000px;width:95%}
.arches{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.arch{border:2px solid #2a3a58;background:linear-gradient(180deg,#141a23,#0e141c);border-radius:14px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column}
.arch img{width:100%;height:130px;object-fit:cover}.arch .pad{padding:10px}.arch[aria-selected="true"]{outline:3px solid var(--a)}
/* tabs visibility */
[data-view="story"] .left,[data-view="story"] .right{display:none}
[data-view="profile"] .mid,[data-view="profile"] .right{display:none}
[data-view="journal"] .left,[data-view="journal"] .mid{display:none}
@media (max-width:1080px){.grid{grid-template-columns:1fr}.log{height:240px}.timeline{height:140px}}
</style>
</head>
<body data-view="all">
<header class="header">
  <div class="title">⟡ TRAME DOUCE — <span id="loc">Guillotière</span></div>
  <div class="row">
    <span class="badge">Stress <span id="stressVal">5</span>/5</span>
    <span class="badge">Blessures <span id="hpVal">5</span>/5</span>
    <span class="badge">Flux ◆ <span id="fluxVal">2</span></span>
    <span class="badge">Fragments ✦ <span id="fragVal">2</span></span>
  </div>
  <div class="row" style="margin-left:auto">
    <button class="tabbtn" onclick="setView('all')" aria-pressed="true">Tous</button>
    <button class="tabbtn" onclick="setView('story')">Histoire</button>
    <button class="tabbtn" onclick="setView('profile')">Profil</button>
    <button class="tabbtn" onclick="setView('journal')">Journal</button>
    <button class="tabbtn" onclick="toggleAscii()" id="asciiBtn">HUD ASCII ✓</button>
  </div>
</header>

<main class="grid">
  <aside class="col left">
    <div class="pad">
      <div class="sectionTitle">Profil</div>
      <div class="row" id="statsRow"></div>
      <div style="height:8px"></div>
      <div class="resbar">
        <div class="res"><div class="lbl">Stress</div><div class="meter"><div class="fill bad" id="stressFill" style="width:100%"></div></div></div>
        <div class="res"><div class="lbl">Blessures</div><div class="meter"><div class="fill bad" id="hpFill" style="width:100%"></div></div></div>
      </div>
      <div style="height:8px"></div>
      <div class="sectionTitle">Mini-carte</div>
      <div class="ascii" id="miniMap"></div>
      <div style="height:8px"></div>
      <div class="sectionTitle">Réglages</div>
      <div class="row">
        <button class="tabbtn" onclick="toggleReduceAnim()">Réduire anim.</button>
        <button class="tabbtn" onclick="toggleCrude()">Langage cru</button>
        <button class="tabbtn" onclick="exportSave()">Export</button>
        <button class="tabbtn" onclick="importSave()">Import</button>
      </div>
    </div>
    <div class="pad">
      <div class="sectionTitle">HUD ASCII</div>
      <div class="ascii" id="asciiHud"></div>
    </div>
  </aside>

  <section class="col mid">
    <div class="pad">
      <div class="storyImage">
        <img id="storyImg" src="https://images.unsplash.com/photo-1529101091764-c3526daf38fe?q=80&w=1400&auto=format&fit=crop" alt="">
        <div class="legend" id="imgLegend">Souterrain — goutte à goutte</div>
      </div>
      <div class="row">
        <span class="badge">Objectif: <span id="objectiveText">Comprendre la Sourdine et trouver une entrée vers la sous-station T1.</span></span>
      </div>
      <div class="storyBody">
        <h2 id="storyTitle">Prologue — La Sourdine</h2>
        <div id="storyText"></div>
        <div class="choices" id="choices"></div>

        <div class="testPanel" id="testPanel" style="display:none">
          <div class="row">
            <span class="badge">Test: <span id="testName">—</span></span>
            <span class="badge">DD <span id="testDD">10</span></span>
          </div>
          <div class="row" style="align-items:center;margin-top:6px">
            <label class="badge"><input type="checkbox" id="useFlux"> +2 Flux</label>
            <label class="badge"><input type="checkbox" id="usePush"> +2 Pousser sa chance</label>
            <label class="badge"><input type="checkbox" id="useFrag"> ✦ Fragment (indice fort, +1 Stress)</label>
            <button class="tabbtn" id="rollBtn">Lancer les dés</button>
          </div>
          <div class="small" id="testHint"></div>
        </div>
      </div>
    </div>
  </section>

  <aside class="col right">
    <div class="pad">
      <div class="sectionTitle">Journal des dés</div>
      <div class="log" id="log"></div>
      <div style="height:8px"></div>
      <div class="sectionTitle">Journal d’objectifs</div>
      <div class="timeline" id="timeline"></div>
    </div>
  </aside>
</main>

<!-- DICE -->
<div id="diceOverlay">
  <div class="diceWrap">
    <div class="small">2d6 — maintiens pour voir l’animation</div>
    <div class="cubes">
      <div class="cube anim" id="d1">•</div>
      <div class="cube anim" id="d2">•</div>
    </div>
    <div class="row" style="justify-content:center">
      <button class="tabbtn" onclick="stopDice()">Arrêter</button>
    </div>
    <div class="small" id="diceInfo"></div>
  </div>
</div>

<!-- Intro lore -->
<div id="introModal" class="modalScreen">
  <div class="modalBox" style="max-width:900px">
    <h2>TRAME DOUCE — Présentation</h2>
    <p style="color:var(--mut)">Lyon parle bas. <i>La Sourdine</i> rogne les cris, tasse les moteurs, froisse les souvenirs récents. La sous-station <b>T1</b> gémit : si elle tombe, la Guill’ s’éteint.</p>
    <p style="color:var(--mut)">Choisis comment exister ici — dormir sous le pont, bricoler des coffrets, vendre des nouvelles — puis trouve une route propre jusqu’à T1.</p>
    <div class="row" style="justify-content:flex-end">
      <button class="tabbtn" onclick="openArchetypes()">Choisir un archétype</button>
    </div>
  </div>
</div>

<!-- Archetypes -->
<div id="archeModal" class="modalScreen" style="display:none" role="dialog" aria-modal="true">
  <div class="modalBox">
    <h2>Choisis ton archétype</h2>
    <div class="arches" id="archList"></div>
    <div class="row" style="justify-content:flex-end">
      <button class="tabbtn" onclick="randomArch()">Au hasard</button>
      <button class="tabbtn" id="confirmArch" disabled>Valider</button>
    </div>
  </div>
</div>

<script>
/* ---------- DATA ---------- */
const ARCHETYPES=[
 {id:'noor',name:'Noor — Dormeuse du pont',img:'https://images.unsplash.com/photo-1500099817043-86d46000d58f?q=80&w=1400&auto=format&fit=crop',
  back:'Tu dors sous le tablier quand il fait doux. Tu sais disparaître dans le décor, et écouter quand les autres parlent trop.',
  stats:{NEU:2,VOL:3,SOM:1,CIN:3},skills:{Empathie:1,Furtivite:1},
  atout:'Ombre tranquille (1 interaction furtive facile / scène)',startInv:['Feuillet-mica','Cutter','Gants usés']},
 {id:'milo',name:'Milo — Revendeur d’appoint',img:'https://images.unsplash.com/photo-1553867745-e018f36c1f42?q=80&w=1400&auto=format&fit=crop',
  back:'Tu fais tourner des “services” : piles refondues, médocs, rumeurs. Tu parles cash, tu sens la merde à quinze mètres.',
  stats:{NEU:3,VOL:3,SOM:1,CIN:2},skills:{Intimidation:1,Deduction:1},
  atout:'Filon (1 négo facile / scène)',startInv:['Lampe plate','Note marquée','Briquet']},
 {id:'rayan',name:'Rayan — Électricien clandestin',img:'https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=1400&auto=format&fit=crop',
  back:'Tu connais les coffrets, les faux-plombs, les gaines qui chantent. Tu parles au cuivre comme à un gosse têtu.',
  stats:{NEU:3,VOL:2,SOM:3,CIN:2},skills:{Mecanique:1,Cryptanalyse:1},
  atout:'Atelier mobile (+2 au 1er test méc. de la scène)',startInv:['Tournevis isolé','Aimant-alu','Ruban textile']}
];
const IMAGES={
 prologue:{src:'https://images.unsplash.com/photo-1529101091764-c3526daf38fe?q=80&w=1400&auto=format&fit=crop',legend:'Souterrain — goutte à goutte'},
 place:{src:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop',legend:'Place du Pont — pluie sur bitume'},
 mazagran:{src:'https://images.unsplash.com/photo-1519681395355-94c6f1e1b6a7?q=80&w=1400&auto=format&fit=crop',legend:'Friche Mazagran — murs qui boivent'},
 berges:{src:'https://images.unsplash.com/photo-1513506003901-1e6a229e2d15?q=80&w=1400&auto=format&fit=crop',legend:'Berges — darses envasées'},
 pont:{src:'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1400&auto=format&fit=crop',legend:'Pont de la Guill’ — courant bas'},
 t1:{src:'https://images.unsplash.com/photo-1517511620798-cec17d428bc0?q=80&w=1400&auto=format&fit=crop',legend:'Sous-station T1 — panneaux griffés'}
};
const STATE={arch:null,stats:{NEU:2,VOL:2,SOM:2,CIN:2},skills:{},stress:5,hp:5,flux:2,frag:2,
 crude:false,ascii:true,reduceAnim:false,tags:new Set(),inventory:[],objective:'Comprendre la Sourdine et trouver une entrée vers la sous-station T1.',
 objectives:[],scene:'prologue',miniRoute:'',lastRoll:null,visited:new Set()};

/* ---------- HELPERS ---------- */
const el=q=>document.querySelector(q);
function addLog(t){const L=el('#log');const d=document.createElement('div');d.className='line';d.textContent=t;L.prepend(d)}
function addObjective(t){STATE.objectives.push({t:Date.now(),text:t});renderTimeline()}
function formatWhen(t){return new Date(t).toLocaleTimeString()}
function setView(v){document.body.setAttribute('data-view',v);document.querySelectorAll('.tabbtn').forEach(b=>b.setAttribute('aria-pressed',b.textContent.toLowerCase().includes(v)||v==='all'&&b.textContent==='Tous'?'true':'false'))}
function toggleAscii(){STATE.ascii=!STATE.ascii;renderAscii();el('#asciiBtn').textContent='HUD ASCII '+(STATE.ascii?'✓':'✗')}
function toggleReduceAnim(){STATE.reduceAnim=!STATE.reduceAnim;addLog('Animations '+(STATE.reduceAnim?'réduites':'normales'))}
function toggleCrude(){STATE.crude=!STATE.crude;addLog('Langage '+(STATE.crude?'cru':'sobre'))}
function updateBars(){el('#stressVal').textContent=STATE.stress;el('#hpVal').textContent=STATE.hp;el('#fluxVal').textContent=STATE.flux;el('#fragVal').textContent=STATE.frag;
 el('#stressFill').style.width=(STATE.stress/5*100)+'%';el('#hpFill').style.width=(STATE.hp/5*100)+'%'}
function renderStats(){const row=el('#statsRow');row.innerHTML='';const S=STATE.stats;const mk=(cls,name,val)=>`<div class="stat ${cls}"><div class="dot"></div><div class="name">${name}</div><div class="val">${val}</div></div>`;
 row.insertAdjacentHTML('beforeend',mk('neu','Neuro',S.NEU));row.insertAdjacentHTML('beforeend',mk('vol','Volonté',S.VOL));
 row.insertAdjacentHTML('beforeend',mk('som','Somatique',S.SOM));row.insertAdjacentHTML('beforeend',mk('cin','Cinétique',S.CIN))}
function renderAscii(){const hud=el('#asciiHud'),map=el('#miniMap');if(!STATE.ascii){hud.textContent='(désactivé)';map.textContent='(désactivé)';return}
 const tags=[...STATE.tags].join(', ')||'—';hud.textContent=
`╔══[ ATH ]════════════════════════════════════════╗
║ ${STATE.arch?STATE.arch.name:'—'}
║ NEU ${STATE.stats.NEU}  VOL ${STATE.stats.VOL}  SOM ${STATE.stats.SOM}  CIN ${STATE.stats.CIN}
║ Stress ${'█'.repeat(STATE.stress)}${'░'.repeat(5-STATE.stress)}  Bless ${'█'.repeat(STATE.hp)}${'░'.repeat(5-STATE.hp)}
║ Flux ◆${STATE.flux}  Frag ✦${STATE.frag}  Tags: ${tags}
║ Inv: ${STATE.inventory.join(' • ')||'—'}
║ Scène: ${STATE.scene}  Route: ${STATE.miniRoute||'—'}
║ Dernier jet: ${STATE.lastRoll||'—'}
╚══════════════════════════════════════════════════╝`;renderMiniMap()}
function renderMiniMap(){const v=s=>STATE.visited.has(s)?'●':'○';el('#miniMap').textContent=
`[Carte — Guillotière]
      ┌── ${v('place_noor')||v('place_milo')||v('place_solo')?'●':'○'} Place du Pont
${v('prologue')} Prologue
      └── ${v('mazagran_common')||v('mazagran_noor')||v('mazagran_milo')?'●':'○'} Mazagran ── ${v('berges_entry')} Berges ── ${v('pont_path')} Pont ── ${v('t1_entry')||v('t1_core')?'●':'○'} T1
(● vu · ○ pas encore)`}
function renderTimeline(){const T=el('#timeline');T.innerHTML='';STATE.objectives.slice().reverse().forEach(o=>{const d=document.createElement('div');d.className='item';d.innerHTML=`<div>${o.text}</div><div class="when">${formatWhen(o.t)}</div>`;T.appendChild(d)})}
function attrColor(s){return s==='NEU'?'neu':s==='VOL'?'vol':s==='SOM'?'som':s==='CIN'?'cin':''}

/* ---------- SCENES ---------- */
const SCENES={
 prologue:{title:"Prologue — La Sourdine",img:IMAGES.prologue,text:()=>`
<p>On appelle ça <b>la Sourdine</b>. Les sons tirent vers le bas, les cris meurent, les moteurs font semblant.
Les souvenirs récents se délitent si on ne les plaque pas quelque part. Tu portes sur toi un feuillet-mica pour fixer le présent.</p>
<p>Tu te réveilles sous un auvent, côté <b>Place du Pont</b>. Ça sent la pluie sur la poussière et la graisse froide.
Trois messages griffés sur une boîte aux lettres : <i>« T1 a faim »</i>, <i>« Chercher Noor »</i>, <i>« Milo sait »</i>.</p>
<p>La sous-station <b>T1</b> maintient un filet d’électricité dans le quartier. Si elle crève, la nuit sera longue — trop longue. Il te faut une <b>route</b>.</p>`,
 choices:[
  {label:"Chercher Noor — la dormeuse du pont",hint:"Route planquée (furtivité)",tags:['route_noor'],go:'place_noor'},
  {label:"Trouver Milo — revendeur d’appoint",hint:"Passe-droit (négociation)",tags:['route_milo'],go:'place_milo'},
  {label:"Observer seul·e les sorties vers T1",hint:"Lire les flux (neutre)",tags:[],go:'place_solo'}
 ]},
 place_noor:{title:"Place du Pont — Noor",img:IMAGES.place,text:()=>`
<p>Noor fume sous une bâche. Elle te jauge, pas dupe. <b>${STATE.crude?'« T’as une sale gueule »':'« Tu tires la tronche »'}</b>, dit-elle.</p>
<p>Elle sait descendre par les caves et longer les tuyaux tièdes. Mais elle demande un échange : récupérer <b>son sac</b> à <b>Mazagran</b>.</p>`,
 choices:[
  {label:"Accepter — récupérer le sac à Mazagran",hint:"+ Tag Route_Noor | +Objectif",tags:['Route_Noor'],go:'mazagran_noor'},
  {label:"Refuser — elle te file quand même un conseil",hint:"Indice mineur vers Berges",tags:[],go:'place_common'}
 ]},
 place_milo:{title:"Place du Pont — Milo",img:IMAGES.place,text:()=>`
<p>Milo tient un sac de câbles et de rumeurs. <b>${STATE.crude?'« Faut payer ou rendre service »':'« Rien n’est gratuit »'}</b>.
Il peut te faire passer les contrôles sur le pont, mais il veut un dépôt : un <b>coffret</b> à récupérer à <b>Mazagran</b>.</p>`,
 choices:[
  {label:"Prendre le job — coffret pour Milo",hint:"+ Tag Route_Milo | +Objectif",tags:['Route_Milo'],go:'mazagran_milo'},
  {label:"L’envoyer se faire voir — partir seul·e",hint:"Pas de passe-droit",tags:[],go:'place_common'}
 ]},
 place_solo:{title:"Place du Pont — Lire la foule",img:IMAGES.place,text:()=>`
<p>Tu restes assis·e dix minutes et la ville te parle — par les sacs qui frottent, les vélos qui choisissent l’ombre, les voix qui peinent.</p>
<p>Flux stable vers <b>Mazagran</b>, reflux nerveux vers les <b>Berges</b>. T1 est au bout du fil — quelque part sous la ligne du tram.</p>`,
 choices:[
  {label:"Suivre le flux — aller à Mazagran",hint:"Point de départ classique",go:'mazagran_common'},
  {label:"Forcer la chance — filer aux Berges direct",hint:"Plus risqué mais plus court",tags:['HardWay'],go:'berges_entry'}
 ]},
 place_common:{title:"Place du Pont — Route hésitante",img:IMAGES.place,text:()=>`<p>Tu prends quand même la direction de <b>Mazagran</b>. La pluie fait des fils sur les capuches.</p>`,
 choices:[{label:"Aller à Mazagran",go:'mazagran_common'}]},
 mazagran_common:{title:"Friche Mazagran — Cour intérieure",img:IMAGES.mazagran,text:()=>`
<p>Des plantes grasses mordent des murs couleur gorge. Un conteneur sert d’atelier. Une porte basse mène à une cave poussiéreuse.</p>
<p>Sur l’établi : un <b>feuillet-mémoire</b> à moitié lisible. En bas de l’escalier, un <b>coffret anonyme</b>.</p>`,
 choices:[
  {label:"Lire le feuillet",hint:"NEU/Mnémographie (10) → indice vers Berges",test:{stat:'NEU',skill:'Mnémographie',dd:10,
    onSuccess:S=>{S.tags.add('Motif_R');addLog('Motif retourné → Berges.');addObjective('Indice décodé: passer par les darses.')},
    onFail:S=>{S.stress=Math.max(0,S.stress-1);addLog('Migraine douce. +1 Stress.')}
  }},
  {label:"Prendre le coffret",hint:"+ Objet Coffret (scellé)",immediate:S=>{S.inventory.push('Coffret scellé');addObjective('Coffret récupéré à Mazagran.')}} ,
  {label:"Descendre vers les Berges",go:'berges_entry'}
 ]},
 mazagran_noor:{title:"Mazagran — Le sac de Noor",img:IMAGES.mazagran,text:()=>`
<p>Le sac est coincé derrière un banc scellé. Ça sent la lessive vieille et le plastique mouillé.</p>
<p>Tu peux forcer, ou passer par la cave pour sortir derrière.</p>`,
 choices:[
  {label:"Forcer le banc",hint:"SOM/Mécanique (12) → + sac; échec +1 Blessure",test:{stat:'SOM',skill:'Mécanique',dd:12,
    onSuccess:S=>{S.tags.add('Noor_Sac');addLog('Le banc cède. Sac récupéré.');addObjective('Tu as récupéré le sac de Noor.')},
    onFail:S=>{S.hp=Math.max(0,S.hp-1);addLog('Écorchure profonde. +1 Blessure.')}
  }},
  {label:"Passer par la cave",hint:"CIN/Furtivité (10) → sortie discrète",test:{stat:'CIN',skill:'Furtivité',dd:10,
    onSuccess:S=>{S.tags.add('Sortie_Discrète');addLog('Tu sors derrière, personne ne te voit.')},
    onFail:S=>{addLog('Une lampe tombe. Bruit mou.')}
  }},
  {label:"Partir sans sac",go:'berges_entry'}
 ]},
 mazagran_milo:{title:"Mazagran — Le coffret de Milo",img:IMAGES.mazagran,text:()=>`
<p>Le coffret est là, sanglé. Sceau cassé — pas par toi. À l’intérieur: une carte fine et une note très sèche.</p>`,
 choices:[
  {label:"Prendre le coffret (scellé)",hint:"Utile au Pont",immediate:S=>{S.inventory.push('Coffret (pour Milo)');S.tags.add('Coffret_Milo');addObjective('Coffret pour Milo en poche.')}} ,
  {label:"Descendre vers les Berges",go:'berges_entry'}
 ]},
 berges_entry:{title:"Berges — Darses",img:IMAGES.berges,text:()=>`
<p>Le fleuve a l’air fatigué. La vase garde les secrets sous une peau mince. Une barge fantôme cogne une échelle.</p>
<p>Accès vers le <b>Pont</b> ou une <b>trappe technique</b>.</p>`,
 choices:[
  {label:"Prendre la trappe technique",hint:"NEU/Cryptanalyse (10) → accès T1 (bonus Noor)",test:{stat:'NEU',skill:'Cryptanalyse',dd:10,
    onSuccess:S=>{S.tags.add('Acces_Tech');S.miniRoute=(S.tags.has('Route_Noor')||S.tags.has('Noor_Sac'))?'noor':S.miniRoute;addObjective('Accès technique ouvert vers T1.')},
    onFail:S=>{addLog('Contact oxydé. À retenter.')}
  }},
  {label:"Remonter vers le Pont",hint:"Si Coffret_Milo → passe-droit",go:'pont_path'}
 ]},
 pont_path:{title:"Pont de la Guill’ — Passage",img:IMAGES.pont,text:()=>`
<p>Deux silhouettes contrôlent vaguement. Elles te regardent comme on regarde la pluie : sans envie.</p>
<p>${(STATE.tags && STATE.tags.has('Coffret_Milo'))?'<b>Le nom de Milo ouvre une brèche.</b>':'Sans passe, va falloir ruser.'}</p>`,
 choices:()=>{const arr=[];
  if(STATE.tags && STATE.tags.has('Coffret_Milo')){
    arr.push({label:"Passer sans histoire",hint:"C’est fluide",go:'t1_entry'});
  }else{
    arr.push({label:"Parler franc et sec",hint:"VOL/Intimidation (10) → laisser-passer",test:{stat:'VOL',skill:'Intimidation',dd:10,
      onSuccess:S=>{addLog('Ça passe. Personne n’a envie d’emmerdes.')},onFail:S=>{S.stress=Math.max(0,S.stress-1);addLog('Tension. +1 Stress.')}},
      go:'t1_entry'});
    arr.push({label:"Raser les barrières",hint:"CIN/Furtivité (12) → passer sans bruit",test:{stat:'CIN',skill:'Furtivité',dd:12,
      onSuccess:S=>{addLog('Tu glisses comme une ombre.')},onFail:S=>{S.stress=Math.max(0,S.stress-1);addLog('On te voit, tu forces, ça passe. +1 Stress.')}} ,
      go:'t1_entry'});
  } return arr;}
 },
 t1_entry:{title:"Sous-station T1 — Plans froissés",img:IMAGES.t1,text:()=>`
<p>Schémas scotchés au mur. Quelqu’un a noté : « la douceur est une technologie ».</p>
<p>La porte principale hésite. Plus loin, une grille basse retourne l’air chaud vers un tunnel.</p>`,
 choices:[
  {label:"Réessayer la porte",hint:"NEU/Cryptanalyse (12)",test:{stat:'NEU',skill:'Cryptanalyse',dd:12,
    onSuccess:S=>{S.tags.add('T1_Ouverte');addObjective('Porte T1 ouverte.')},onFail:S=>{S.stress=Math.max(0,S.stress-1);addLog('La note fausse se tait. +1 Stress.')}}
  },
  {label:"Passer par la grille",hint:"CIN/Furtivité (10)",test:{stat:'CIN',skill:'Furtivité',dd:10,
    onSuccess:S=>{S.tags.add('T1_Grille');addObjective('Tu t’infiltres par le bas.')},onFail:S=>{addLog('Une vis tinte. Tu t’arrêtes.')}}},
  {label:"Si Noor_Sac → elle t’ouvre de l’intérieur",when:()=>STATE.tags.has('Noor_Sac'),immediate:S=>{S.tags.add('Noor_Trust');addObjective('Noor te doit une. Porte entrouverte.')},go:'t1_core'}
 ]},
 t1_core:{title:"Sous-station T1 — Cœur",img:IMAGES.t1,text:()=>`
<p>Un bourdonnement bas. L’alimentation tient par un fil.</p>
<p>Le tableau principal affiche trois options bricolées : <b>Contournement</b>, <b>Relance</b>, <b>Trame douce</b>.</p>`,
 choices:[
  {label:"Contournement — gagner du temps",hint:"SOM/Mécanique (10) → +1 Flux",test:{stat:'SOM',skill:'Mécanique',dd:10,
    onSuccess:S=>{S.flux=Math.max(0,S.flux+1);addObjective('Contournement posé. La nuit tiendra.')},
    onFail:S=>{S.hp=Math.max(0,S.hp-1);addLog('Coup de jus. +1 Blessure.')}}
  },
  {label:"Relance — plus risqué",hint:"NEU/Déduction (12) → lumière plus vive",test:{stat:'NEU',skill:'Déduction',dd:12,
    onSuccess:S=>{S.tags.add('Relance');addObjective('Relance OK. Lumière vive dans la Guill’.')},
    onFail:S=>{S.stress=Math.max(0,S.stress-1);addLog('Tu recules. +1 Stress.')}}},
  {label:"Trame douce — protéger les souvenirs",hint:"VOL/Empathie (12) + ✦",test:{stat:'VOL',skill:'Empathie',dd:12,needsFrag:true,
    onSuccess:S=>{S.tags.add('Trame_Douce');S.frag=Math.max(0,S.frag-1);addObjective('Tu tires un voile. Les mémoires tiennent.')},
    onFail:S=>{addLog('Tu n’oses pas appuyer. Rien ne casse.')}}}
 ]}
};

/* ---------- RENDER ---------- */
function renderScene(){STATE.visited.add(STATE.scene);const sc=SCENES[STATE.scene];if(!sc)return;
 el('#storyTitle').textContent=sc.title;el('#storyText').innerHTML=sc.text?sc.text():'';
 const img=sc.img||IMAGES.place;el('#storyImg').src=img.src;el('#imgLegend').textContent=img.legend||'';
 const box=el('#choices');box.innerHTML='';let choices=typeof sc.choices==='function'?sc.choices():sc.choices;
 (choices||[]).forEach((c,i)=>{if(c.when&&!c.when())return;const d=document.createElement('div');d.className='choice';if(c.test&&c.test.stat)d.classList.add('attr-'+c.test.stat);
 const testTags=c.test?`<span class="tag ${attrColor(c.test.stat)}">${c.test.stat}</span><span class="tag">${c.test.skill||''}</span><span class="tag">DD ${c.test.dd}</span>`:'';
 d.innerHTML=`<strong>${i+1}. ${c.label||''}</strong><small>${c.hint||''}</small><div class="tags">${testTags}</div>`;
 d.addEventListener('click',()=>onChoice(c));box.appendChild(d)});
 renderAscii();updateBars();renderStats();el('#objectiveText').textContent=STATE.objective;}
let pendingTest=null;
function onChoice(c){if(c.immediate)c.immediate(STATE);if(c.go&&!c.test){STATE.scene=c.go;addObjective('Déplacement: '+SCENES[c.go].title);save();renderScene();return}
 if(c.test){pendingTest=c;showTest(c)}}
function showTest(c){el('#testPanel').style.display='block';el('#testName').textContent=`${c.test.stat}/${c.test.skill||'-'}`;el('#testDD').textContent=c.test.dd;
 el('#testHint').textContent=`Bonus dispos: Flux=${STATE.flux}  Frag=${STATE.frag}`+(c.test.needsFrag?' (nécessite 1 ✦)':'');
 ['useFlux','usePush','useFrag'].forEach(id=>el('#'+id).checked=false);el('#useFlux').disabled=STATE.flux<=0;el('#useFrag').disabled=c.test.needsFrag?STATE.frag<=0:STATE.frag<=0;
 el('#rollBtn').onclick=()=>startDice();}
let diceTimer=null,rollRes=null;
function startDice(){rollRes=null;el('#diceOverlay').style.display='flex';const d1=el('#d1'),d2=el('#d2');d1.classList.add('anim');d2.classList.add('anim');
 el('#diceInfo').textContent='...';clearTimeout(diceTimer);diceTimer=setTimeout(stopDice,STATE.reduceAnim?800:1700)}
function stopDice(){clearTimeout(diceTimer);const d1=el('#d1'),d2=el('#d2');d1.classList.remove('anim');d2.classList.remove('anim');
 const a=1+Math.floor(Math.random()*6),b=1+Math.floor(Math.random()*6);d1.textContent=a;d2.textContent=b;rollRes={a,b,sum:a+b};
 el('#diceInfo').textContent=`Résultat: ${a} + ${b} = ${a+b}`;setTimeout(()=>{el('#diceOverlay').style.display='none';applyRoll()},600)}
function applyRoll(){if(!pendingTest||!rollRes)return;const c=pendingTest;const useFlux=el('#useFlux').checked&&STATE.flux>0,usePush=el('#usePush').checked,useFrag=el('#useFrag').checked&&STATE.frag>0;
 let mod=(STATE.stats[c.test.stat]||0);if(STATE.skills&&((c.test.skill==='Furtivité'&&STATE.arch?.id==='noor')||(c.test.skill==='Intimidation'&&STATE.arch?.id==='milo')||(c.test.skill==='Mécanique'&&STATE.arch?.id==='rayan')||(STATE.skills[c.test.skill]>0)))mod+=1;
 if(useFlux){mod+=2;STATE.flux--} if(usePush){mod+=2} if(useFrag){mod+=2;STATE.frag--;STATE.stress=Math.max(0,STATE.stress-1);addLog('+1 Stress (Fragment)')}
 const total=rollRes.sum+mod,ok=total>=c.test.dd;STATE.lastRoll=`${c.test.stat}/${c.test.skill||'-'} DD${c.test.dd} — ${rollRes.a}+${rollRes.b}=${rollRes.sum} + ${mod} = ${total} → ${ok?'Réussite':'Échec'}`;
 addLog(STATE.lastRoll); ok?c.test.onSuccess&&c.test.onSuccess(STATE):(usePush&&(STATE.stress=Math.max(0,STATE.stress-1),addLog('+1 Stress (chance poussée, échec)')),c.test.onFail&&c.test.onFail(STATE));
 if(c.go){STATE.scene=c.go;addObjective('Déplacement: '+SCENES[c.go].title)} pendingTest=null;rollRes=null;el('#testPanel').style.display='none';save();renderScene()}
const SAVEKEY='trame_douce_v6_2';
function save(){localStorage.setItem(SAVEKEY,JSON.stringify({archId:STATE.arch?.id,stats:STATE.stats,skills:STATE.skills,stress:STATE.stress,hp:STATE.hp,flux:STATE.flux,frag:STATE.frag,
 tags:[...STATE.tags],inv:STATE.inventory,obj:STATE.objective,objJ:STATE.objectives,scene:STATE.scene,route:STATE.miniRoute,crude:STATE.crude,ascii:STATE.ascii,visited:[...STATE.visited]}))}
function load(){try{const s=JSON.parse(localStorage.getItem(SAVEKEY)||'null');if(!s)return;STATE.arch=ARCHETYPES.find(a=>a.id===s.archId)||null;if(STATE.arch){STATE.stats={...STATE.arch.stats};STATE.skills={...STATE.arch.skills}}
 Object.assign(STATE,{stress:s.stress??5,hp:s.hp??5,flux:s.flux??2,frag:s.frag??2});STATE.tags=new Set(s.tags||[]);STATE.inventory=s.inv||[];STATE.objective=s.obj||STATE.objective;STATE.objectives=s.objJ||[];
 STATE.scene=s.scene||'prologue';STATE.miniRoute=s.route||'';STATE.crude=!!s.crude;STATE.ascii=s.ascii!==false;STATE.visited=new Set(s.visited||[])}catch(e){}}
let selectedArch=null;
function openArchetypes(){document.getElementById('introModal').style.display='none';renderArcheModal();document.getElementById('archeModal').style.display='flex'}
function renderArcheModal(){const L=el('#archList');L.innerHTML='';ARCHETYPES.forEach(a=>{const card=document.createElement('div');card.className='arch';card.setAttribute('tabindex','0');
 card.innerHTML=`<img src="${a.img}" alt="${a.name}"><div class="pad"><h3>${a.name}</h3><p style="color:var(--mut)">${a.back}</p>
 <div class="row" style="margin-top:6px"><span class="badge">NEU ${a.stats.NEU}</span><span class="badge">VOL ${a.stats.VOL}</span><span class="badge">SOM ${a.stats.SOM}</span><span class="badge">CIN ${a.stats.CIN}</span></div>
 <div class="row" style="margin-top:6px"><span class="badge">${a.atout}</span></div></div>`;card.onclick=()=>selectArch(a,card);L.appendChild(card)})}
function selectArch(a,card){selectedArch=a;document.querySelectorAll('.arch').forEach(x=>x.setAttribute('aria-selected','false'));card.setAttribute('aria-selected','true');el('#confirmArch').disabled=false}
function randomArch(){if(!document.querySelectorAll('.arch').length)renderArcheModal();const i=Math.floor(Math.random()*ARCHETYPES.length);selectArch(ARCHETYPES[i],document.querySelectorAll('.arch')[i])}
function commitArch(){STATE.arch=selectedArch;STATE.stats={...selectedArch.stats};STATE.skills={...selectedArch.skills};STATE.inventory=[...selectedArch.startInv];addObjective('Archétype: '+selectedArch.name);
 document.getElementById('archeModal').style.display='none';save();renderScene()}
function exportSave(){const blob=new Blob([localStorage.getItem(SAVEKEY)||'{}'],{type:'application/json'});const u=URL.createObjectURL(blob);const a=document.createElement('a');a.href=u;a.download='trame_douce_v6_2_save.json';a.click();URL.revokeObjectURL(u)}
function importSave(){const i=document.createElement('input');i.type='file';i.accept='application/json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{localStorage.setItem(SAVEKEY,r.result);load();renderScene()};r.readAsText(f)};i.click()}
load();renderStats();renderAscii();renderTimeline();renderScene();document.getElementById('confirmArch').onclick=commitArch;
if(!STATE.arch){document.getElementById('introModal').style.display='flex'}
</script>
</body>
</html>
