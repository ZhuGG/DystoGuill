<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TRAME DOUCE — Guillotière (v6.4)</title>
<style>
:root{
  --bg:#0b0e15; --p:#12182a; --p2:#0e1423; --ink:#eaf2ff; --mut:#9fb1cf; --line:#1a2438;
  --a:#9cf6ff; --b:#ffc2e9; --warn:#ffbd73; --bad:#ff6b7a; --good:#78f2bb;
  --neu:#6ad0ff; --vol:#ff78a8; --som:#ffc76e; --cin:#92ffcc; --sh:0 8px 28px rgba(0,0,0,.35);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
a{color:var(--a)}
.header{position:sticky;top:0;z-index:20;display:flex;flex-direction:column;gap:12px;padding:calc(10px + env(safe-area-inset-top,0px)) 12px 10px;border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,rgba(15,20,34,.92),rgba(15,20,34,.65));backdrop-filter:blur(8px)}
.headerTop{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.header .row{display:flex;gap:8px;flex-wrap:wrap}
.header .title{font-weight:800;letter-spacing:.5px;flex:1}
.headerControls{display:flex;align-items:center;gap:8px;margin-left:auto}
.headerBadges{gap:8px;flex-wrap:wrap;width:100%}
.viewBadge{background:rgba(255,255,255,.04);border-style:dashed;color:var(--ink);font-weight:600}
.btn.ghost{background:rgba(13,20,33,.6);border-style:dashed;color:var(--ink)}
.iconBtn{padding:0 12px;height:38px;border:1px solid #2a3a58;background:linear-gradient(180deg,#161f31,#0f1624);border-radius:12px;color:var(--ink);font-size:20px;cursor:pointer;display:grid;place-items:center;font-weight:700;min-width:38px}
.menuWrap{position:relative}
.menuWrap.open .iconBtn{outline:2px solid var(--a)}
.navMenu{display:none;position:absolute;right:0;top:calc(100% + 8px);background:var(--p2);border:1px solid var(--line);border-radius:12px;padding:8px;min-width:180px;box-shadow:var(--sh);flex-direction:column;gap:6px}
.menuWrap.open .navMenu{display:flex}
.navMenu .tabbtn{width:100%;text-align:left}
.tabbtn,.btn{padding:10px 12px;border:1px solid #2a3a58;background:linear-gradient(180deg,#141f33,#223355);border-radius:12px;color:var(--ink);cursor:pointer;font-weight:700}
.tabbtn[aria-pressed="true"],.btn.primary{outline:2px solid var(--a)}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3a58;background:var(--p2);color:var(--mut);padding:2px 8px;border-radius:999px;font-size:12px}
.icon{width:16px;height:16px;opacity:.9}
.grid{display:grid;gap:12px;grid-template-columns:300px 1fr 340px;max-width:1280px;margin:auto;padding:12px}
.col{background:var(--p);border:1px solid var(--line);border-radius:14px;box-shadow:var(--sh);overflow:hidden}
.pad{padding:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.sectionTitle{color:var(--mut);font-size:12px;text-transform:uppercase;margin:0 0 6px}
/* left */
.stat{display:grid;grid-template-columns:24px 1fr 24px;align-items:center;background:var(--p2);border:1px solid var(--line);border-radius:10px;padding:6px;min-width:120px}
.stat .dot{width:16px;height:16px;border-radius:5px} .stat .name{font-size:11px;color:var(--mut);text-transform:uppercase} .stat .val{font-weight:800;text-align:right}
.neu .dot{background:var(--neu)} .neu .val{color:var(--neu)} .vol .dot{background:var(--vol)} .vol .val{color:var(--vol)} .som .dot{background:var(--som)} .som .val{color:var(--som)} .cin .dot{background:var(--cin)} .cin .val{color:var(--cin)}
.resbar{display:flex;gap:8px}.res{flex:1;background:var(--p2);border:1px solid var(--line);border-radius:10px;overflow:hidden}
.res .lbl{font-size:12px;color:var(--mut);padding:6px 8px;border-bottom:1px solid var(--line)} .meter{height:6px;background:var(--line)}
.fill{height:6px;background:linear-gradient(90deg,var(--a),var(--b))} .fill.bad{background:linear-gradient(90deg,var(--bad),var(--warn))}
.ascii{font-family:Consolas,Menlo,monospace;font-size:12px;background:#0b0f15;border:1px solid var(--line);border-radius:12px;padding:10px;white-space:pre-wrap;color:#b9c7da}
/* story */
.storyImage{position:relative;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#0a0e13}
.storyImage img{width:100%;height:240px;object-fit:cover;filter:contrast(1.05) saturate(1.1) brightness(.88)}
@media (max-width: 900px){
  .storyImage img{height:200px}
  .header{position:sticky;gap:12px}
  .header .title{font-size:18px}
  .headerTop{align-items:flex-start}
  .headerControls{margin-left:0;width:100%;justify-content:flex-start;flex-wrap:wrap}
  .headerControls .btn,.headerControls .iconBtn{width:auto}
  .headerBadges{width:100%;justify-content:flex-start}
}
.storyImage .legend{position:absolute;left:10px;bottom:10px;background:rgba(10,14,19,.7);padding:6px 8px;border-radius:8px;border:1px solid var(--line);color:var(--mut);font-size:12px}
.storyBody{background:var(--p2);border:1px solid var(--line);border-radius:14px;padding:14px}
.choices{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.choice{position:relative;border:1px solid #2a3a58;background:linear-gradient(180deg,#151e31,#233355);padding:12px;border-radius:12px;cursor:pointer;transition:transform .15s ease,outline .15s ease}
.choice:hover,.choice:focus-visible{outline:2px solid var(--a)} .choice small{display:block;color:var(--mut)}
.choice:active{transform:translateY(1px)}
.choice .tags{position:absolute;right:8px;top:8px;display:flex;gap:6px;flex-wrap:wrap}
.tag{padding:2px 6px;border-radius:999px;border:1px solid var(--line);font-size:11px;background:rgba(255,255,255,.03)}
.attr-NEU{border-left:4px solid var(--neu)} .attr-VOL{border-left:4px solid var(--vol)} .attr-SOM{border-left:4px solid var(--som)} .attr-CIN{border-left:4px solid var(--cin)}
/* tests */
.testPanel{margin-top:12px;border:1px dashed #2a3a58;border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.02)}
.testControls label{flex:1 1 160px}
.testResult{display:none;margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-weight:700}
.testResult.show{display:block}
.testResult.success{border-color:var(--good);color:var(--good)}
.testResult.fail{border-color:var(--bad);color:var(--bad)}
.btn{padding:10px 12px;border:1px solid #2a3a58;background:linear-gradient(180deg,#151e31,#233355);border-radius:12px;color:var(--ink);cursor:pointer}
.btn[disabled]{opacity:.4;cursor:not-allowed}
/* right */
.log{height:360px;overflow:auto;background:var(--p2);border:1px solid var(--line);border-radius:12px;padding:8px}
.log .line{padding:6px 0;border-bottom:1px dashed var(--line);font-size:13px}
.timeline{height:160px;overflow:auto;background:var(--p2);border:1px solid var(--line);border-radius:12px;padding:8px}
.timeline .item{margin:4px 0;padding:8px;border-left:3px solid var(--b);background:rgba(255,255,255,.02);border-radius:8px}
.timeline .when{color:var(--mut);font-size:12px}
/* dice */
#diceOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:40}
.diceWrap{background:var(--p);border:1px solid var(--line);border-radius:14px;padding:16px;min-width:300px;text-align:center}
.cubes{display:flex;gap:16px;justify-content:center;margin:10px 0 4px 0}
.cube{width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg,#1b2330,#0b1017);border:1px solid #273243;display:grid;place-items:center;font-size:40px;color:#fff}
.diceActions{gap:10px;margin-top:12px;justify-content:center;flex-wrap:wrap}
.diceActions .btn{min-width:120px}
#diceInfo{margin-top:10px;color:var(--mut);line-height:1.5}
.diceSummary{font-weight:600;color:var(--ink)}
.diceBreakdown{margin-top:6px;font-size:13px;color:var(--mut)}
.diceStatus{margin-top:8px;font-weight:700}
.diceStatus.success{color:var(--good)}
.diceStatus.fail{color:var(--bad)}
@media (prefers-reduced-motion: reduce){ .cube{animation:none!important} }
.anim{animation:roll 1s ease-in-out infinite}
@keyframes roll{0%{transform:rotate(0)}33%{transform:rotate(12deg)}66%{transform:rotate(-9deg)}100%{transform:rotate(0)}}
/* modals */
.modalScreen{position:fixed;inset:0;background:rgba(10,14,19,.88);display:flex;align-items:center;justify-content:center;z-index:50;padding:24px;overflow-y:auto}
.modalBox{background:var(--p);border:1px solid var(--line);padding:16px;border-radius:16px;max-width:1000px;width:95%;max-height:calc(100vh - 48px);overflow:auto;box-shadow:var(--sh)}
.modalBox h2{margin:0 0 8px 0}
.arches{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.arch{border:2px solid #2a3a58;background:linear-gradient(180deg,#141a23,#0e141c);border-radius:14px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column;transition:transform .2s ease,outline .2s ease}
.arch:active{transform:translateY(1px)}
.arch img{width:100%;height:140px;object-fit:cover}
.arch .pad{padding:10px}
.arch h3{margin:0 0 6px 0}
.arch p{margin:.4em 0;color:var(--mut);font-size:13px}
.arch .statrow{display:flex;gap:6px;padding:0 10px 10px 10px}
.arch .b{border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px}
.arch[aria-selected="true"]{outline:3px solid var(--a)}
/* tabs visibility */
[data-view="story"] .left,[data-view="story"] .right{display:none}
[data-view="profile"] .mid,[data-view="profile"] .right{display:none}
[data-view="journal"] .left,[data-view="journal"] .mid{display:none}
/* mobile: single column + bottom nav */
@media (max-width: 900px){
  body{font-size:15px}
  .grid{grid-template-columns:1fr; padding-bottom: calc(64px + var(--safe-bottom));}
  .log{height:220px}.timeline{height:160px}
  .mobilebar{display:flex}
  .col{border-radius:12px}
  .pad{padding:14px}
  .badge{font-size:11px;padding:4px 8px}
  .tabbtn,.btn{width:100%}
}
.choice .tags{pointer-events:none}
.choice strong{display:block}
@media (max-width: 600px){
  body{font-size:14px}
  .header{padding:12px 10px;gap:10px}
  .header .title{font-size:16px;line-height:1.25}
  .headerTop{gap:8px}
  .headerControls{gap:6px}
  .headerBadges{gap:6px}
  .viewBadge{font-size:10px}
  .badge{font-size:10px}
  .tabbtn,.btn{font-size:14px;padding:10px}
  .storyImage img{height:170px}
  .storyBody{padding:12px}
  .choices{gap:12px}
  .choice{padding:14px}
  .choice strong{font-size:15px}
  .choice small{font-size:12px}
  .choice .tags{position:static;margin-top:8px;justify-content:flex-start}
  .modalScreen{padding:16px 12px;align-items:flex-start;overflow-y:auto}
  .modalBox{width:100%;max-width:480px;max-height:calc(100vh - 32px);overflow:auto}
  .arches{grid-template-columns:1fr;gap:12px}
  .arch{flex-direction:row;align-items:center}
  .arch img{width:96px;height:96px}
  .arch .pad{padding:12px;flex:1}
  .arch h3{font-size:16px}
  .arch p{font-size:12px}
  .arch .statrow{flex-wrap:wrap;gap:6px}
  .arch .b{font-size:11px;padding:3px 6px}
  .mobilebar{gap:6px}
}
.mobilebar{display:none; position:fixed; left:0; right:0; bottom:0; z-index:30;
  padding:8px 10px calc(8px + var(--safe-bottom)); gap:8px; justify-content:space-around;
  background:linear-gradient(180deg,rgba(10,14,22,.1),rgba(10,14,22,.9)); backdrop-filter: blur(8px); border-top:1px solid var(--line);}
.mobilebar .tabbtn{flex:1; text-align:center}
</style>
</head>
<body data-view="all">
<header class="header">
  <div class="headerTop">
    <div class="title">⟡ TRAME DOUCE — <span id="loc">Guillotière</span></div>
    <div class="headerControls">
      <span class="badge viewBadge" id="viewIndicator">Vue : Tous</span>
      <button class="btn ghost" id="asciiBtn">HUD ASCII ✓</button>
      <div class="menuWrap" id="navWrap">
        <button class="iconBtn" id="navToggle" aria-haspopup="true" aria-expanded="false" aria-label="Changer de vue">⋯</button>
        <div class="navMenu" id="navMenu" role="menu">
          <button class="tabbtn" data-viewto="all" aria-pressed="true" role="menuitem">Tous</button>
          <button class="tabbtn" data-viewto="story" role="menuitem">Histoire</button>
          <button class="tabbtn" data-viewto="profile" role="menuitem">Profil</button>
          <button class="tabbtn" data-viewto="journal" role="menuitem">Journal</button>
        </div>
      </div>
    </div>
  </div>
  <div class="row headerBadges">
    <span class="badge"><img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Heart_coraz%C3%B3n.svg/32px-Heart_coraz%C3%B3n.svg.png"> Stress <span id="stressVal">2</span>/5</span>
    <span class="badge"><img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8b/OOjs_UI_icon_firstaid-ltr.svg/32px-OOjs_UI_icon_firstaid-ltr.svg.png"> Blessures <span id="hpVal">5</span>/5</span>
    <span class="badge"><img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Circle-icons-bulb.svg/32px-Circle-icons-bulb.svg.png"> Flux ◆ <span id="fluxVal">2</span></span>
    <span class="badge"><img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/42/Noun_Project_document_icon_1409169_cc.svg/32px-Noun_Project_document_icon_1409169_cc.svg.png"> Fragments ✦ <span id="fragVal">2</span></span>
  </div>
</header>

<main class="grid">
  <aside class="col left">
    <div class="pad">
      <div class="sectionTitle">Profil</div>
      <div class="row" id="statsRow"></div>
      <div style="height:8px"></div>
      <div class="resbar">
        <div class="res"><div class="lbl">Stress</div><div class="meter"><div class="fill bad" id="stressFill" style="width:40%"></div></div></div>
        <div class="res"><div class="lbl">Blessures</div><div class="meter"><div class="fill bad" id="hpFill" style="width:100%"></div></div></div>
      </div>
      <div style="height:8px"></div>
      <div class="sectionTitle">Mini-carte</div>
      <div class="ascii" id="miniMap"></div>
      <div style="height:8px"></div>
      <div class="sectionTitle">Sauvegarde</div>
      <div class="row">
        <button class="btn" id="btnExport">Exporter</button>
        <button class="btn" id="btnImport">Importer</button>
      </div>
    </div>
    <div class="pad">
      <div class="sectionTitle">HUD ASCII</div>
      <div class="ascii" id="asciiHud"></div>
    </div>
  </aside>

  <section class="col mid">
    <div class="pad">
      <div class="storyImage">
        <img id="storyImg" loading="lazy" src="https://cdn.midjourney.com/2dad9bcd-090b-477d-915d-6fc46c5cc0ad/0_1.png" alt="">
        <div class="legend" id="imgLegend">Guillotière — pluie sous la Sourdine</div>
      </div>
      <div class="row"><span class="badge">Objectif: <span id="objectiveText">Tracer une voie sûre vers T1.</span></span></div>
      <div class="storyBody">
        <h2 id="storyTitle">Prologue</h2>
        <div id="storyText"></div>
        <div class="choices" id="choices"></div>
        <div class="testPanel" id="testPanel" style="display:none">
          <div class="row">
            <span class="badge">Test: <span id="testName">—</span></span>
            <span class="badge">DD <span id="testDD">10</span></span>
            <div style="margin-left:auto"></div>
          </div>
          <div class="row testControls" style="align-items:center;margin-top:6px">
            <label class="badge"><input type="checkbox" id="useFlux"> +2 Flux</label>
            <label class="badge"><input type="checkbox" id="usePush"> +2 Pousser sa chance</label>
            <label class="badge"><input type="checkbox" id="useFrag"> ✦ Fragment (indice fort, +1 Stress)</label>
            <button class="btn primary" id="rollBtn">Lancer les dés</button>
          </div>
          <div class="small" id="testHint"></div>
          <div class="testResult" id="testResult" role="status" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </section>

  <aside class="col right">
    <div class="pad">
      <div class="sectionTitle">Journal des dés</div>
      <div class="log" id="log"></div>
      <div style="height:8px"></div>
      <div class="sectionTitle">Journal d’objectifs</div>
      <div class="timeline" id="timeline"></div>
    </div>
  </aside>
</main>

<!-- Mobile bottom bar -->
<nav class="mobilebar">
  <button class="tabbtn" data-viewto="story">Histoire</button>
  <button class="tabbtn" data-viewto="profile">Profil</button>
  <button class="tabbtn" data-viewto="journal">Journal</button>
  <button class="tabbtn" data-viewto="all">Tous</button>
</nav>

<!-- Dice overlay -->
<div id="diceOverlay"><div class="diceWrap">
  <div>2d6 — maintien = animation</div>
  <div class="cubes"><div class="cube anim" id="d1">•</div><div class="cube anim" id="d2">•</div></div>
  <div class="row diceActions" style="justify-content:center">
    <button class="btn primary" id="btnStopDice">Arrêter</button>
    <button class="btn" id="btnResolveDice" style="display:none">Continuer</button>
  </div>
  <div id="diceInfo" class="small" aria-live="polite"></div>
</div></div>

<!-- Intro -->
<div id="introModal" class="modalScreen">
  <div class="modalBox" style="max-width:900px">
    <h2>TRAME DOUCE — Présentation</h2>
    <p style="color:var(--mut)">La Guillotière vit sous <i>la Sourdine</i>, un bourdonnement qui étouffe voix et souvenirs. La sous-station <b>T1</b> décroche : si elle cède, le quartier perdra la lumière.</p>
    <p style="color:var(--mut)">Choisis ton archétype, négocie avec le quartier et trace un chemin fiable jusqu’à T1. Chaque service rendu ouvre une route, chaque refus en ferme une autre.</p>
    <div class="row" style="justify-content:flex-end"><button class="btn primary" id="btnChooseArch">Choisir un archétype</button></div>
  </div>
</div>

<!-- Archetypes -->
<div id="archModal" class="modalScreen" style="display:none">
  <div class="modalBox">
    <h2>Choisis ton archétype</h2>
    <div class="arches" id="archList"></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="btnRandom">Au hasard</button>
      <button class="btn primary" id="btnConfirm" disabled>Valider</button>
    </div>
  </div>
</div>

<script>
/* ======= DATA ======= */
const ARCH=[
 {id:'noor',name:'Noor — Dormeuse du pont',img:'https://cdn.midjourney.com/a3b1416e-ee0e-4c20-930a-7ffd8a11813f/0_0.png',
  back:'Tu dors sous le tablier quand il fait doux. Tu sais écouter quand les autres parlent trop.',
  stats:{NEU:2,VOL:3,SOM:1,CIN:3},skills:{Furtivité:1,Empathie:1},start:['Feuillet-mica','Cutter','Gants usés']},
 {id:'milo',name:'Milo — Revendeur d’appoint',img:'https://cdn.midjourney.com/80762336-8ec1-4cc1-8c37-7c4107864bab/0_2.png',
  back:'Piles refondues, médocs, rumeurs. Tu parles cash et sens la merde à quinze mètres.',
  stats:{NEU:3,VOL:3,SOM:1,CIN:2},skills:{Intimidation:1,Déduction:1},start:['Lampe plate','Note marquée','Briquet']},
 {id:'rayan',name:'Rayan — Électricien clandestin',img:'https://cdn.midjourney.com/0e627014-f83a-41bd-9c3f-e4d828a9e555/0_3.png',
  back:'Tu connais les coffrets et les gaines qui chantent. Tu parles au cuivre comme à un gosse têtu.',
  stats:{NEU:3,VOL:2,SOM:3,CIN:2},skills:{Mécanique:1,Cryptanalyse:1},start:['Tournevis isolé','Aimant-alu','Ruban textile']}
];
const IMG={pro:{src:'https://cdn.midjourney.com/56285542-dbca-4ce6-b483-253548e35fd2/0_3.png',lg:'Souterrain — goutte à goutte'},
 place:{src:'https://cdn.midjourney.com/eaaf9643-3d4c-44b1-9ed1-7c243133a5c5/0_0.png',lg:'Place du Pont — pluie sur bitume'},
 maz:{src:'https://cdn.midjourney.com/b418e0bc-0e86-496e-a2d8-0eb310dbe984/0_0.png',lg:'Friche Mazagran — murs qui boivent'},
 ber:{src:'https://cdn.midjourney.com/9422d8a5-60dd-441f-9007-32d0dc57f3a5/0_0.png',lg:'Berges — darses envasées'},
 pon:{src:'https://cdn.midjourney.com/bb9836dc-9370-41d6-9df7-08fc0f2a9a78/0_2.png',lg:'Pont de la Guill’ — courant bas'},
 t1:{src:'https://cdn.midjourney.com/d62c2fce-31b6-4c23-8437-2d27d6a9eab8/0_1.png',lg:'Sous-station T1 — panneaux griffés'}
};
const ST={arch:null,stats:{NEU:2,VOL:2,SOM:2,CIN:2},skills:{},stress:2,hp:5,flux:2,frag:2,
 inv:[],tags:new Set(),scene:'prologue',objective:'Tracer une voie sûre vers T1.',objLog:[],visited:new Set(),ascii:true};
const SAVE='td_v6_4';

/* ======= HELPERS ======= */
const VIEW_LABELS={all:'Tous',story:'Histoire',profile:'Profil',journal:'Journal'};
const $=q=>document.querySelector(q);
const navWrap=document.getElementById('navWrap');
const navToggle=document.getElementById('navToggle');
const navMenu=document.getElementById('navMenu');

function updateViewIndicator(v){const badge=$('#viewIndicator'); if(badge){badge.textContent='Vue : '+(VIEW_LABELS[v]||'Tous');}}
function openNavMenu(){if(!navWrap)return;navWrap.classList.add('open');if(navToggle)navToggle.setAttribute('aria-expanded','true');}
function closeNavMenu(){if(!navWrap)return;navWrap.classList.remove('open');if(navToggle)navToggle.setAttribute('aria-expanded','false');}
function toggleNavMenu(){if(navWrap?.classList.contains('open')){closeNavMenu();}else{openNavMenu();}}
updateViewIndicator(document.body.getAttribute('data-view')||'all');
if(navToggle){navToggle.addEventListener('click',e=>{e.stopPropagation();toggleNavMenu();});}
document.addEventListener('click',e=>{if(navWrap&&!navWrap.contains(e.target)){closeNavMenu();}});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeNavMenu();}});
function log(t){const L=$('#log');const d=document.createElement('div');d.className='line';d.textContent=t;L.prepend(d)}
function addObj(t){ST.objLog.push({t:Date.now(),text:t}); renderTimeline() }
function setView(v){
  document.body.setAttribute('data-view',v);
  document.querySelectorAll('[data-viewto]').forEach(b=>b.setAttribute('aria-pressed', b.getAttribute('data-viewto')===v ? 'true' : 'false'));
  updateViewIndicator(v);
}
function setupNav(){
  document.querySelectorAll('[data-viewto]').forEach(b=>{
    b.addEventListener('click', e=>{ setView(b.getAttribute('data-viewto')); closeNavMenu(); });
  });
}
$('#asciiBtn').addEventListener('click',()=>{ST.ascii=!ST.ascii;renderAscii();$('#asciiBtn').textContent='HUD ASCII '+(ST.ascii?'✓':'✗')});
function bars(){ $('#stressVal').textContent=ST.stress; $('#hpVal').textContent=ST.hp; $('#fluxVal').textContent=ST.flux; $('#fragVal').textContent=ST.frag;
  $('#stressFill').style.width=(ST.stress/5*100)+'%'; $('#hpFill').style.width=(ST.hp/5*100)+'%'; }
function renderStats(){const r=$('#statsRow');r.innerHTML='';const s=ST.stats;
  const mk=(cls,nm,v)=>`<div class="stat ${cls}"><div class="dot"></div><div class="name">${nm}</div><div class="val">${v}</div></div>`;
  r.insertAdjacentHTML('beforeend',mk('neu','Neuro',s.NEU)); r.insertAdjacentHTML('beforeend',mk('vol','Volonté',s.VOL));
  r.insertAdjacentHTML('beforeend',mk('som','Somatique',s.SOM)); r.insertAdjacentHTML('beforeend',mk('cin','Cinétique',s.CIN)); }
function renderAscii(){ if(!ST.ascii){$('#asciiHud').textContent='(désactivé)'; $('#miniMap').textContent='(désactivé)'; return;}
  $('#asciiHud').textContent=`╔══[ ATH ]══════════════════════════════════════╗
║ ${ST.arch?ST.arch.name:'—'}
║ NEU ${ST.stats.NEU} VOL ${ST.stats.VOL} SOM ${ST.stats.SOM} CIN ${ST.stats.CIN}
║ Stress ${'█'.repeat(ST.stress)}${'░'.repeat(5-ST.stress)}  Bless ${'█'.repeat(ST.hp)}${'░'.repeat(5-ST.hp)}
║ Flux ◆${ST.flux}  Frag ✦${ST.frag}
║ Inv: ${ST.inv.join(' • ')||'—'}
║ Scène: ${ST.scene}  Tags: ${[...ST.tags].join(', ')||'—'}
╚════════════════════════════════════════════════╝`; renderMiniMap(); }
function renderMiniMap(){const v=s=>ST.visited.has(s)?'●':'○';
 $('#miniMap').textContent=`[Guillotière]
  ${v('prologue')} Prologue ─ ${v('place')} Place ─ ${v('maz')} Mazagran ─ ${v('ber')} Berges ─ ${v('pon')} Pont ─ ${v('t1')} T1`; }
function renderTimeline(){const T=$('#timeline');T.innerHTML='';ST.objLog.slice().reverse().forEach(o=>{const d=document.createElement('div');d.className='item';d.innerHTML=`<div>${o.text}</div><div class="when">${new Date(o.t).toLocaleTimeString()}</div>`;T.appendChild(d)})}
function save(){localStorage.setItem(SAVE,JSON.stringify({a:ST.arch?.id,s:ST.stats,k:ST.skills,st:ST.stress,h:ST.hp,f:ST.flux,g:ST.frag,i:ST.inv,t:[...ST.tags],sc:ST.scene,o:ST.objective,ol:ST.objLog,v:[...ST.visited],as:ST.ascii}))}
function load(){try{const d=JSON.parse(localStorage.getItem(SAVE)||'null');if(!d)return;ST.arch=ARCH.find(x=>x.id===d.a)||null; if(ST.arch){ST.stats={...ST.arch.stats};ST.skills={...ST.arch.skills};ST.inv=[...ST.arch.start]}
  Object.assign(ST,{stress:d.st??2,hp:d.h??5,flux:d.f??2,frag:d.g??2});ST.inv=d.i||ST.inv;ST.tags=new Set(d.t||[]);ST.scene=d.sc||'prologue';ST.objective=d.o||ST.objective;ST.objLog=d.ol||[];ST.visited=new Set(d.v||[]);ST.ascii=d.as!==false}catch(e){}}
/* exporter/importer */
$('#btnExport').addEventListener('click',()=>{const blob=new Blob([localStorage.getItem(SAVE)||'{}'],{type:'application/json'});const u=URL.createObjectURL(blob);const a=document.createElement('a');a.href=u;a.download='trame_douce_v6_4_save.json';a.click();URL.revokeObjectURL(u)});
$('#btnImport').addEventListener('click',()=>{const i=document.createElement('input');i.type='file';i.accept='application/json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{localStorage.setItem(SAVE,r.result);load();render()};r.readAsText(f)};i.click()});

/* ======= SCENES ======= */
const SC={
 prologue:{
  img:IMG.pro,title:'Prologue — La Sourdine',text:()=>`
  <p>La pluie plaque les enseignes de la Place du Pont. Sous <b>la Sourdine</b>, les voix deviennent feutrées et les souvenirs glissent. La sous-station <b>T1</b> décroche : si elle lâche, la Guill’ s’assombrit.</p>
  <p>Il te faut un itinéraire sûr. <i>Noor</i> connaît les caves, <i>Milo</i> négocie avec les guetteurs, ou tu peux lire seul·e le courant de la foule.</p>`,
  choices:[
    {label:'Retrouver Noor, la dormeuse du pont',hint:'Guide discret vers les Berges (furtivité)',go:'place_noor'},
    {label:'Marcher vers Milo, le revendeur',hint:'Passe-droit potentiel au Pont',go:'place_milo'},
    {label:'Observer la foule par toi-même',hint:'Tracer une route sans allié',go:'place_solo'}
  ]
 },
 place_noor:{
 img:IMG.place,title:'Place du Pont — Noor',text:()=>`
  <p>Noor s’abrite sous une bâche plastique. Regard calme mais précis. Elle connaît les caves qui mènent aux <b>Berges</b>.</p>
  <p>Elle ouvrira la voie si tu récupères <b>son sac</b> oublié à <b>Mazagran</b>.</p>`,
  choices:[
    {label:'Accepter et récupérer son sac',hint:'Nouvel objectif : ramener le sac de Noor',immediate:s=>{s.tags.add('Noor');s.objective='Ramener le sac de Noor pour ouvrir la voie des caves.';addObj('Nouvel objectif : rapporter le sac de Noor.');},go:'maz_noor'},
    {label:'Refuser mais prendre son indice',hint:'Indice de trappe sans accompagnement',immediate:s=>{s.tags.add('Indice_Trappe');s.objective='Trouver la trappe technique indiquée par Noor.';addObj('Indice obtenu : emplacement de la trappe.');},go:'maz_common'}
  ]
 },
 place_milo:{
 img:IMG.place,title:'Place du Pont — Milo',text:()=>`
  <p>Milo recompte des câbles sous un parapluie troué. Il peut obtenir un laissez-passer au <b>Pont</b> si tu récupères un <b>coffret</b> caché à <b>Mazagran</b>.</p>
  <p>Le deal est clair : tu rapportes le coffret, il parle aux guetteurs.</p>`,
  choices:[
    {label:'Accepter le deal du coffret',hint:'Passe-droit à gagner si tu réussis',immediate:s=>{s.tags.add('Milo');s.objective='Ramener le coffret scellé à Milo pour obtenir le passe.';addObj('Nouvel objectif : récupérer le coffret de Milo.');},go:'maz_milo'},
    {label:'Refuser et rester indépendant·e',hint:'Route neutre vers Mazagran',immediate:s=>{s.objective='Chercher un passage neutre par Mazagran.';},go:'maz_common'}
  ]
 },
 place_solo:{
 img:IMG.place,title:'Place du Pont — Lire la foule',text:()=>`
  <p>Tu te laisses porter par la foule. La pluie trace des courants sur le bitume. Tout converge vers <b>Mazagran</b> avant de glisser vers les <b>Berges</b>.</p>
  <p>Reste à décider si tu suis le courant ou si tu forces un passage direct.</p>`,
  choices:[
    {label:'Suivre le flux jusqu’à Mazagran',hint:'Collecter des indices avant les Berges',go:'maz_common'},
    {label:'Forcer un passage vers les Berges',hint:'Contourner la friche sans aide',go:'ber_entry'}
  ]
 },
 maz_common:{
 img:IMG.maz,title:'Friche Mazagran — Cour',text:()=>`
  <p>Le conteneur-atelier bourdonne. Une échelle plonge vers la cave. Sur l’établi : un <b>feuillet-mémoire</b> annoté. En bas, un <b>coffret scellé</b> attend dans l’ombre.</p>`,
  choices:[
    {label:'Lire le feuillet annoté',hint:'NEU/Mnémographie (10) — repérer la trappe',test:{stat:'NEU',skill:'Mnémographie',dd:10,
      ok:s=>{s.tags.add('Motif_R');s.objective='Atteindre la trappe technique depuis les Berges.';addObj('Indice : localisation de la trappe technique vers T1.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Le motif te vrille. +1 Stress.')}}},
    {label:'Saisir le coffret scellé',hint:'Ajouter l’objet à ton inventaire',immediate:s=>{s.inv.push('Coffret scellé');s.objective='Transporter le coffret sans attirer l’attention.';addObj('Coffret scellé rangé dans ton sac.');}},
    {label:'Descendre vers les Berges',hint:'Prendre la cave jusqu’aux darses',go:'ber_entry'}
  ]
 },
 maz_noor:{
 img:IMG.maz,title:'Mazagran — Le sac de Noor',text:()=>`
  <p>Le sac de Noor est coincé derrière un banc soudé. L’eau goutte des bâches avec un rythme patient.</p>
  <p>Tu peux forcer le métal ou descendre par la cave pour ressortir discrètement.</p>`,
  choices:[
    {label:'Forcer le banc',hint:'SOM/Mécanique (12) — libérer le sac (échec : +1 Blessure)',test:{stat:'SOM',skill:'Mécanique',dd:12,
      ok:s=>{s.tags.add('Noor_Sac');s.objective='Ramener le sac à Noor sur la Place du Pont.';addObj('Sac de Noor récupéré.');},ko:s=>{s.hp=Math.max(0,s.hp-1);log('Tu t’écorches sur le métal. +1 Blessure.')}}},
    {label:'Passer par la cave',hint:'CIN/Furtivité (10) — ressortir sans alerter',test:{stat:'CIN',skill:'Furtivité',dd:10,
      ok:s=>{s.tags.add('Sortie_Discrète');log('Personne ne t’a vu.');},ko:s=>{log('Lampe qui claque. Pas de dégâts.')}}},
    {label:'Filer aux Berges',hint:'Rejoindre les darses sans perdre de temps',go:'ber_entry'}
  ]
 },
 maz_milo:{
 img:IMG.maz,title:'Mazagran — Le coffret de Milo',text:()=>`
  <p>Le coffret frappé du sceau de Milo est sanglé à un crochet. Le plomb est déjà ébréché ; tu évites d’y jeter un œil.</p>`,
  choices:[
    {label:'Détacher le coffret pour Milo',hint:'Prépare le passe au Pont',immediate:s=>{s.tags.add('Coffret_Milo');s.inv.push('Coffret (Milo)');s.objective='Apporter le coffret à Milo pour obtenir le laissez-passer.';addObj('Coffret de Milo sécurisé.');}},
    {label:'Prendre la cave vers les Berges',hint:'Continuer vers la trappe technique',go:'ber_entry'}
  ]
 },
 ber_entry:{
 img:IMG.ber,title:'Berges — Darses',text:()=>`
  <p>La vase masque une trappe d’entretien. À chaque contact, le métal grince et vibre.</p>`,
  choices:[
    {label:'Décrocher la trappe technique',hint:'NEU/Cryptanalyse (10) — ouvrir l’accès vers T1',test:{stat:'NEU',skill:'Cryptanalyse',dd:10,
      ok:s=>{s.tags.add('Acces_Tech');s.objective='Descendre vers T1 par la trappe technique.';addObj('Trappe vers T1 ouverte.');},ko:s=>{log('Contacts oxydés : il faudra insister.')}}},
    {label:'Remonter vers le Pont',hint:'Avec le coffret de Milo : passe-droit assuré',go:'pon_pass'}
  ]
 },
 pon_pass:{
  img:IMG.pon,title:'Pont de la Guill’ — Passage',text:()=>`
  <p>Deux guetteurs s’abritent sous le pont. Ils filtrent les passages et attendent un signe convaincant.</p>`,
  choices:()=>{
    const a=[]; if(ST.tags.has('Coffret_Milo')){
      a.push({label:'Montrer le coffret — franchir le Pont',hint:'Passe-droit négocié avec Milo',immediate:s=>{s.objective='Traverser le Pont et atteindre T1.';log('« C’est pour Milo. » On te laisse filer.');},go:'t1_entry'});
    }else{
      a.push({label:'Parler sec aux guetteurs',hint:'VOL/Intimidation (10) — passer par la parole',test:{stat:'VOL',skill:'Intimidation',dd:10,
        ok:s=>{s.objective='Traverser le Pont et atteindre T1.';log('Ça passe. Personne n’a envie d’histoires.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('On te balade. +1 Stress.')}} ,go:'t1_entry'});
      a.push({label:'Se glisser le long des barrières',hint:'CIN/Furtivité (12) — contour discret',test:{stat:'CIN',skill:'Furtivité',dd:12,
        ok:s=>{s.objective='Traverser le Pont et atteindre T1.';log('Tu files comme une ombre.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Repéré·e, tu forces. +1 Stress.')}} ,go:'t1_entry'});
    }
    return a;
  }
 },
 t1_entry:{
 img:IMG.t1,title:'Sous-station T1 — Plans froissés',text:()=>`
  <p>« La douceur est une technologie », griffonné à la craie sur le béton. La porte principale tremble ; la grille renvoie un souffle tiède.</p>`,
  choices:[
    {label:'Déverrouiller la porte principale',hint:'NEU/Cryptanalyse (12) — ouvrir l’accès frontal',test:{stat:'NEU',skill:'Cryptanalyse',dd:12,
      ok:s=>{s.tags.add('T1_Ouverte');s.objective='Stabiliser le cœur de T1.';addObj('Porte principale de T1 ouverte.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Le ton faux te vrille. +1 Stress.')}}},
    {label:'Se glisser par la grille',hint:'CIN/Furtivité (10) — infiltration par le bas',test:{stat:'CIN',skill:'Furtivité',dd:10,
      ok:s=>{s.tags.add('T1_Grille');s.objective='Stabiliser le cœur de T1.';addObj('Tu t’infiltres par la grille.');},ko:s=>{log('Une vis tinte. Tu attends.')}}},
    {label:'Si Noor_Sac → elle t’ouvre de l’intérieur',when:()=>ST.tags.has('Noor_Sac'),immediate:s=>{s.tags.add('Noor_Trust');s.objective='Stabiliser le cœur de T1.';addObj('Noor entrouvre la porte depuis l’intérieur.');}},
    {label:'Accéder au cœur',hint:'Disponible si une entrée est ouverte',when:()=>ST.tags.has('T1_Ouverte')||ST.tags.has('T1_Grille')||ST.tags.has('Noor_Trust'),go:'t1_core'}
  ]
 },
 t1_core:{
  img:IMG.t1,title:'Sous-station T1 — Cœur',text:()=>`
  <p>Le cœur de T1 vibre. Trois leviers bricolés clignotent : <b>Contournement</b>, <b>Relance</b>, <b>Trame douce</b>. Chaque option a son prix.</p>`,
  choices:[
    {label:'Contournement — gagner du temps',hint:'SOM/Mécanique (10) — détourner les flux (+1 Flux)',test:{stat:'SOM',skill:'Mécanique',dd:10,
      ok:s=>{s.flux=Math.max(0,s.flux+1);s.objective='Quitter la zone avant la prochaine alerte.';addObj('Contournement posé : la nuit tiendra un peu plus.');},ko:s=>{s.hp=Math.max(0,s.hp-1);log('Coup de jus. +1 Blessure.')}} ,goOK:'ep_cont',goKO:'ep_silent'},
    {label:'Relance — plus risqué',hint:'NEU/Déduction (12) — redémarrage bruyant',test:{stat:'NEU',skill:'Déduction',dd:12,
      ok:s=>{s.tags.add('Relance');addObj('Relance réussie : T1 repart en claquant.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Tu recules. +1 Stress.')}} ,goOK:'ep_noise',goKO:'ep_silent'},
    {label:'Trame douce — protéger les souvenirs',hint:'VOL/Empathie (12) + ✦ — apaiser la Sourdine',test:{stat:'VOL',skill:'Empathie',dd:12,needsFrag:true,
      ok:s=>{s.tags.add('Trame_Douce');s.frag=Math.max(0,s.frag-1);addObj('Voile tiré : les mémoires restent en place.');},ko:s=>{log('Tu n’oses pas. Rien ne casse.')}} ,goOK:'ep_soft',goKO:'ep_silent'}
  ]
 },
 ep_cont:{img:IMG.t1,title:'Épilogue — Contournement',text:()=>`
  <p>Le quartier respire encore. Ce n’est pas brillant, mais tu as gagné quelques heures.</p>`,choices:[{label:'Recommencer (retour Prologue)',go:'prologue'}]},
 ep_noise:{img:IMG.t1,title:'Épilogue — Relance',text:()=>`
  <p>T1 claque comme une ampoule neuve. Certains applaudiront, d’autres t’en voudront pour le vacarme.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_soft:{img:IMG.t1,title:'Épilogue — Trame douce',text:()=>`
  <p>La Sourdine se relâche. Des visages se souviennent mieux. Tu laisses la nuit respirer.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_silent:{img:IMG.t1,title:'Épilogue — Silence',text:()=>`
  <p>T1 se tait. Tu coupes proprement et promets de revenir avec plus de temps.</p>`,choices:[{label:'Recommencer',go:'prologue'}]}
};

/* ======= RENDER ENGINE ======= */
function render(){
  ST.visited.add(ST.scene.includes('maz_')?'maz':ST.scene.includes('ber_')?'ber':ST.scene.includes('pon_')?'pon':ST.scene.includes('t1')?'t1':ST.scene.includes('place')?'place':ST.scene);
  const sc=SC[ST.scene]; if(!sc) return;
  if(ST.scene==='prologue'){ST.objective='Tracer une voie sûre vers T1.';}
  $('#storyTitle').textContent=sc.title;
  $('#storyText').innerHTML=sc.text?sc.text():'';
  const i=sc.img||IMG.place; $('#storyImg').src=i.src; $('#imgLegend').textContent=i.lg||'';
  const box=$('#choices'); box.innerHTML='';
  const arr=typeof sc.choices==='function'?sc.choices():sc.choices;
  (arr||[]).forEach((c,idx)=>{
    if(c.when && !c.when()) return;
    const div=document.createElement('div'); div.className='choice';
    if(c.test && c.test.stat) div.classList.add('attr-'+c.test.stat);
    const testTags=c.test?`<span class="tag">${c.test.stat}</span><span class="tag">${c.test.skill||''}</span><span class="tag">DD ${c.test.dd}</span>`:'';
    div.innerHTML=`<strong>${idx+1}. ${c.label}</strong><small>${c.hint||''}</small><div class="tags">${testTags}</div>`;
    div.addEventListener('click',()=>handleChoice(c));
    box.appendChild(div);
  });
  bars(); renderStats(); renderAscii(); $('#objectiveText').textContent=ST.objective;
}
let pending=null, roll=null, pendingOutcome=null;
function handleChoice(c){
  const immediateOnly = !!c.immediate && !c.go && !c.test;
  if(c.immediate) c.immediate(ST);
  if(c.go && !c.test){ ST.scene=c.go; addObj('Déplacement: '+SC[ST.scene].title); save(); render(); return; }
  if(c.test){ pending=c; showTest(c); return; }
  if(immediateOnly){ save(); render(); return; }
}
function showTest(c){
  $('#testPanel').style.display='block';
  $('#testName').textContent=`${c.test.stat}/${c.test.skill||'-'}`;
  $('#testDD').textContent=c.test.dd;
  const fluxBox=$('#useFlux');
  const pushBox=$('#usePush');
  const fragBox=$('#useFrag');
  if(fluxBox){fluxBox.checked=false; fluxBox.disabled=ST.flux<=0;}
  if(pushBox){pushBox.checked=false;}
  if(fragBox){
    const needsFrag=!!c.test.needsFrag;
    fragBox.checked=needsFrag && ST.frag>0;
    fragBox.disabled=ST.frag<=0;
  }
  const rollBtn=$('#rollBtn');
  if(rollBtn){rollBtn.disabled=false; rollBtn.onclick=()=>startDice();}
  const resultBox=$('#testResult');
  if(resultBox){resultBox.textContent='';resultBox.classList.remove('show','success','fail');}
  updateTestHint();
}

function gatherModifiers(test){
  const result={mod:0,breakdown:[],previewParts:[],spendFlux:false,spendPush:false,spendFrag:false};
  if(!test) return result;
  if(test.stat){
    const base=ST.stats[test.stat]||0;
    result.mod+=base;
    result.breakdown.push(`Attribut ${test.stat} +${base}`);
    result.previewParts.push(`Base ${test.stat} ${base}`);
  }
  const skillName=test.skill||null;
  if(skillName){
    if(ST.skills[skillName]>0){
      result.mod+=1;
      result.breakdown.push(`Compétence ${skillName} +1`);
      result.previewParts.push(`Compétence ${skillName} +1`);
    }
    if(skillName==='Furtivité'&&ST.arch?.id==='noor'){
      result.mod+=1;
      result.breakdown.push('Noor +1 Furtivité');
      result.previewParts.push('Noor +1 Furtivité');
    }
    if(skillName==='Intimidation'&&ST.arch?.id==='milo'){
      result.mod+=1;
      result.breakdown.push('Milo +1 Intimidation');
      result.previewParts.push('Milo +1 Intimidation');
    }
    if(skillName==='Mécanique'&&ST.arch?.id==='rayan'){
      result.mod+=1;
      result.breakdown.push('Rayan +1 Mécanique');
      result.previewParts.push('Rayan +1 Mécanique');
    }
  }
  const fluxEl=$('#useFlux');
  if(fluxEl && fluxEl.checked && ST.flux>0){
    result.mod+=2;
    result.breakdown.push('Flux +2');
    result.previewParts.push('Flux +2');
    result.spendFlux=true;
  }
  const pushEl=$('#usePush');
  if(pushEl && pushEl.checked){
    result.mod+=2;
    result.breakdown.push('Chance +2');
    result.previewParts.push('Chance +2');
    result.spendPush=true;
  }
  const fragEl=$('#useFrag');
  if(fragEl && fragEl.checked && ST.frag>0){
    result.mod+=2;
    result.breakdown.push('Fragment +2 (stress +1)');
    result.previewParts.push('Fragment +2 (+1 Stress)');
    result.spendFrag=true;
  }
  return result;
}

function previewOutcome(test=pending?.test){
  if(!test) return null;
  const mods=gatherModifiers(test);
  return {
    mod:mods.mod,
    dd:test.dd||0,
    parts:mods.previewParts,
    spendFlux:mods.spendFlux,
    spendPush:mods.spendPush,
    spendFrag:mods.spendFrag
  };
}

function updateTestHint(){
  const hint=$('#testHint');
  if(!hint) return;
  const test=pending?.test;
  const rollBtn=$('#rollBtn');
  const fragEl=$('#useFrag');
  if(!test){
    hint.textContent='';
    if(rollBtn) rollBtn.disabled=false;
    return;
  }
  const needsFrag=!!test.needsFrag;
  const fragAvailable=ST.frag>0;
  if(fragEl){
    if(needsFrag){
      if(fragAvailable && !fragEl.checked){ fragEl.checked=true; }
      if(!fragAvailable){ fragEl.checked=false; }
      fragEl.disabled=!fragAvailable;
    }else{
      fragEl.disabled=ST.frag<=0;
    }
  }
  if(needsFrag && !fragAvailable){
    if(rollBtn) rollBtn.disabled=true;
    hint.textContent='Fragment requis (+1 Stress) indisponible.';
    return;
  }
  if(rollBtn) rollBtn.disabled=false;
  const preview=previewOutcome(test);
  if(!preview){
    hint.textContent='';
    return;
  }
  const parts=preview.parts.length?preview.parts:['Aucun modificateur'];
  const modSign=preview.mod>=0?`+${preview.mod}`:`${preview.mod}`;
  hint.textContent=`${parts.join(' + ')} = ${modSign} (Total cible ${preview.dd})`;
}
function startDice(){
  if(!pending) return;
  roll=null; pendingOutcome=null;
  $('#diceOverlay').style.display='flex';
  $('#d1').classList.add('anim'); $('#d2').classList.add('anim');
  $('#d1').textContent='•'; $('#d2').textContent='•';
  $('#diceInfo').innerHTML='<div class="diceSummary">Les dés roulent…</div><div class="diceBreakdown">Clique sur « Arrêter » pour figer le résultat.</div>';
  const stop=$('#btnStopDice'), cont=$('#btnResolveDice');
  if(stop){stop.disabled=false;}
  if(cont){cont.style.display='none';}
}
function computeOutcome(){
  if(!pending||!roll) return null;
  const mods=gatherModifiers(pending.test);
  const total=roll.sum+mods.mod;
  const dd=pending.test.dd;
  const ok=total>=dd;
  return {
    mod:mods.mod,
    total,
    dd,
    ok,
    spendFlux:mods.spendFlux,
    spendFrag:mods.spendFrag,
    spendPush:mods.spendPush,
    breakdown:mods.breakdown
  };
}
function stopDice(){
  if(!pending||pendingOutcome) return;
  $('#d1').classList.remove('anim'); $('#d2').classList.remove('anim');
  const a=1+Math.floor(Math.random()*6), b=1+Math.floor(Math.random()*6);
  $('#d1').textContent=a; $('#d2').textContent=b;
  roll={a,b,sum:a+b};
  pendingOutcome=computeOutcome();
  let html=`<div class="diceSummary">Résultat : ${a} + ${b} = ${roll.sum}</div>`;
  if(pendingOutcome){
    const mods=pendingOutcome.breakdown.length?pendingOutcome.breakdown.join(' · '):'Aucun modificateur';
    html+=`<div class="diceBreakdown">Modificateurs : ${mods}</div>`;
    html+=`<div class="diceBreakdown">Total : ${roll.sum} + ${pendingOutcome.mod} = ${pendingOutcome.total}</div>`;
    html+=`<div class="diceStatus ${pendingOutcome.ok?'success':'fail'}">${pendingOutcome.ok?'Réussite':'Échec'} — ${pendingOutcome.total} (DD ${pendingOutcome.dd})</div>`;
  }
  $('#diceInfo').innerHTML=html;
  const stop=$('#btnStopDice'), cont=$('#btnResolveDice');
  if(stop){stop.disabled=true;}
  if(cont){cont.style.display='inline-flex';cont.focus();}
}
$('#btnStopDice').addEventListener('click', stopDice);
$('#btnResolveDice').addEventListener('click', resolveRoll);
['#useFlux','#usePush','#useFrag'].forEach(sel=>{
  const el=$(sel);
  if(el){ el.addEventListener('change', updateTestHint); }
});
function resolveRoll(){
  if(!pending||!roll||!pendingOutcome) return;
  const c=pending, outcome=pendingOutcome;
  if(outcome.spendFlux){ST.flux--;}
  if(outcome.spendFrag){ST.frag--;ST.stress=Math.min(5,ST.stress+1);log('Le fragment te mord. +1 Stress.');}
  const next=outcome.ok ? (c.goOK||c.go) : (c.goKO||c.go);
  log(`${c.test.stat}/${c.test.skill||'-'} DD${outcome.dd} — ${roll.a}+${roll.b}=${roll.sum} + ${outcome.mod} = ${outcome.total} → ${outcome.ok?'Réussite':'Échec'}`);
  if(outcome.ok && c.test.ok) c.test.ok(ST);
  if(!outcome.ok && c.test.ko) c.test.ko(ST);
  const resultBox=$('#testResult');
  if(resultBox){
    resultBox.textContent=`${outcome.ok?'Réussite':'Échec'} — ${outcome.total} (DD ${outcome.dd})`;
    resultBox.classList.remove('show','success','fail');
    resultBox.classList.add('show', outcome.ok?'success':'fail');
  }
  pending=null; roll=null; pendingOutcome=null;
  updateTestHint();
  const stop=$('#btnStopDice'), cont=$('#btnResolveDice');
  if(stop){stop.disabled=false;}
  if(cont){cont.style.display='none';}
  $('#diceOverlay').style.display='none';
  if(next){ ST.scene=next; addObj('Déplacement: '+SC[next].title); $('#testPanel').style.display='none'; }
  else { $('#testPanel').style.display='block'; }
  save(); render();
}

/* ======= ARCHETYPES ======= */
$('#btnChooseArch').addEventListener('click',()=>{ $('#introModal').style.display='none'; openArch(); });
let sel=null;
function openArch(){
  const list=$('#archList'); list.innerHTML='';
  sel=ST.arch||null;
  $('#btnConfirm').disabled=!sel;
  ARCH.forEach(a=>{ const card=document.createElement('div'); card.className='arch'; card.innerHTML=`
    <img src="${a.img}" alt="${a.name}"><div class="pad"><h3>${a.name}</h3><p>${a.back}</p>
    <div class="statrow"><span class="b">NEU ${a.stats.NEU}</span><span class="b">VOL ${a.stats.VOL}</span><span class="b">SOM ${a.stats.SOM}</span><span class="b">CIN ${a.stats.CIN}</span></div></div>`;
    card.setAttribute('role','button');
    card.setAttribute('tabindex','0');
    card.setAttribute('aria-selected','false');
    card.addEventListener('click',()=>selectArch(a,card));
    card.addEventListener('keydown',e=>{
      if(e.key==='Enter'||e.key===' '||e.key==='Spacebar'){e.preventDefault();selectArch(a,card);} });
    if(ST.arch && ST.arch.id===a.id){ sel=a; card.setAttribute('aria-selected','true'); $('#btnConfirm').disabled=false; }
    list.appendChild(card); });
  $('#archModal').style.display='flex';
}
function selectArch(a,card){ sel=a; document.querySelectorAll('.arch').forEach(x=>x.setAttribute('aria-selected','false')); card.setAttribute('aria-selected','true'); $('#btnConfirm').disabled=false; }
$('#btnRandom').addEventListener('click',()=>{const i=Math.floor(Math.random()*ARCH.length);selectArch(ARCH[i], document.querySelectorAll('.arch')[i])});
$('#btnConfirm').addEventListener('click',()=>{ ST.arch=sel; ST.stats={...sel.stats}; ST.skills={...sel.skills}; ST.inv=[...sel.start];
  addObj('Archétype: '+sel.name); $('#archModal').style.display='none'; save(); render(); });

/* ======= INIT ======= */
setupNav(); // header + mobile bar
const mobileMq=window.matchMedia ? window.matchMedia('(max-width: 900px)') : null;
const syncView=e=>{
  if(e.matches){
    if(document.body.getAttribute('data-view')==='all'){ setView('story'); }
  }else{
    if(document.body.getAttribute('data-view')!=='all'){ setView('all'); }
  }
};
if(mobileMq){
  syncView(mobileMq);
  if(mobileMq.addEventListener){ mobileMq.addEventListener('change',syncView); }
  else if(mobileMq.addListener){ mobileMq.addListener(syncView); }
}
setView(document.body.getAttribute('data-view')||'all');
load();
renderStats(); renderAscii(); renderTimeline(); bars(); render();
if(!ST.arch){ $('#introModal').style.display='flex'; }
</script>
</body>
</html>
