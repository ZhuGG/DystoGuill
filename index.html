<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TRAME DOUCE — Guillotière // Pastel‑Punk Arty (Proto v4)</title>
<style>
/* =====================================================================
   DIRECTION ARTISTIQUE — PASTEL‑PUNK ARTY (Guillotière) — v4
   ---------------------------------------------------------------------
   • Palette accrue + codes couleur par attribut
   • Archetype cards en surbrillance au clic
   • Modal de test in‑game (plus de popups)
   • ASCII ON par défaut + plus bavard
   • Dés animés plus lents + validation manuelle
   • Responsive affiné
   ===================================================================== */
:root{
  --bg:#0a0e15; --panel:#101726; --muted:#182036; --ink:#e7f0ff; --ink-dim:#9fb2d3;
  --accent:#b9fbc0; --accent2:#ffd6a5; --accent3:#bde0fe; --accent4:#ffafcc;
  --danger:#ff6b6b; --good:#7bf1a8; --warn:#ffe066; --border:#273248;
  --radius:16px; --shadow:0 16px 44px rgba(189,224,254,.10);
  /* Attributs */
  --col-neu:#9dd0ff; --col-vol:#ffb3cf; --col-som:#ffd889; --col-cin:#b6f8c7;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:16px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--ink);
  background:
    radial-gradient(1200px 800px at 10% -10%, rgba(255,175,204,.08), transparent 60%),
    radial-gradient(1400px 900px at 120% 0%, rgba(189,224,254,.06), transparent 60%),
    radial-gradient(1000px 900px at 40% 120%, rgba(185,251,192,.07), transparent 60%),
    var(--bg);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.app{display:grid;grid-template-columns:360px 1fr 380px;grid-template-rows:auto 1fr auto;gap:14px;max-width:1460px;margin:0 auto;padding:16px 18px 18px}
header{grid-column:1/4;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.08) blur(8px)}
header .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:12px;font-weight:650;letter-spacing:.5px}
.dot{width:10px;height:10px;border-radius:50%;background:conic-gradient(var(--accent4),var(--accent3),var(--accent),var(--accent2));box-shadow:0 0 16px rgba(255,175,204,.35)}
.hud{display:flex;gap:8px;flex-wrap:wrap}
.chip{background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:8px;color:var(--ink-dim)}
.chip strong{color:var(--ink)}
.bar{height:8px;background:#0d1422;border-radius:6px;overflow:hidden;box-shadow:inset 0 0 0 1px var(--border)}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent3),var(--accent4))}
.left,.center,.right{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius)}
.left{padding:14px}.center{padding:18px}.right{padding:14px}
.panel-title{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--ink-dim);margin-bottom:10px}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.stat{background:linear-gradient(180deg,rgba(189,224,254,.05),transparent 60%);border:1px solid var(--border);border-radius:14px;padding:10px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
.stat .abbr{font-weight:800;letter-spacing:.08em}
.stat.neu .abbr{color:var(--col-neu)} .stat.vol .abbr{color:var(--col-vol)} .stat.som .abbr{color:var(--col-som)} .stat.cin .abbr{color:var(--col-cin)}
.stat .name{color:var(--ink-dim);font-size:12px}.stat .val{font-weight:700}
.mini-map{height:240px;border:1px dashed var(--border);border-radius:14px;padding:10px;position:relative;overflow:hidden}
.node{position:absolute;padding:6px 8px;border-radius:10px;border:1px solid var(--border);background:rgba(26,32,48,.6);color:var(--ink-dim);font-size:12px}
.node.visited{color:var(--ink);box-shadow:0 0 0 1px #3b4760 inset;background:rgba(26,32,48,.92)}
.node::after{content:"";position:absolute;width:6px;height:6px;right:-3px;top:50%;transform:translateY(-50%);border-radius:50%;background:var(--accent4);box-shadow:0 0 12px rgba(255,175,204,.6)}
.story{min-height:340px;font-size:17px}
.choice-list{display:grid;gap:10px;margin-top:8px}
.btn{--glow:rgba(189,224,254,.10);background:linear-gradient(180deg,rgba(185,251,192,.08),rgba(189,224,254,.06));border:1px solid var(--border);color:var(--ink);padding:14px 14px;border-radius:14px;text-align:left;cursor:pointer;display:flex;justify-content:space-between;gap:10px;transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease;position:relative}
.btn::before{content:"";position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:14px 0 0 14px;background:linear-gradient(180deg,var(--accent3),var(--accent4));opacity:.8}
.btn:hover{transform:translateY(-1px);box-shadow:0 8px 28px var(--glow);border-color:#324162}
.btn:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(189,224,254,.4)}
.meta{color:var(--ink-dim);font-size:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.tag{border:1px solid var(--border);background:var(--muted);border-radius:999px;padding:3px 8px;font-size:11px;color:var(--ink-dim)}
.tag.neu{border-color:#2f4865;color:var(--col-neu)} .tag.vol{border-color:#5a3b54;color:var(--col-vol)} .tag.som{border-color:#5a5038;color:#ffd889} .tag.cin{border-color:#2e5a4c;color:var(--col-cin)}
.log{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "JetBrains Mono", monospace;background:linear-gradient(180deg,rgba(255,214,165,.06),transparent 50%);border:1px solid var(--border);border-radius:14px;padding:10px;height:420px;overflow:auto}
.log .entry{border-bottom:1px dashed var(--border);padding:6px 0}
.log .ok{color:var(--good)}.log .bad{color:var(--danger)}
.toggles{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--muted);border-radius:999px;padding:6px 10px;cursor:pointer}
.toggle input{accent-color:var(--accent3)}
.ascii{white-space:pre;font-family:JetBrains Mono, ui-monospace, Menlo, Consolas, monospace;background:#0a0d12;border:1px solid var(--border);border-radius:14px;padding:12px;color:#c3cee4}
.sprite{width:100%;height:240px;border:1px dashed var(--border);border-radius:14px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(185,251,192,.05),rgba(255,175,204,.06));color:var(--ink-dim);overflow:hidden}
.sprite img, .sprite svg{width:100%;height:100%;object-fit:cover}
footer{grid-column:1/4;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 4px;color:var(--ink-dim)}
.kbd{font-family:ui-monospace, Menlo, Consolas, monospace;border:1px solid var(--border);border-bottom-width:3px;background:var(--muted);padding:2px 6px;border-radius:6px}
.ghost{color:var(--ink-dim)}
@media (max-width:1180px){.app{grid-template-columns:1fr}}

/* Dice overlay */
#diceOverlay{position:fixed;inset:0;background:rgba(9,12,18,.64);display:none;align-items:center;justify-content:center;z-index:100}
.diceBox{background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:16px;box-shadow:var(--shadow);display:grid;grid-template-columns:auto auto 1fr;gap:18px;align-items:center;min-width:520px}
.die{width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg,#1a2234,#0f1524);display:flex;align-items:center;justify-content:center;font:800 30px/1 "JetBrains Mono", ui-monospace;color:var(--ink);border:1px solid #33435f}
.die.rolling{animation:roll .9s linear infinite}
@keyframes roll{0%{transform:rotate(0)}50%{transform:rotate(180deg)}100%{transform:rotate(360deg)}}
.diceActions{display:flex;gap:10px;align-items:center;justify-content:flex-end}

/* Test panel (bottom sheet) */
#testPanel{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:90;display:none}
.testCard{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px;min-width:640px;display:grid;gap:10px}
.testRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.testCard .title{font-weight:700}
.badge{border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}
.badge.neu{color:var(--col-neu)} .badge.vol{color:var(--col-vol)} .badge.som{color:var(--col-som)} .badge.cin{color:var(--col-cin)}
.switch{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:var(--muted);border-radius:999px;padding:6px 10px;cursor:pointer}
.switch input{accent-color:var(--accent3)}
.btnSmall{border:1px solid var(--border);background:linear-gradient(180deg, rgba(185,251,192,.08), rgba(189,224,254,.06));border-radius:10px;padding:8px 10px;cursor:pointer}

/* Archetype cards */
.card{background:linear-gradient(180deg,rgba(185,251,192,.06),rgba(189,224,254,.05));border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;gap:12px;align-items:center;cursor:pointer;min-height:120px}
.card .title{font-weight:700}
.card.selected{outline:3px solid rgba(189,224,254,.45); box-shadow:0 0 0 2px rgba(255,175,204,.4) inset}
.card .leftIcon{width:40px;height:40px;border-radius:10px;background:#0e1523;display:flex;align-items:center;justify-content:center}
.card .leftIcon svg{width:24px;height:24px}

/* Font scale */
:root{--fs:1}
body{font-size:calc(16px * var(--fs))}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="TRAME DOUCE — Guillotière v4">
    <header aria-live="polite">
      <div class="row">
        <div class="brand"><span class="dot" aria-hidden="true"></span> TRAME DOUCE — <span class="ghost">Guillotière</span></div>
        <div class="hud" id="hud"></div>
      </div>
    </header>

    <aside class="left" aria-label="Panneau gauche">
      <div class="panel-title">Profil</div>
      <div class="stats" id="stats"></div>
      <div style="height:10px"></div>
      <div class="panel-title">Mini‑carte (Guill’)</div>
      <div class="mini-map" id="minimap" aria-label="Mini-carte de la Guillotière">
        <div class="node" id="node-G0" style="left:18px; top:36px">Place du Pont</div>
        <div class="node" id="node-G1" style="left:178px; top:28px">Rue de Marseille</div>
        <div class="node" id="node-G2" style="left:92px; top:126px">Friche Mazagran</div>
        <div class="node" id="node-G3" style="left:236px; top:118px">Berges — Darses</div>
        <div class="node" id="node-G4" style="left:34px; top:178px">Pont de la Guill’</div>
        <div class="node" id="node-G5" style="left:208px; top:176px">Sous‑station T1</div>
      </div>
      <div style="height:10px"></div>
      <div class="panel-title">Réglages</div>
      <div class="toggles">
        <label class="toggle"><input type="checkbox" id="t-reduced" /> Réduire animations</label>
        <label class="toggle"><input type="checkbox" id="t-ascii" checked /> HUD ASCII (<span class="kbd">H</span>)</label>
        <label class="toggle"><input type="checkbox" id="t-sound" /> Son (très discret)</label>
        <label class="toggle"><input type="checkbox" id="t-cru" checked /> Langage cru</label>
        <label class="toggle"><input type="checkbox" id="t-autosave" checked /> Sauvegarde auto</label>
      </div>
      <div style="margin:10px 0 4px" class="ghost">Taille texte</div>
      <input type="range" min="0.9" max="1.3" step="0.01" value="1" id="fontRange" style="width:100%" />
      <div style="height:10px"></div>
      <button class="btn" id="btn-save">Export sauvegarde</button>
      <button class="btn" id="btn-load">Importer sauvegarde</button>
    </aside>

    <section class="center" aria-live="polite" aria-label="Narration et choix">
      <div class="panel-title">Histoire</div>
      <figure class="sprite" id="art" aria-label="Illustration de scène"></figure>
      <div id="story" class="story"></div>
      <div class="choice-list" id="choices" role="listbox" aria-label="Choix disponibles"></div>
      <div class="ascii" id="ascii"></div>
    </section>

    <aside class="right" aria-label="Journal & dés">
      <div class="panel-title">Journal des dés</div>
      <div class="log" id="log" aria-live="polite"></div>
      <div style="height:10px"></div>
      <div class="panel-title">Aides</div>
      <div class="ghost">• Raccourcis <span class="kbd">1‑9</span> pour choisir. <br>• <span class="kbd">H</span> : HUD ASCII. <br>• Modificateurs des jets dans le **panneau de test** (pas de popup). <br>• Export/Import JSON de sauvegarde.</div>
    </aside>

    <footer>
      <div>© Proto v4 — « Pastel‑punk Guill’ » — UI/UX accessible, arty. CC0/Unsplash placeholders.</div>
      <div class="ghost">Fichier unique. Aucune dépendance. Responsive.</div>
    </footer>
  </div>

  <!-- Dice overlay -->
  <div id="diceOverlay" aria-hidden="true">
    <div class="diceBox">
      <div class="die" id="d1">—</div>
      <div class="die" id="d2">—</div>
      <div>
        <div class="ghost" style="font-size:12px">Lancer en cours…</div>
        <div id="diceText" style="font-family:ui-monospace,Menlo,Consolas,monospace;margin-top:6px"></div>
        <div class="diceActions">
          <button class="btnSmall" id="diceOk">Appliquer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Test bottom sheet -->
  <div id="testPanel">
    <div class="testCard">
      <div class="testRow"><span class="title" id="tpTitle">Test</span> <span class="badge" id="tpBadge"></span> <span class="tag" id="tpDC"></span></div>
      <div class="testRow">
        <label class="switch"><input type="checkbox" id="tpFlux"> Dépenser ◆ Flux (+2 réseau/stealth)</label>
        <label class="switch"><input type="checkbox" id="tpPush"> Pousser sa chance (+2 ; si échec → +1 Stress)</label>
        <label class="switch"><input type="checkbox" id="tpFrag"> Dépenser ✦ Fragment (+2 ; +1 Stress)</label>
      </div>
      <div class="testRow" id="tpPreview" style="font-family:ui-monospace,Menlo,Consolas,monospace"></div>
      <div class="testRow" style="justify-content:flex-end">
        <button class="btnSmall" id="tpRoll">Lancer les dés</button>
        <button class="btnSmall" id="tpCancel">Fermer</button>
      </div>
    </div>
  </div>

<script>
/* =====================================================================
   TRAME DOUCE — Guillotière v4 (Disco-like narratif)
   • ASCII par défaut, contenu plus long, personnages (dealer, sdf…)
   • Archetype surbrillance, panel de tests, dés plus lents
   • Images CC0/Unsplash par URL (remplaçables)
   ===================================================================== */
(function(){
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));

  // --------- Core State ---------
  const state = {
    seed: Date.now(),
    scene: 'START',
    visited: new Set(),
    archetype: null,
    stats: { NEU:2, VOL:2, SOM:2, CIN:2 }, // baseline
    skills: { Empathie:0, Intimidation:0, Furtivite:0, Cryptanalyse:0, Deduction:0, Mnemographie:0, Endurance:0, Resistance:0, Mecafortune:0, Reflexes:0, CAC:0 },
    stress: 5, hp: 5,
    flux: 2, fragments: 2,
    inventory: [],
    flags: { ascii:true, reduced:false, sound:false, cru:true },
    tags: {},
    log: []
  };

  // Load
  try{ const saved = JSON.parse(localStorage.getItem('TRAME_GUILL_V4')||'null'); if(saved && saved.scene){ Object.assign(state,saved); state.visited=new Set(saved.visited||[]); } }catch(e){}

  // RNG
  function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296 } }
  let rng = mulberry32(state.seed);
  function d6(){ return Math.floor(rng()*6)+1 }
  function roll2d6(){ const a=d6(), b=d6(); return {a,b,sum:a+b,doubles:(a===b)} }

  // Audio (optional)
  const ctx = (window.AudioContext||window.webkitAudioContext) ? new (window.AudioContext||window.webkitAudioContext)() : null;
  function beep(freq=220, ms=120){ if(!state.flags.sound || !ctx) return; const o=ctx.createOscillator(); const g=ctx.createGain(); o.frequency.value=freq; o.type='triangle'; g.gain.value=.0009; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); }, ms); }

  // --------- Archetypes ----------
  const ARCH = {
    ACCORDEUR: { label:'Accordeur de Bruit', pitch:`Tu calmes les emmerdes sans lever la voix. Une fois, t’as accordé un rideau métallique et la bagarre a fondu.`, stats:{ NEU:2,VOL:3,SOM:1,CIN:2 }, skills:{ Empathie:1,Intimidation:1,Furtivite:1 }, atout:{ name:'Regard qui désarme', hint:'1 interaction facile/scene' }, startItems:['Jeton d’écho','Feuillet-mica réglé'] },
    CARTO: { label:'Cartographe des Courants', pitch:`Tu lis le vent des couloirs, les câbles qui vibrent, les silences qui poussent. Tu sais où la ville glisse.`, stats:{ NEU:3,VOL:2,SOM:1,CIN:2 }, skills:{ Cryptanalyse:1,Deduction:1,Mnemographie:1 }, atout:{ name:'Écoute directionnelle', hint:'1 relance mentale/scene' }, startItems:['Craie douce','Mic-corde sensible'] },
    BIFFIN: { label:'Biffin Ingénieur', pitch:`Tu rafistoles ce qui a honte de grincer. Aux puces, on t’appelle quand tout foire.`, stats:{ NEU:2,VOL:1,SOM:3,CIN:2 }, skills:{ Mecafortune:1,Endurance:1,Reflexes:1 }, atout:{ name:'Atelier mobile', hint:'+2 au 1er test mécanique de la scène' }, startItems:['Trousse feutrée','Aimant‑algue'] }
  };

  // --------- Scenes (plus longues, personnages clairs) ---------
  const IMG = {
    start: 'https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop',
    pont: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
    mazagran: 'https://images.unsplash.com/photo-1505238680356-667803448bb6?q=80&w=1200&auto=format&fit=crop',
    berges: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=1200&auto=format&fit=crop',
    pont2: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop',
    t1: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200&auto=format&fit=crop',
    end: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1200&auto=format&fit=crop'
  };

  /* Ton: concret, direct. Légère vulgarité contrôlée. */
  const SCENES = {
    START:{
      name:'Prologue — Guillotière', art:'start',
      text: t(`Pluie fine, odeur de graisse froide, linge mouillé. La <em>Sourdine</em> bouffe les cris et endort les moteurs. 
      Place du Pont, fin d’aprèm. Trois silhouettes te regardent comme on jauge un outil:
      — <strong>Milo</strong>, dealer propre, baskets immaculées, parle bas: « J’ai un passage à faire. Payé. Propre. »
      — <strong>Noor</strong>, vieille clocharde droite comme un clou: « Pas d’aumône. Mais j’ai un truc à te confier si t’as des mains. »
      — <strong>Rayan</strong>, électricien de fortune: « La sous‑station T1 tousse. On peut la calmer. T’es partant·e ? »
      Avant d’avancer, choisis ce que tu es ici.`),
      choices:[
        { text:'ACCORDEUR — tenir la masse sans gueuler', goto:'ARCH', flag:{key:'pick',val:'ACCORDEUR'} },
        { text:'CARTOGRAPHE — lire les courants invisibles', goto:'ARCH', flag:{key:'pick',val:'CARTO'} },
        { text:'BIFFIN — réparer avec trois bouts de feutre', goto:'ARCH', flag:{key:'pick',val:'BIFFIN'} }
      ]
    },
    ARCH:{ name:'Sélection — Archétype', art:'start', text:t(`Chaque profil vient avec ses cicatrices et ses outils. Pas de héros. Juste quelqu’un qui tient.`), choices:[
      { text:'Valider et revenir Place du Pont', goto:'G0', action:'applyArchetype' },
      { text:'Retour au prologue', goto:'START' }
    ]},

    G0:{ name:'Place du Pont — Point zéro', art:'pont',
      text: t(`Tentes, tables, bricoles. Réveils sans tic, radios qui murmurent. 
      Milo lisse sa casquette: « Passage discret vers les darses. Pas de grabuge. »
      Noor te montre un caddie rafistolé: « Les roues hurlent. Tu sais calmer ça ? »
      Rayan tapote un plan: « Si T1 sature, le tram tombe. On a besoin d’une main. »
      Un feuillet de mica dépasse d’un câble: si tu le frottes, tu captes un souvenir qui n’est pas le tien.`),
      choices:[
        { text:'Frotter le feuillet (NEU/Mnémographie)', test:{stat:'NEU',skill:'Mnemographie',dc:10}, success:{ log:t('Le motif se retourne dans ta tête. Tag « Motif_R ». Piste vers les Berges.'), tag:{k:'Motif_R',v:true}, goto:'G3' }, failure:{ log:t('Ça crisse dans ton crâne. +1 Stress.'), stress:-1, goto:'G0b' } },
        { text:'Aider Noor (SOM/Mécanique DD12)', test:{stat:'SOM',skill:'Mecafortune',dc:12}, success:{ log:t('Tu gaînes une roue avec de la chambre à air. Le caddie se tait. +1 Flux.'), flux:+1, tag:{k:'Noor_Confiance',v:true}, goto:'G0b' }, failure:{ log:t('Tu te plantes. Elle grogne. +1 Blessure.'), hp:-1, goto:'G0b' } },
        { text:'Dire oui à Milo (CIN/Furtivité DD10)', test:{stat:'CIN',skill:'Furtivite',dc:10}, success:{ log:t('Livraison acceptée. Il te file un <strong>jeton code</strong>.'), addItem:'Jeton code', tag:{k:'Milo_Piste',v:true}, goto:'G2' }, failure:{ log:t('Un drone te renifle. +1 Stress.'), stress:-1, goto:'G2' } },
        { text:'Suivre Rayan (NEU/Déduction DD10)', test:{stat:'NEU',skill:'Deduction',dc:10}, success:{ log:t('Son plan tient debout. Route sûre vers T1.'), tag:{k:'Route_T1',v:true}, goto:'G1' }, failure:{ log:t('Plan confus. On improvisera.'), goto:'G1' } }
      ]
    },
    G0b:{ name:'Place du Pont — Reprise', art:'pont', text:t(`Le marché souffle. Milo attend, Noor t’ignore à moitié, Rayan regarde la pluie qui file le long des câbles.`), choices:[
      { text:'Friche Mazagran (si Milo_Piste)', goto:'G2', requireTag:'Milo_Piste' },
      { text:'Berges (si Motif_R)', goto:'G3', requireTag:'Motif_R' },
      { text:'Sous‑station T1 (si Route_T1)', goto:'G1', requireTag:'Route_T1' },
      { text:'Prendre l’air et réfléchir', goto:'G4' }
    ]},

    G2:{ name:'Friche Mazagran — Cour qui tient', art:'mazagran',
      text:t(`Draps isolants entre deux fenêtres, odeur de soupe et de poussière mouillée. 
      Une femme t’attend: « Tu vas aux darses ? File ça à la Dame des Algues. Tu n’ouvres pas. » Elle te donne une petite boîte scellée.`),
      choices:[
        { text:'Prendre la boîte et filer discret (CIN/Furtivité DD10)', test:{stat:'CIN',skill:'Furtivite',dc:10}, success:{ log:t('Tu dégages sans soulever d’air. +1 Flux.'), flux:+1, addItem:'Boîte scellée', goto:'G3' }, failure:{ log:t('Un drone hésite au-dessus. +1 Stress.'), stress:-1, addItem:'Boîte scellée', goto:'G3' } },
        { text:'Ouvrir quand même (NEU/Cryptanalyse DD12)', test:{stat:'NEU',skill:'Cryptanalyse',dc:12}, success:{ log:t('Dedans: un Effaceur « doux ». Arme d’oubli locale. Tag « Effaceur_Doux ». '), tag:{k:'Effaceur_Doux',v:true}, addItem:'Effaceur doux (temporisé)', goto:'G3' }, failure:{ log:t('Sceau piquant. +1 Blessure.'), hp:-1, goto:'G3' } }
      ]
    },

    G3:{ name:'Berges — Darses', art:'berges',
      text:t(`Sous le pont, bassins d’algues, sacs serrés. La Dame des Algues te jauge: « Tu viens pour la boîte ? »
      Si tu parles du motif retourné, elle écoute. Si tu mens, elle te voit.`),
      choices:[
        { text:'Donner la boîte sans cinéma', goto:'G4', log:t('Elle la glisse dans un seau. « Merci. Garde ta tête froide. » Tag « Confiance_Minimaliste ». '), tag:{k:'Confiance_Min',v:true} },
        { text:'Parler du motif retourné (VOL/Empathie DD12)', test:{stat:'VOL',skill:'Empathie',dc:12}, success:{ log:t('Elle te file un Quitus de Passage. « Quand ça bloque, montre ça. »'), addItem:'Quitus de passage', tag:{k:'Quitus',v:true}, goto:'G4' }, failure:{ log:t('Elle détourne le regard. Ok. On avance.'), goto:'G4' } },
        { text:'Lire le flux de l’eau (NEU/Déduction DD10)', test:{stat:'NEU',skill:'Deduction',dc:10}, success:{ log:t('Tu repères un replat calme. Tag « Isthme ». '), tag:{k:'Isthme',v:true}, goto:'G4' }, failure:{ log:t('L’eau ment. Tu recules.'), goto:'G4' } }
      ]
    },

    G4:{ name:'Pont de la Guill’ — Calme tendu', art:'pont2',
      text:t(`Ça roule au pas. Deux flics regardent trop. Un scooter râle et s’éteint. Tu dois traverser sans faire d’histoire.`),
      choices:[
        { text:'Marcher à contre‑rythme (CIN/Furtivité DD12)', test:{stat:'CIN',skill:'Furtivite',dc:12}, success:{ log:t('Tes pas ne riment avec rien. Tu deviens personne. +1 Flux.'), flux:+1, goto:'G1' }, failure:{ log:t('Un regard s’accroche. +1 Stress.'), stress:-1, goto:'G1' } },
        { text:'Regarder droit et court (VOL/Intimidation DD10)', test:{stat:'VOL',skill:'Intimidation',dc:10}, success:{ log:t('Tu imposes un calme sec. Ils te laissent filer.'), goto:'G1' }, failure:{ log:t('Trop sec. « Vos papiers ? » Le bruit ne vient pas, mais ça colle au sol.'), stress:-1, goto:'G1' } },
        { text:'Montrer le Quitus (si tu l’as)', goto:'G1', requireTag:'Quitus', log:t('Ça passe. On te fout la paix.') }
      ]
    },

    G1:{ name:'Rue de Marseille — Vers la Sous‑station', art:'t1',
      text:t(`Néons rincés, kebabs ouverts, regards lourds mais utiles si tu respectes le pas. 
      Local technique au bout: Sous‑station T1. Des plans froissés au mur. Quelqu’un a noté: « La douceur est une technologie. »`),
      choices:[
        { text:'Programmer une « Porte Douce » (NEU/Cryptanalyse DD12)', test:{stat:'NEU',skill:'Cryptanalyse',dc:12}, success:{ log:t('Tu ouvres une voie propre pour le quartier. Fin « Porte Douce ». '), goto:'END_A' }, failure:{ log:t('La note fausse et se tait. +1 Stress.'), stress:-1, goto:'G5' } },
        { text:'Conclure un pacte de voisinage (VOL/Empathie DD12)', test:{stat:'VOL',skill:'Empathie',dc:12}, success:{ log:t('On te file des yeux et des mains. Fin « Pacte ». '), goto:'END_B' }, failure:{ log:t('Trop de fatigue. Pas aujourd’hui.'), goto:'G5' } },
        { text:'Piéger la violence (SOM/Mécanique DD12)', test:{stat:'SOM',skill:'Mecafortune',dc:12}, success:{ log:t('Toute capture brutale deviendra image floue. Fin élégante. '), goto:'END_C' }, failure:{ log:t('Coupe sombre. +1 Blessure.'), hp:-1, goto:'G5' } },
        { text:'S’éloigner en silence', goto:'END_D' }
      ]
    },

    G5:{ name:'Sous‑station T1 — Plans froissés', art:'t1', text:t(`Schémas scotchés au mur, odeur d’ozone. Le quartier ronfle en sourdine.`), choices:[
      { text:'Réessayer la Porte (si ratée)', goto:'G1' },
      { text:'Respirer, puis sortir', goto:'END_D' }
    ]},

    END_A:{ name:'Sortie — Porte Douce', art:'end', text:t(`Tu offres au quartier un passage qui n’accroche pas. Ce n’est pas héroïque. C’est utile.`), choices:[{text:'Rejouer', goto:'RESTART'}]},
    END_B:{ name:'Sortie — Pacte', art:'end', text:t(`Des numéros, des regards, des gestes. Quand tu passeras, on te laissera un bout de trottoir.`), choices:[{text:'Rejouer', goto:'RESTART'}]},
    END_C:{ name:'Sortie — Image Floue', art:'end', text:t(`Le bruit rebondira. La violence aussi. Pas de sang, juste du flou. Assez pour aujourd’hui.`), choices:[{text:'Rejouer', goto:'RESTART'}]},
    END_D:{ name:'Sortie — Reflux', art:'end', text:t(`Tu repars lentement, jurant dans ta barbe, mais plus droit que tout à l’heure.`), choices:[{text:'Rejouer', goto:'RESTART'}]}
  };

  // --------- DOM refs ---------
  const elStory=$('#story'), elChoices=$('#choices'), elStats=$('#stats'), elHUD=$('#hud'), elLog=$('#log'), elASCII=$('#ascii'), elArt=$('#art');
  const diceOverlay=$('#diceOverlay'), d1=$('#d1'), d2=$('#d2'), diceText=$('#diceText'), diceOk=$('#diceOk');
  const testPanel=$('#testPanel'), tpTitle=$('#tpTitle'), tpBadge=$('#tpBadge'), tpDC=$('#tpDC'), tpFlux=$('#tpFlux'), tpPush=$('#tpPush'), tpFrag=$('#tpFrag'), tpPreview=$('#tpPreview'), tpRoll=$('#tpRoll'), tpCancel=$('#tpCancel');

  // --------- UI helpers ---------
  function chip(label,content){return `<span class="chip"><span class=\"ghost\">${label}</span> ${content}</span>`}
  function bar(val,max){const pct=Math.max(0,Math.min(1,val/max));return `<span class="bar" style="width:120px"><i style="width:${pct*100}%"></i></span>`}
  function renderHUD(){ elHUD.innerHTML = chip('Stress',bar(state.stress,5))+chip('Blessures',bar(state.hp,5))+chip('Flux',`<strong>◆</strong> ${state.flux}`)+chip('Fragments',`<strong>✦</strong> ${state.fragments}`)+chip('Seed',`<span class='ghost'>${state.seed}</span>`); }
  function renderStats(){ const S=state.stats; const rows=[['NEU','Neuro',S.NEU,'neu'],['VOL','Volonté',S.VOL,'vol'],['SOM','Somatique',S.SOM,'som'],['CIN','Cinétique',S.CIN,'cin']].map(([abbr,name,val,cls])=>`<div class="stat ${cls}" aria-label="${name}"><div class="abbr">${abbr}</div><div><div class="name">${name}</div><div class="ghost" style="font-size:11px">${skillTips(abbr)}</div></div><div class="val">${val}</div></div>`).join(''); elStats.innerHTML=rows; }
  function skillTips(abbr){ switch(abbr){ case 'NEU': return 'Cryptanalyse • Déduction • Mnémographie'; case 'VOL': return 'Empathie • Intimidation calme • Vigilance'; case 'SOM': return 'Mécanique • Endurance • Résistance'; case 'CIN': return 'Furtivité • Réflexes • Corps‑à‑corps'; } }
  function renderMinimap(){ state.visited.forEach(id=>{ const n=$('#node-'+id); if(n) n.classList.add('visited'); }); const cur=$('#node-'+state.scene); if(cur) cur.classList.add('visited'); }
  function setArt(kind){ const url = IMG[kind]||IMG.start; elArt.innerHTML = `<img src="${url}" alt="scene art" loading="lazy"/>`; }

  // --------- ASCII HUD (par défaut) ---------
  let lastRollStr = '';
  function renderASCII(){ elASCII.classList.add('on'); const inv = state.inventory.join(' • ')||'—'; const sc=(SCENES[state.scene]||{}).name||state.scene; const a = state.archetype? ARCH[state.archetype].label : '—'; const tags = Object.keys(state.tags).filter(k=>state.tags[k]).join(', ')||'—'; const ascii = `
╔══════════[ ATH — ${a} ]═══════════════════════════════════╗
║ NEU ${state.stats.NEU}  VOL ${state.stats.VOL}  SOM ${state.stats.SOM}  CIN ${state.stats.CIN}
║ Stress: ${"█".repeat(state.stress)}${"░".repeat(5-state.stress)}   Bless: ${"█".repeat(state.hp)}${"░".repeat(5-state.hp)}   Flux: ${"◆".repeat(state.flux)}   Frag: ${"✦".repeat(state.fragments)}
║ Tags: ${tags}
║ Inv:  ${inv}
╟───────────────────────────────────────────────────────────╢
║ Scène: ${sc}
║ Carte: [Pont]─[Rue]─[Mazagran]─[Berges]─[T1]
╟───────────────────────────────────────────────────────────╢
║ Dernier jet: ${lastRollStr||'—'}
╚═══════════════════════════════════════════════════════════╝`; elASCII.textContent = ascii; }

  // --------- Save/Load ----------
  function autosave(){ if($('#t-autosave').checked){ localStorage.setItem('TRAME_GUILL_V4', JSON.stringify({...state, visited:[...state.visited]})); } }
  function exportSave(){ const blob = new Blob([localStorage.getItem('TRAME_GUILL_V4')||JSON.stringify({...state, visited:[...state.visited]})], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='trame_douce_guill_v4_save.json'; a.click(); URL.revokeObjectURL(url); }
  function importSave(){ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const data=JSON.parse(fr.result); Object.assign(state,data); state.visited=new Set(data.visited||[]); rng = mulberry32(state.seed||Date.now()); renderAll(); }catch(e){ alert('Sauvegarde invalide'); } }; fr.readAsText(f); }; inp.click(); }
  function restart(){ state.seed=Date.now(); rng=mulberry32(state.seed); Object.assign(state,{ scene:'START', visited:new Set(), stress:5, hp:5, flux:2, fragments:2, inventory:[], tags:{}, log:[], archetype:null, stats:{NEU:2,VOL:2,SOM:2,CIN:2} }); Object.keys(state.skills).forEach(k=> state.skills[k]=0); log('<span class="ghost">— Nouvelle run (Guill’) —</span>'); renderAll(); }

  // --------- Language filter (cru on/off) ---------
  function t(str){ return state && state.flags && state.flags.cru ? str : sanitize(str); }
  function sanitize(s){ return s.replace(/(emmerdes?|merde|con|fait chier)/gi, '—'); }

  // --------- Rendering ---------
  function renderScene(){ const sc=SCENES[state.scene]; if(!sc){ elStory.innerHTML = `<p class='ghost'>Scène inconnue: ${state.scene}</p>`; elChoices.innerHTML=''; return; } state.visited.add(state.scene); renderMinimap(); setArt(sc.art); elStory.innerHTML = `<h3 style="margin:0 0 8px 0">${sc.name}</h3><p>${sc.text}</p>`; elChoices.innerHTML=''; if(state.scene==='ARCH'){ renderArchetypeCards(); }
    (sc.choices||[]).forEach((ch,idx)=>{ if(ch.requireTag && !hasTag(ch.requireTag)) return; const btn=document.createElement('button'); btn.className='btn'; btn.setAttribute('role','option'); btn.innerHTML = `<span>${idx+1}. ${ch.text}</span>` + meta(ch); btn.addEventListener('click',()=>choose(ch)); elChoices.appendChild(btn); }); renderASCII(); autosave(); }

  function meta(ch){ const tags=[]; if(ch.test){ const {stat,skill,dc}=ch.test; const cls = stat.toLowerCase(); tags.push(`<span class='tag ${cls}'>${stat}/${prettySkill(skill)} DD${dc}</span>`); tags.push(`<span class='tag'>Modifs dans le panneau de test</span>`); } return `<span class='meta'>${tags.join('')}</span>` }
  function prettySkill(s){ return ({ Empathie:'Empathie', Intimidation:'Intimidation', Furtivite:'Furtivité', Cryptanalyse:'Cryptanalyse', Deduction:'Déduction', Mnemographie:'Mnémographie', Endurance:'Endurance', Resistance:'Résistance', Mecafortune:'Mécanique', Reflexes:'Réflexes', CAC:'Corps‑à‑corps' }[s]||s) }

  // Archetype selection
  function renderArchetypeCards(){ const wrap=document.createElement('div'); wrap.style.display='grid'; wrap.style.gridTemplateColumns='repeat(auto-fit,minmax(240px,1fr))'; wrap.style.gap='10px'; Object.entries(ARCH).forEach(([key,a])=>{ const card=document.createElement('div'); card.className='card'; card.dataset.key=key; card.innerHTML = `<div class='leftIcon'>${iconUser()}</div><div><div class='title'>${a.label}</div><div class='ghost'>${a.pitch}</div><div style='margin-top:6px' class='ghost'>NEU ${a.stats.NEU} • VOL ${a.stats.VOL} • SOM ${a.stats.SOM} • CIN ${a.stats.CIN}</div></div>`; card.addEventListener('click',()=>{ state.flags.pick=key; $$('.card').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); }); wrap.appendChild(card); }); elChoices.prepend(wrap); }
  function applyArchetype(){ const pick = state.flags.pick || 'ACCORDEUR'; const a=ARCH[pick]; if(!a) return; state.archetype=pick; state.stats={...a.stats}; Object.assign(state.skills,a.skills); a.startItems.forEach(addItem); log(`<span class='ok'>Archétype: ${a.label} — Atout: ${a.atout.name}</span>`); }

  // Choosing & tests
  function choose(ch){ if(ch.action==='applyArchetype'){ applyArchetype(); }
    if(!ch.test){ applyOutcome(ch); return; }
    openTestPanel(ch);
  }

  // ---- Test Panel flow ----
  let pendingTest = null; let pendingRoll = null;
  function openTestPanel(ch){ pendingTest = ch; const {stat,skill,dc}=ch.test; tpTitle.textContent = `Test ${stat}/${prettySkill(skill)}`; tpBadge.textContent = stat; tpBadge.className = `badge ${stat.toLowerCase()}`; tpDC.textContent = `DD ${dc}`; tpDC.className='tag'; tpFlux.checked=false; tpPush.checked=false; tpFrag.checked=false; updatePreview(); testPanel.style.display='block'; }
  function closeTestPanel(){ testPanel.style.display='none'; pendingTest=null; pendingRoll=null; }
  function updatePreview(){ if(!pendingTest) return; const {stat,skill,dc}=pendingTest.test; let mods=(state.stats[stat]||0)+(state.skills[skill]||0); let notes=[]; if(tpFlux.checked) notes.push('Flux +2'); if(tpPush.checked) notes.push('Pousser +2'); if(tpFrag.checked) notes.push('Fragment +2 (+1 Stress)'); const add=(tpFlux.checked?2:0)+(tpPush.checked?2:0)+(tpFrag.checked?2:0); const m=mods+add; tpPreview.innerHTML = `2d6 + <span style='color:#bde0fe'>${mods}</span> + <span style='color:#ffafcc'>${add}</span> = <strong>total</strong> vs DD ${dc}  <span class='ghost'>[${notes.join(' | ')||'—'}]</span>`; }
  tpFlux.addEventListener('change',updatePreview); tpPush.addEventListener('change',updatePreview); tpFrag.addEventListener('change',updatePreview);
  tpCancel.addEventListener('click', closeTestPanel);
  tpRoll.addEventListener('click', ()=>{ if(!pendingTest) return; rollAnimated().then(r=>{ pendingRoll = r; // apply through diceOk
    const {stat,skill,dc}=pendingTest.test; const add=(tpFlux.checked?2:0)+(tpPush.checked?2:0)+(tpFrag.checked?2:0); const mods=(state.stats[stat]||0)+(state.skills[skill]||0)+add; const total=r.sum+mods; const ok=total>=dc; lastRollStr = `${stat}/${prettySkill(skill)} DD${dc} — ${r.a}+${r.b}=${r.sum} + ${(mods>=0?'+':'')}${mods} = ${total} → ${ok?'OK':'KO'}${r.doubles?' (doubles)':''}`; renderASCII(); }); });

  // Dice animation (longer, manual apply)
  function rollAnimated(){ return new Promise(res=>{ let t=0; diceOverlay.style.display='flex'; d1.classList.add('rolling'); d2.classList.add('rolling'); beep(220,160); const iv=setInterval(()=>{ d1.textContent= Math.floor(Math.random()*6)+1; d2.textContent= Math.floor(Math.random()*6)+1; t+=100; }, state.flags.reduced? 180: 120); setTimeout(()=>{ clearInterval(iv); d1.classList.remove('rolling'); d2.classList.remove('rolling'); const r = roll2d6(); d1.textContent=r.a; d2.textContent=r.b; diceText.innerHTML = `Résultat: <strong>${r.a}</strong> + <strong>${r.b}</strong> = <strong>${r.sum}</strong>`; beep(300,160); diceOk.onclick = ()=>{ diceOverlay.style.display='none'; diceText.textContent=''; res(r); }; }, state.flags.reduced? 800: 1500); }); }

  // Apply outcome after diceOk pressed
  function applyOutcome(out){ if(out.log) log(out.log); if(out.stress) state.stress=clamp(state.stress+out.stress,0,5); if(out.hp) state.hp=clamp(state.hp+out.hp,0,5); if(out.flux) state.flux=Math.max(0,state.flux+out.flux); if(out.addItem) addItem(out.addItem); if(out.tag) state.tags[out.tag.k]=out.tag.v; if(out.flag) state.tags[out.flag.key]=out.flag.val; if(out.visit) state.visited.add(out.visit); if(out.goto){ if(out.goto==='RESTART'){ restart(); return; } state.scene=out.goto; }
    if(state.stress===0){ log('<span class="bad">STRESS 0 → arrêt doux. Tu te poses.</span>'); state.stress=3; }
    if(state.hp===0){ log('<span class="bad">BLESSURES 0 → corps dit non. Pause.</span>'); state.hp=3; }
    renderHUD(); renderScene(); renderASCII(); }

  // When dice resolved and we have a pending test, apply with mods from panel
  diceOk.addEventListener('click', ()=>{
    if(!pendingTest || !pendingRoll) return; const {stat,skill,dc}=pendingTest.test; const useFlux=tpFlux.checked; const push=tpPush.checked; const useFrag=tpFrag.checked; const add=(useFlux?2:0)+(push?2:0)+(useFrag?2:0); const mods=(state.stats[stat]||0)+(state.skills[skill]||0)+add; const total=pendingRoll.sum+mods; const ok = total>=dc; log(`Test ${stat}/${prettySkill(skill)} (DD${dc}) — ${pendingRoll.a}+${pendingRoll.b}=${pendingRoll.sum} + mods ${(mods>=0?'+':'')}${mods} = <strong>${total}</strong> → ${ok?'<span class="ok">Réussite</span>':'<span class="bad">Échec</span>'}${pendingRoll.doubles? ' <span class="ghost">(Doubles)</span>':''}`);
    if(useFlux) state.flux=Math.max(0,state.flux-1); if(useFrag){ state.fragments=Math.max(0,state.fragments-1); state.stress=Math.max(0,state.stress-1); }
    if(!ok && push){ state.stress=Math.max(0,state.stress-1); }
    const outcome = ok? pendingTest.success : pendingTest.failure; pendingTest=null; pendingRoll=null; applyOutcome(outcome); closeTestPanel(); });

  // Utils
  function hasTag(k){ return !!state.tags[k] || (k==='Quitus' && state.inventory.includes('Quitus de passage')); }
  function addItem(name){ if(!state.inventory.includes(name)) state.inventory.push(name); log(`<span class='ok'>+ Objet: ${name}</span>`); }
  function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
  function log(html){ state.log.push(html); const div=document.createElement('div'); div.className='entry'; div.innerHTML=html; elLog.prepend(div); }

  // Icons
  function iconUser(){ return `<svg viewBox='0 0 24 24' fill='none' stroke='#bde0fe' stroke-width='1.8'><circle cx='12' cy='8' r='4'/><path d='M4 20c2-3 6-4 8-4s6 1 8 4'/></svg>` }

  // Settings listeners
  $('#t-reduced').addEventListener('change',e=>{ state.flags.reduced=e.target.checked; document.body.style.scrollBehavior = state.flags.reduced? 'auto':'smooth'; });
  $('#t-ascii').addEventListener('change',e=>{ state.flags.ascii=e.target.checked; if(state.flags.ascii) renderASCII(); else elASCII.textContent=''; });
  $('#t-sound').addEventListener('change',e=>{ state.flags.sound=e.target.checked; if(state.flags.sound && ctx && ctx.state==='suspended'){ ctx.resume(); } });
  $('#t-cru').addEventListener('change',e=>{ state.flags.cru=e.target.checked; renderScene(); });
  $('#fontRange').addEventListener('input',e=>{ document.documentElement.style.setProperty('--fs', e.target.value); });
  $('#btn-save').addEventListener('click', exportSave);
  $('#btn-load').addEventListener('click', importSave);

  // Keyboard
  document.addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='h'){ const t=$('#t-ascii'); t.checked=!t.checked; state.flags.ascii=t.checked; if(state.flags.ascii) renderASCII(); else elASCII.textContent=''; return; } const n=parseInt(e.key,10); if(!isNaN(n)){ const btn=$('#choices').querySelectorAll('.btn')[n-1]; if(btn) btn.click(); }});

  // Initial render
  function renderAll(){ renderHUD(); renderStats(); renderMinimap(); renderScene(); }
  renderAll();
})();
</script>
</body>
</html>
