<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TRAME DOUCE — Guillotière (v6)</title>
<style>
:root{
  /* Pastel-punk retrofutur palette (élargie) */
  --bg:#0c0f14;
  --panel:#151a21;
  --panel-2:#0f131a;
  --ink:#d9e1f2;
  --muted:#9fb0c8;
  --line:#1f2733;
  --accent:#a4ffea; /* focus */
  --warn:#ffb770;
  --bad:#ff6b7a;
  --good:#79ffa5;
  --info:#76b7ff;

  /* Attributs */
  --neu:#77d1ff;
  --vol:#ff7aa8;
  --som:#ffc676;
  --cin:#9affc8;

  --btnGrad1:#1b2433;
  --btnGrad2:#283449;
  --btnBorder:#2f3e52;

  --pink:#ff8dd6;
  --mint:#9dfcd1;
  --cobalt:#7bb4ff;
  --amber:#ffc380;
  --vio:#c6a1ff;

  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{background:var(--bg);color:var(--ink);margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;line-height:1.5}
a{color:var(--accent)}
/* Layout */
.header{display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg, rgba(21,26,33,.95), rgba(21,26,33,.75));backdrop-filter: blur(8px);z-index:20}
.header .title{font-weight:700;letter-spacing:.4px}
.header .mode{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.tabbtn{padding:8px 12px;border:1px solid var(--btnBorder);background:linear-gradient(180deg,var(--btnGrad1),var(--btnGrad2));color:var(--ink);border-radius:10px;cursor:pointer;box-shadow:var(--shadow);font-weight:600;letter-spacing:.3px}
.tabbtn[aria-pressed="true"]{outline:2px solid var(--accent);text-shadow:0 0 6px var(--accent)}
.grid{display:grid;grid-template-columns:280px 1fr 360px;gap:16px;padding:14px;max-width:1400px;margin:auto}
.col{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;min-height:120px}
.col>.pad{padding:14px}
.sectionTitle{font-size:13px;letter-spacing:.2px;color:var(--muted);text-transform:uppercase;margin:0 0 8px 0}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--btnBorder);background:var(--panel-2);color:var(--muted)}
.row{display:flex;gap:8px;flex-wrap:wrap}
.stat{display:grid;grid-template-columns:36px 1fr 26px;align-items:center;background:var(--panel-2);border:1px solid var(--line);border-radius:10px;padding:8px;min-width:120px}
.stat .dot{width:22px;height:22px;border-radius:7px;filter: drop-shadow(0 4px 10px rgba(0,0,0,.4))}
.stat .name{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.stat .val{font-weight:800;text-align:right}
.stat.neu .dot{background:var(--neu)} .stat.neu .val{color:var(--neu)}
.stat.vol .dot{background:var(--vol)} .stat.vol .val{color:var(--vol)}
.stat.som .dot{background:var(--som)} .stat.som .val{color:var(--som)}
.stat.cin .dot{background:var(--cin)} .stat.cin .val{color:var(--cin)}

.resbar{display:flex;gap:8px}
.resbar .res{flex:1;background:var(--panel-2);border:1px solid var(--line);border-radius:10px;overflow:hidden}
.resbar .res .lbl{font-size:12px;color:var(--muted);padding:6px 8px;border-bottom:1px solid var(--line)}
.resbar .meter{height:6px;background:var(--line)}
.resbar .fill{height:6px;background:linear-gradient(90deg,var(--mint),var(--cobalt))}
.resbar .fill.bad{background:linear-gradient(90deg,var(--bad),var(--amber))}

/* Story column */
.storyTop{display:flex;flex-direction:column;gap:10px}
.storyImage{position:relative;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#0a0e13}
.storyImage img{display:block;width:100%;height:220px;object-fit:cover;filter: contrast(1.05) saturate(1.05) brightness(.9)}
.storyImage .legend{position:absolute;left:10px;bottom:10px;background:rgba(10,14,19,.7);padding:6px 8px;border-radius:8px;font-size:12px;color:var(--muted);backdrop-filter: blur(2px);border:1px solid var(--line)}

.storyBody{background:var(--panel-2);border:1px solid var(--line);border-radius:14px;padding:16px}
.storyBody h2{margin:0 0 6px 0;font-size:20px;letter-spacing:.3px}
.storyBody p{margin:.5em 0}
.choices{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.choice{position:relative;border:1px solid var(--btnBorder);background:linear-gradient(180deg,var(--btnGrad1),var(--btnGrad2));padding:10px 12px;border-radius:12px;cursor:pointer}
.choice:hover{outline:2px solid var(--accent)}
.choice small{display:block;color:var(--muted)}
.choice .tags{position:absolute;right:8px;top:8px;display:flex;gap:6px;flex-wrap:wrap}
.tag{padding:2px 6px;border-radius:999px;border:1px solid var(--line);font-size:11px;background:rgba(255,255,255,.03)}
.tag.neu{color:var(--neu);border-color:var(--neu)}
.tag.vol{color:var(--vol);border-color:var(--vol)}
.tag.som{color:var(--som);border-color:var(--som)}
.tag.cin{color:var(--cin);border-color:var(--cin)}
.tag.good{color:var(--good);border-color:var(--good)}
.tag.bad{color:var(--bad);border-color:var(--bad)}
/* Active test panel */
.testPanel{margin-top:12px;border:1px dashed var(--btnBorder);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.02)}
.testPanel .row{align-items:center}
.testBtn{margin-left:auto}
.btn{padding:10px 12px;border:1px solid var(--btnBorder);background:linear-gradient(180deg,var(--btnGrad1),var(--btnGrad2));border-radius:10px;color:var(--ink);cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.primary{outline:2px solid var(--accent)}
.btn.danger{outline:2px solid var(--bad)}

.ascii{font-family:"JetBrains Mono","SFMono-Regular",Menlo,Consolas,monospace;font-size:12px;background:#0b0f15;border:1px solid var(--line);border-radius:12px;padding:10px;white-space:pre-wrap;color:#b9c7da}
/* Right column (Journal) */
.log{height:420px;overflow:auto;background:var(--panel-2);border:1px solid var(--line);border-radius:12px;padding:10px}
.log .line{padding:6px 0;border-bottom:1px dashed var(--line);font-size:13px}
.small{font-size:12px;color:var(--muted)}
/* Objective Journal */
.timeline{height:180px;overflow:auto;background:var(--panel-2);border:1px solid var(--line);border-radius:12px;padding:10px}
.timeline .item{margin:4px 0;padding:8px;border-left:3px solid var(--accent);background:rgba(255,255,255,.02);border-radius:8px}
.timeline .item .when{color:var(--muted);font-size:12px}

.footer{padding:10px;color:var(--muted);text-align:center}

/* Dice overlay */
#diceOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99}
.diceWrap{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow);min-width:300px;text-align:center}
.cubes{display:flex;gap:16px;justify-content:center;margin:10px 0 4px 0}
.cube{width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg,#1b2330,#0b1017);border:1px solid #273243;display:grid;place-items:center;font-size:40px;color:#fff;filter: drop-shadow(0 6px 18px rgba(0,0,0,.5))}
.anim{animation:roll 1s ease-in-out infinite}
@keyframes roll{
  0%{transform:rotate(0) translateY(0)}
  33%{transform:rotate(13deg) translateY(-8px)}
  66%{transform:rotate(-9deg) translateY(4px)}
  100%{transform:rotate(0) translateY(0)}
}

/* Archetype modal */
#archeModal{position:fixed;inset:0;background:rgba(10,14,19,.88);display:flex;align-items:center;justify-content:center;z-index:101}
.arches{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;max-width:1100px;margin:14px}
.arch{border:2px solid var(--btnBorder);background:linear-gradient(180deg,#141a23,#0e141c);border-radius:14px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column}
.arch img{width:100%;height:140px;object-fit:cover;filter:grayscale(.1) contrast(1.1)}
.arch .pad{padding:12px}
.arch h3{margin:0 0 6px 0;letter-spacing:.3px}
.arch p{margin:.4em 0;color:var(--muted);font-size:13px}
.arch .tags{padding:0 12px 12px 12px;margin-top:auto}
.arch[aria-selected="true"]{outline:3px solid var(--accent);box-shadow:0 0 0 4px rgba(164,255,234,.15) inset}
.arch .statrow{display:flex;gap:8px;padding:0 12px 12px 12px}
.arch .b{border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
.arch .b.neu{color:var(--neu);border-color:var(--neu)}
.arch .b.vol{color:var(--vol);border-color:var(--vol)}
.arch .b.som{color:var(--som);border-color:var(--som)}
.arch .b.cin{color:var(--cin);border-color:var(--cin)}
.modalBox{background:var(--panel);border:1px solid var(--line);padding:16px;border-radius:16px;max-width:1200px;width:95%;box-shadow:var(--shadow)}
.modalBox h2{margin:0 0 8px 0}
.modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

/* Tabs visibility */
[data-view="all"] .left{display:block}
[data-view="all"] .right{display:block}
[data-view="story"] .left{display:none}
[data-view="story"] .right{display:none}
[data-view="profile"] .mid{display:none}
[data-view="profile"] .right{display:none}
[data-view="journal"] .left{display:none}
[data-view="journal"] .mid{display:none}

@media (max-width:1080px){
  .grid{grid-template-columns:1fr;gap:10px}
  .log{height:260px}
  .timeline{height:150px}
}
</style>
</head>
<body data-view="all">
  <header class="header">
    <div class="title">⟡ TRAME DOUCE — <span id="loc">Guillotière</span></div>
    <div class="row">
      <span class="badge">Stress <span id="stressVal">5</span>/5</span>
      <span class="badge">Blessures <span id="hpVal">5</span>/5</span>
      <span class="badge">Flux ◆ <span id="fluxVal">2</span></span>
      <span class="badge">Fragments ✦ <span id="fragVal">2</span></span>
    </div>
    <div class="mode">
      <button class="tabbtn" onclick="setView('all')" aria-pressed="true">Tous</button>
      <button class="tabbtn" onclick="setView('story')">Histoire</button>
      <button class="tabbtn" onclick="setView('profile')">Profil</button>
      <button class="tabbtn" onclick="setView('journal')">Journal</button>
      <button class="tabbtn" onclick="toggleAscii()" id="asciiBtn">HUD ASCII ✓</button>
    </div>
  </header>
  <main class="grid">
    <aside class="col left">
      <div class="pad">
        <div class="sectionTitle">Profil</div>
        <div class="row" id="statsRow"></div>
        <div style="height:10px"></div>
        <div class="resbar">
          <div class="res"><div class="lbl">Stress</div><div class="meter"><div class="fill bad" id="stressFill" style="width:100%"></div></div></div>
          <div class="res"><div class="lbl">Blessures</div><div class="meter"><div class="fill bad" id="hpFill" style="width:100%"></div></div></div>
        </div>
        <div style="height:10px"></div>
        <div class="sectionTitle">Mini-carte</div>
        <div class="ascii" id="miniMap"></div>
        <div style="height:10px"></div>
        <div class="sectionTitle">Réglages</div>
        <div class="row">
          <button class="btn" onclick="toggleReduceAnim()">Réduire anim.</button>
          <button class="btn" onclick="toggleCrude()">Langage cru</button>
          <button class="btn" onclick="exportSave()">Export</button>
          <button class="btn" onclick="importSave()">Import</button>
        </div>
      </div>
      <div class="pad">
        <div class="sectionTitle">HUD ASCII</div>
        <div class="ascii" id="asciiHud"></div>
      </div>
    </aside>

    <section class="col mid">
      <div class="pad storyTop">
        <div class="storyImage">
          <img id="storyImg" src="https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop" alt="Visuel d'ambiance post-apo à la Guillotière">
          <div class="legend" id="imgLegend">Guillotière — Nuit en pente fine</div>
        </div>
        <div class="row">
          <span class="badge">Objectif: <span id="objectiveText">Comprendre la Sourdine et trouver une entrée vers la sous-station T1.</span></span>
        </div>
        <div class="storyBody">
          <h2 id="storyTitle">Prologue — La Sourdine</h2>
          <div id="storyText"></div>
          <div class="choices" id="choices"></div>

          <div class="testPanel" id="testPanel" style="display:none">
            <div class="row">
              <div><span class="badge">Test: <span id="testName">—</span></span></div>
              <div><span class="badge">DD <span id="testDD">10</span></span></div>
              <div style="margin-left:auto"></div>
            </div>
            <div class="row" style="align-items:center;margin-top:6px">
              <label class="badge"><input type="checkbox" id="useFlux"> +2 Flux</label>
              <label class="badge"><input type="checkbox" id="usePush"> +2 Pousser sa chance</label>
              <label class="badge"><input type="checkbox" id="useFrag"> ✦ Fragment (indice fort, +1 Stress)</label>
              <button class="btn primary testBtn" id="rollBtn">Lancer les dés</button>
            </div>
            <div class="small" id="testHint"></div>
          </div>
        </div>
      </div>
    </section>

    <aside class="col right">
      <div class="pad">
        <div class="sectionTitle">Journal des dés</div>
        <div class="log" id="log"></div>
        <div style="height:10px"></div>
        <div class="sectionTitle">Journal d’objectifs</div>
        <div class="timeline" id="timeline"></div>
      </div>
    </aside>
  </main>

  <div id="diceOverlay">
    <div class="diceWrap">
      <div class="small">2d6 — maintiens pour voir l’animation</div>
      <div class="cubes">
        <div class="cube anim" id="d1">•</div>
        <div class="cube anim" id="d2">•</div>
      </div>
      <div class="row" style="justify-content:center">
        <button class="btn primary" onclick="stopDice()">Arrêter</button>
      </div>
      <div class="small" id="diceInfo"></div>
    </div>
  </div>

  <!-- Archetype selection modal -->
  <div id="archeModal" role="dialog" aria-modal="true">
    <div class="modalBox">
      <h2>Choisis ton archétype</h2>
      <div class="arches" id="archList"></div>
      <div class="modalActions">
        <button class="btn" onclick="randomArch()">Au hasard</button>
        <button class="btn primary" id="confirmArch" disabled>Valider</button>
      </div>
    </div>
  </div>

<script>
/* ------------------ DATA ------------------ */
const ARCHETYPES = [
  {
    id:'noor',
    name:'Noor — Dormeuse du pont',
    img:'https://images.unsplash.com/photo-1500099817043-86d46000d58f?q=80&w=1400&auto=format&fit=crop',
    back:'Tu dors sous le tablier quand il fait doux. Tu sais disparaître dans le décor, et écouter quand les autres parlent trop.',
    stats:{NEU:2,VOL:3,SOM:1,CIN:3},
    skills:{Empathie:1,Furtivite:1},
    atout:'Ombre tranquille (1 interaction furtive traitée comme facile / scène)',
    startInv:['Feuillet-mica frotté','Cutter','Gants usés']
  },
  {
    id:'milo',
    name:'Milo — Revendeur d’appoint',
    img:'https://images.unsplash.com/photo-1553867745-e018f36c1f42?q=80&w=1400&auto=format&fit=crop',
    back:'Tu fais tourner des “services” : piles refondues, médocs, rumeurs. Tu parles cash, tu sens la merde à quinze mètres.',
    stats:{NEU:3,VOL:3,SOM:1,CIN:2},
    skills:{Intimidation:1,Deduction:1},
    atout:'Filon (1 négociation traitée comme facile / scène)',
    startInv:['Lampe plate','Note marquée','Briquet']
  },
  {
    id:'rayan',
    name:'Rayan — Électricien clandestin',
    img:'https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=1400&auto=format&fit=crop',
    back:'Tu connais les coffrets, les faux-plombs, les gaines qui chantent. Tu parles au cuivre comme à un gosse têtu.',
    stats:{NEU:3,VOL:2,SOM:3,CIN:2},
    skills:{Mecanique:1,Cryptanalyse:1},
    atout:'Atelier mobile (+2 au 1er test mécanique de la scène)',
    startInv:['Tournevis isolé','Aimant-alu','Ruban textile']
  }
];

const IMAGES = {
  prologue:{
    src:'https://images.unsplash.com/photo-1529101091764-c3526daf38fe?q=80&w=1400&auto=format&fit=crop',
    legend:'Souterrain — goutte à goutte régulier'
  },
  place:{
    src:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop',
    legend:'Place du Pont — pluie sur bitume'
  },
  mazagran:{
    src:'https://images.unsplash.com/photo-1519681395355-94c6f1e1b6a7?q=80&w=1400&auto=format&fit=crop',
    legend:'Friche Mazagran — murs qui boivent'
  },
  berges:{
    src:'https://images.unsplash.com/photo-1513506003901-1e6a229e2d15?q=80&w=1400&auto=format&fit=crop',
    legend:'Berges — darses envasées'
  },
  pont:{
    src:'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1400&auto=format&fit=crop',
    legend:'Pont de la Guill’ — courant bas'
  },
  t1:{
    src:'https://images.unsplash.com/photo-1517511620798-cec17d428bc0?q=80&w=1400&auto=format&fit=crop',
    legend:'Sous-station T1 — panneaux griffés'
  }
};

const STATE = {
  arch:null,
  stats:{NEU:2,VOL:2,SOM:2,CIN:2},
  skills:{},
  stress:5, hp:5, flux:2, frag:2,
  crude:false, ascii:true, reduceAnim:false,
  tags:new Set(), inventory:[],
  objective:'Comprendre la Sourdine et trouver une entrée vers la sous-station T1.',
  objectives:[], // journal
  scene:'prologue',
  miniRoute:'', // 'noor'|'milo' exclusive paths
  lastRoll:null,
  usedSceneBuff:false
};

/* ------------------ HELPERS ------------------ */
function el(q){return document.querySelector(q)}
function addLog(text){ const L=el('#log'); const d=document.createElement('div'); d.className='line'; d.textContent=text; L.prepend(d) }
function addObjective(text){ STATE.objectives.push({t:Date.now(),text}); renderTimeline(); }
function formatWhen(t){ const d=new Date(t); return d.toLocaleTimeString() }
function setView(v){
  document.body.setAttribute('data-view', v);
  document.querySelectorAll('.tabbtn').forEach(b=>b.setAttribute('aria-pressed', b.textContent.toLowerCase().includes(v)==true || (v==='all'&&b.textContent==='Tous') ? 'true':'false'));
}
function toggleAscii(){ STATE.ascii=!STATE.ascii; renderAscii(); el('#asciiBtn').textContent = 'HUD ASCII ' + (STATE.ascii?'✓':'✗'); }
function toggleReduceAnim(){ STATE.reduceAnim=!STATE.reduceAnim; addLog('Animations '+(STATE.reduceAnim?'réduites':'normales')) }
function toggleCrude(){ STATE.crude=!STATE.crude; addLog('Langage '+(STATE.crude?'cru':'sobre')) }
function updateBars(){
  el('#stressVal').textContent=STATE.stress; el('#hpVal').textContent=STATE.hp;
  el('#fluxVal').textContent=STATE.flux; el('#fragVal').textContent=STATE.frag;
  el('#stressFill').style.width=(STATE.stress/5*100)+'%';
  el('#hpFill').style.width=(STATE.hp/5*100)+'%';
}
function renderStats(){
  const row=el('#statsRow'); row.innerHTML='';
  const S=STATE.stats;
  const mk=(cls,name,val)=> `<div class="stat ${cls}"><div class="dot"></div><div class="name">${name}</div><div class="val">${val}</div></div>`;
  row.insertAdjacentHTML('beforeend', mk('neu','Neuro',S.NEU));
  row.insertAdjacentHTML('beforeend', mk('vol','Volonté',S.VOL));
  row.insertAdjacentHTML('beforeend', mk('som','Somatique',S.SOM));
  row.insertAdjacentHTML('beforeend', mk('cin','Cinétique',S.CIN));
}
function renderAscii(){
  const hud=el('#asciiHud'); const map=el('#miniMap');
  if(!STATE.ascii){ hud.textContent='(désactivé)'; map.textContent='(désactivé)'; return; }
  const tags=[...STATE.tags].join(', ')||'—';
  hud.textContent =
`╔══[ ATH ]════════════════════════════════════════╗
║ ${STATE.arch?STATE.arch.name:'—'} 
║ NEU ${STATE.stats.NEU}  VOL ${STATE.stats.VOL}  SOM ${STATE.stats.SOM}  CIN ${STATE.stats.CIN}
║ Stress ${'█'.repeat(STATE.stress)}${'░'.repeat(5-STATE.stress)}  Bless ${'█'.repeat(STATE.hp)}${'░'.repeat(5-STATE.hp)}
║ Flux ◆${STATE.flux}  Frag ✦${STATE.frag}  Tags: ${tags}
║ Inv: ${STATE.inventory.join(' • ')||'—'}
║ Scène: ${STATE.scene}  Route: ${STATE.miniRoute||'—'}
║ Dernier jet: ${STATE.lastRoll||'—'}
╚══════════════════════════════════════════════════╝`;
  map.textContent =
`[Mini-carte — Guill']
┌ Place du Pont ─── Friche Mazagran
│        └── Berges/Darses ─── Pont ─── Sous-station T1
└ Prologue (tu es ici → ${STATE.scene})`;
}
function renderTimeline(){
  const T=el('#timeline'); T.innerHTML='';
  STATE.objectives.slice().reverse().forEach(o=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<div>${o.text}</div><div class="when">${formatWhen(o.t)}</div>`;
    T.appendChild(d);
  });
}

/* ------------------ SCENES ------------------ */
const SCENES = {
  prologue:{
    title:"Prologue — La Sourdine",
    img:IMAGES.prologue,
    text:()=>`
<p>On appelle ça <b>la Sourdine</b>. Les sons tirent vers le bas, les cris meurent, les moteurs font semblant.
Les souvenirs récents se délitent si on ne les plaque pas quelque part. Tu portes sur toi un feuillet-mica pour fixer le présent.</p>
<p>Tu te réveilles sous un auvent, côté <b>Place du Pont</b>. Ça sent la pluie sur la poussière et la graisse froide. 
Trois messages griffés sur une boîte aux lettres : <i>« T1 a faim »</i>, <i>« Chercher Noor »</i>, <i>« Milo sait »</i>.</p>
<p>La sous-station <b>T1</b> maintient un filet d’électricité dans le quartier. Si elle crève, la nuit sera longue — trop longue. Tu as besoin d’une <b>route</b>.</p>
`,
    choices:[
      {label:"Chercher Noor — la dormeuse du pont", hint:"Route planquée (furtivité)", tags:['route_noor'], go:'place_noor'},
      {label:"Trouver Milo — revendeur d’appoint", hint:"Passe-droit (négociation)", tags:['route_milo'], go:'place_milo'},
      {label:"Observer seul·e les sorties vers T1", hint:"Lire les flux (neutre)", tags:[], go:'place_solo'}
    ]
  },

  place_noor:{
    title:"Place du Pont — Noor",
    img:IMAGES.place,
    text:()=>`
<p>Noor fume sous une bâche. Elle te jauge, pas dupe. 
<b>${STATE.crude?'« T’as une sale gueule »':'« Tu tires la tronche »'}</b>, dit-elle. 
Tu souris sans dents.</p>
<p>Elle sait descendre par les caves, passer sous les cages d’escalier, longer les tuyaux tièdes. 
Mais elle demande un échange : <i>tu l’aides à récupérer son sac</i> laissé à <b>Mazagran</b>.</p>`,
    choices:[
      {label:"Accepter — récupérer le sac à Mazagran", hint:"+ Tag Route_NoOr | +Objectif", tags:['Route_NoOr'], go:'mazagran_noor'},
      {label:"Refuser — elle te file quand même un conseil", hint:"Indice mineur vers Berges", tags:[], go:'place_common'}
    ]
  },

  place_milo:{
    title:"Place du Pont — Milo",
    img:IMAGES.place,
    text:()=>`
<p>Milo tient un sac de câbles et de rumeurs. 
<b>${STATE.crude?'« Faut payer ou rendre service »':'« Rien n’est gratuit »'}</b>. 
Il peut te faire passer les contrôles sur le pont, mais il veut un “dépôt” : un petit coffret au nom effacé à récupérer à <b>Mazagran</b>.</p>`,
    choices:[
      {label:"Prendre le job — coffret pour Milo", hint:"+ Tag Route_Milo | +Objectif", tags:['Route_Milo'], go:'mazagran_milo'},
      {label:"L’envoyer se faire voir — partir seul·e", hint:"Tu gardes ton souffle. Pas de passe-droit.", tags:[], go:'place_common'}
    ]
  },

  place_solo:{
    title:"Place du Pont — Lire la foule",
    img:IMAGES.place,
    text:()=>`
<p>Tu restes assis·e dix minutes et la ville te parle — par les sacs qui frottent, les vélos qui choisissent l’ombre, les voix qui peinent.</p>
<p>Flux stable vers <b>Mazagran</b>, reflux nerveux vers les <b>Berges</b>. T1 est au bout du fil — quelque part sous la ligne du tram.</p>`,
    choices:[
      {label:"Suivre le flux — aller à Mazagran", hint:"Point de départ classique", tags:[], go:'mazagran_common'},
      {label:"Forcer la chance — filer aux Berges direct", hint:"Plus risqué mais plus court", tags:['HardWay'], go:'berges_entry'}
    ]
  },

  place_common:{
    title:"Place du Pont — Route hésitante",
    img:IMAGES.place,
    text:()=>`<p>Tu prends quand même la direction de <b>Mazagran</b>. La pluie fait des fils sur les capuches. Les portes parlent bas.</p>`,
    choices:[{label:"Aller à Mazagran", hint:"", tags:[], go:'mazagran_common'}]
  },

  mazagran_common:{
    title:"Friche Mazagran — Cour intérieure",
    img:IMAGES.mazagran,
    text:()=>`
<p>Des plantes grasses survivantes mordent des murs couleur gorge. Un conteneur sert d’atelier. 
Une porte basse mène à une cave poussiéreuse.</p>
<p>Sur l’établi : un <b>feuillet-mémoire</b> partiellement lisible. En bas de l’escalier, un <b>coffret anonyme</b>.</p>`,
    choices:[
      {label:"Lire le feuillet", hint:"NEU/Mnémographie (10) → indice vers Berges", test:{stat:'NEU',skill:'Mnémographie',dd:10,
        onSuccess:(S)=>{S.tags.add('Motif_R'); addLog('Tu captes un motif retourné → Berges.'); addObjective('Indice décodé: passer par les darses.');},
        onFail:(S)=>{S.stress=Math.max(0,S.stress-1); addLog('Migraine douce. +1 Stress.');}
      }},
      {label:"Prendre le coffret", hint:"+ Objet Coffret (scellé)", immediate:(S)=>{S.inventory.push('Coffret scellé'); addObjective('Coffret récupéré à Mazagran.');}},
      {label:"Descendre vers les Berges", hint:"Route neutre", go:'berges_entry'}
    ]
  },

  mazagran_noor:{
    title:"Mazagran — Le sac de Noor",
    img:IMAGES.mazagran,
    text:()=>`
<p>Le sac est coincé derrière un banc scellé. Ça sent la lessive vieille et le plastique mouillé.</p>
<p>Noor veut récupérer des papiers et un flacon bleu. Tu peux forcer, ou passer par la cave pour sortir derrière.</p>`,
    choices:[
      {label:"Forcer le banc", hint:"SOM/Mécanique (12) → + sac; échec +1 Blessure", test:{stat:'SOM',skill:'Mécanique',dd:12,
        onSuccess:(S)=>{addLog('Le banc cède. Tu récupères le sac.'); S.tags.add('Noor_Sac'); addObjective('Tu as récupéré le sac de Noor.');},
        onFail:(S)=>{S.hp=Math.max(0,S.hp-1); addLog('Tu t’écorches profondément. +1 Blessure.');}
      }},
      {label:"Passer par la cave", hint:"CIN/Furtivité (10) → + sortie discrète", test:{stat:'CIN',skill:'Furtivité',dd:10,
        onSuccess:(S)=>{S.tags.add('Sortie_Discrète'); addLog('Tu sors derrière, personne t’a vu.');},
        onFail:(S)=>{addLog('Une lampe tombe. Bruit mou. Rien de grave.');}
      }},
      {label:"Partir sans sac", hint:"Noor t’en voudra", go:'berges_entry'}
    ]
  },

  mazagran_milo:{
    title:"Mazagran — Le coffret de Milo",
    img:IMAGES.mazagran,
    text:()=>`
<p>Le coffret est là, sanglé. Sceau cassé — pas par toi. À l’intérieur: une carte fine et une <b>note très sèche</b> : 
${STATE.crude?'« Tu me dois un passage. »':'« Passage dû. »'}</p>`,
    choices:[
      {label:"Prendre le coffret (scellé)", hint:"Utile au Pont", immediate:(S)=>{S.inventory.push('Coffret (pour Milo)'); S.tags.add('Coffret_Milo'); addObjective('Coffret pour Milo en poche.');}},
      {label:"Descendre vers les Berges", hint:"Route Milo facilitée plus tard", go:'berges_entry'}
    ]
  },

  berges_entry:{
    title:"Berges — Darses",
    img:IMAGES.berges,
    text:()=>`
<p>Le fleuve a l’air fatigué. La vase garde les secrets sous une peau mince. 
Une barge fantôme cogne doucement une échelle. Tu distingues les accès vers le <b>Pont</b> et une trappe technique.</p>`,
    choices:[
      {label:"Prendre la trappe technique", hint:"NEU/Cryptanalyse (10) → accès vers T1 (Noor route+)", test:{stat:'NEU',skill:'Cryptanalyse',dd:10,
        onSuccess:(S)=>{S.tags.add('Acces_Tech'); S.miniRoute = S.tags.has('Route_NoOr')||S.tags.has('Noor_Sac')?'noor':S.miniRoute; addLog('La trappe chante et s’ouvre.'); addObjective('Accès technique ouvert vers T1.');},
        onFail:(S)=>{addLog('Contact oxydé. Tu retentes plus tard.');}
      }},
      {label:"Remonter vers le Pont", hint:"Si Coffret_Milo → passe-droit", go:'pont_path'}
    ]
  },

  pont_path:{
    title:"Pont de la Guill’ — Passage",
    img:IMAGES.pont,
    text:()=>`
<p>Deux silhouettes contrôlent vaguement qui passe. Elles te regardent comme on regarde la pluie : sans envie.</p>
<p>${STATE.tags?.has('Coffret_Milo')?'<b>Le nom de Milo fait son effet.</b> Tu ne t’attardes pas.':'Sans passe, tu vas devoir jouer fin ou ruser.'}</p>`,
    choices:()=>{
      const arr=[];
      if(STATE.tags.has('Coffret_Milo')){
        arr.push({label:"Passer sans histoire", hint:"+1 Stress retiré", immediate:(S)=>{S.stress=Math.min(5,S.stress+0); addLog('On te laisse filer.');}, go:'t1_entry'})
      }else{
        arr.push({label:"Parler franc et sec", hint:"VOL/Intimidation (10) → laisser-passer", test:{stat:'VOL',skill:'Intimidation',dd:10,
          onSuccess:(S)=>{addLog('Ça passe. Pas envie d’emmerdes.');}, onFail:(S)=>{S.stress=Math.max(0,S.stress-1); addLog('Tension. +1 Stress.')}}, go:'t1_entry'});
        arr.push({label:"Raser les barrières", hint:"CIN/Furtivité (12) → passer sans bruit", test:{stat:'CIN',skill:'Furtivité',dd:12,
          onSuccess:(S)=>{addLog('Tu glisses comme une ombre.');}, onFail:(S)=>{S.stress=Math.max(0,S.stress-1); addLog('On te voit, tu forces, ça passe. +1 Stress.')}}, go:'t1_entry'});
      }
      return arr;
    }
  },

  t1_entry:{
    title:"Sous-station T1 — Plans froissés",
    img:IMAGES.t1,
    text:()=>`
<p>Schémas scotchés au mur. Quelqu’un a noté : « la douceur est une technologie. »</p>
<p>La porte principale hésite. Un accoudoir de métal froid plante dans la paume. 
Au fond, une grille basse retourne l’air chaud vers un tunnel.</p>`,
    choices:[
      {label:"Réessayer la porte (si ratée)", hint:"NEU/Cryptanalyse (12)", test:{stat:'NEU',skill:'Cryptanalyse',dd:12,
        onSuccess:(S)=>{S.tags.add('T1_Ouverte'); addLog('La serrure accepte ta main.'); addObjective('Porte T1 ouverte.');}, onFail:(S)=>{S.stress=Math.max(0,S.stress-1); addLog('La note fausse se tait. +1 Stress.');}}},
      {label:"Passer par la grille", hint:"CIN/Furtivité (10)", test:{stat:'CIN',skill:'Furtivité',dd:10,
        onSuccess:(S)=>{S.tags.add('T1_Grille'); addObjective('Tu t’infiltres par le bas.');}, onFail:(S)=>{addLog('Une vis tinte. Tu t’arrêtes.')}},
      {label:"Si Noor_Sac → elle t’ouvre de l’intérieur", hint:"Route exclusive Noor", when:()=>STATE.tags.has('Noor_Sac'), immediate:(S)=>{S.tags.add('Noor_Trust'); addObjective('Noor te doit une. Porte entrouverte.');}, go:'t1_core'}
    ]
  },

  t1_core:{
    title:"Sous-station T1 — Cœur",
    img:IMAGES.t1,
    text:()=>`
<p>Un bourdonnement bas, comme une gorge qui racle doucement. L’alimentation tient par un fil.</p>
<p>Le tableau principal affiche trois options bricolées à la main : <b>Contournement</b>, <b>Relance</b>, <b>Trame douce</b>.</p>`,
    choices:[
      {label:"Contournement — gagner du temps", hint:"SOM/Mécanique (10) → +1 Flux, quartier tient la nuit", test:{stat:'SOM',skill:'Mécanique',dd:10,
        onSuccess:(S)=>{S.flux=Math.max(0,S.flux+1); addObjective('Contournement posé. La nuit sera tiède.');},
        onFail:(S)=>{S.hp=Math.max(0,S.hp-1); addLog('Coup de jus. +1 Blessure.');}}},
      {label:"Relance — plus risqué", hint:"NEU/Déduction (12) → allume fort mais attire l’attention", test:{stat:'NEU',skill:'Déduction',dd:12,
        onSuccess:(S)=>{S.tags.add('Relance'); addObjective('Relance OK. Lumière plus vive dans la Guill’.');},
        onFail:(S)=>{S.stress=Math.max(0,S.stress-1); addLog('Tu recules. +1 Stress.');}}},
      {label:"Trame douce — réduire l’oubli local", hint:"VOL/Empathie (12) + ✦ → protège les mémoires 24h", test:{stat:'VOL',skill:'Empathie',dd:12, needsFrag:true,
        onSuccess:(S)=>{S.tags.add('Trame_Douce'); addObjective('Tu tires un voile. Les souvenirs tiennent.'); S.frag=Math.max(0,S.frag-1);},
        onFail:(S)=>{addLog('Tu n’oses pas appuyer. Rien ne casse.');}}}
    ]
  }
};

/* ------------------ RENDER ------------------ */
function renderScene(){
  const sc=SCENES[STATE.scene];
  if(!sc) return;
  el('#storyTitle').textContent = sc.title;
  el('#storyText').innerHTML = sc.text?sc.text():'';
  const img = sc.img || IMAGES.place;
  el('#storyImg').src = img.src; el('#imgLegend').textContent = img.legend || '';
  const box = el('#choices'); box.innerHTML='';
  let choices = typeof sc.choices==='function' ? sc.choices() : sc.choices;
  choices.forEach((c,i)=>{
    if(c.when && !c.when()) return;
    const div = document.createElement('div'); div.className='choice';
    let tagBadges = (c.tags||[]).map(t=>`<span class="tag good">${t}</span>`).join('');
    const testTags = c.test ? `<span class="tag ${attrColor(c.test.stat)}">${c.test.stat}</span>`+`<span class="tag">${c.test.skill||''}</span>`+`<span class="tag">${'DD '+c.test.dd}</span>` : '';
    div.innerHTML = `<strong>${i+1}. ${c.label}</strong><small>${c.hint||''}</small>
    <div class="tags">${tagBadges}${testTags}</div>`;
    div.addEventListener('click',()=>onChoice(c));
    box.appendChild(div);
  });
  renderAscii(); updateBars(); renderStats();
  el('#objectiveText').textContent = STATE.objective;
}

function attrColor(stat){
  if(stat==='NEU') return 'neu';
  if(stat==='VOL') return 'vol';
  if(stat==='SOM') return 'som';
  if(stat==='CIN') return 'cin';
  return '';
}

let pendingTest=null;
function onChoice(c){
  if(c.immediate){ c.immediate(STATE); }
  if(c.go && !c.test){ STATE.scene=c.go; addObjective('Déplacement: '+SCENES[c.go].title); save(); renderScene(); return; }
  if(c.test){
    pendingTest = c;
    showTest(c);
  }
}

function showTest(c){
  el('#testPanel').style.display='block';
  el('#testName').textContent = `${c.test.stat}/${c.test.skill||'-'}`;
  el('#testDD').textContent = c.test.dd;
  const hint = `Bonus dispos: Flux=${STATE.flux}  Frag=${STATE.frag}.` + (c.test.needsFrag?' (nécessite 1 ✦)':'');
  el('#testHint').textContent = hint;
  el('#useFlux').checked=false; el('#usePush').checked=false; el('#useFrag').checked=!!c.test.needsFrag;
  el('#useFlux').disabled = STATE.flux<=0;
  el('#useFrag').disabled = c.test.needsFrag? STATE.frag<=0 : (STATE.frag<=0);
  el('#rollBtn').onclick = ()=>startDice();
}

/* -------------- DICE -------------- */
let diceTimer=null;
let rollRes=null;
function startDice(){
  rollRes=null;
  el('#diceOverlay').style.display='flex';
  const d1=el('#d1'), d2=el('#d2');
  d1.classList.add('anim'); d2.classList.add('anim');
  el('#diceInfo').textContent = '...';
  clearTimeout(diceTimer);
  diceTimer=setTimeout(stopDice, STATE.reduceAnim?800:1700);
}
function stopDice(){
  clearTimeout(diceTimer);
  const d1=el('#d1'), d2=el('#d2');
  d1.classList.remove('anim'); d2.classList.remove('anim');
  const a = 1+Math.floor(Math.random()*6);
  const b = 1+Math.floor(Math.random()*6);
  d1.textContent=a; d2.textContent=b;
  rollRes = {a,b,sum:a+b};
  el('#diceInfo').textContent = `Résultat: ${a} + ${b} = ${a+b}`;
  setTimeout(()=>{ el('#diceOverlay').style.display='none'; applyRoll(); }, 600);
}

function applyRoll(){
  if(!pendingTest || !rollRes) return;
  const c = pendingTest;
  const useFlux = el('#useFlux').checked && STATE.flux>0;
  const usePush = el('#usePush').checked;
  const useFrag = el('#useFrag').checked && STATE.frag>0;
  let mod = (STATE.stats[c.test.stat]||0);
  if(STATE.skills && ((c.test.skill==='Furtivité' && STATE.arch?.id==='noor') || (c.test.skill==='Intimidation' && STATE.arch?.id==='milo') || (c.test.skill==='Mécanique' && STATE.arch?.id==='rayan') || (STATE.skills[c.test.skill]>0))){
    mod += 1;
  }
  if(useFlux){ mod += 2; STATE.flux -= 1; }
  if(usePush){ mod += 2; } // si échec → +1 stress
  if(useFrag){ mod += 2; STATE.frag -= 1; }
  const total = rollRes.sum + mod;
  const success = total >= c.test.dd;
  const base = `${c.test.stat}/${c.test.skill||'-'} DD${c.test.dd} — ${rollRes.a}+${rollRes.b}=${rollRes.sum} + mods ${mod} = ${total} → ${success?'Réussite':'Échec'}`;
  STATE.lastRoll = base;
  addLog(base);
  if(success){ c.test.onSuccess && c.test.onSuccess(STATE); }
  else { if(usePush){ STATE.stress = Math.max(0, STATE.stress-1); addLog('+1 Stress (chance poussée, échec)'); } c.test.onFail && c.test.onFail(STATE); }
  if(c.go) { STATE.scene = c.go; addObjective('Déplacement: '+SCENES[c.go].title); }
  pendingTest=null; rollRes=null; el('#testPanel').style.display='none';
  save(); renderScene();
}

/* ------------------ SAVE ------------------ */
const SAVEKEY='trame_douce_v6';
function save(){ localStorage.setItem(SAVEKEY, JSON.stringify({
  archId:STATE.arch?.id, stats:STATE.stats, skills:STATE.skills, stress:STATE.stress, hp:STATE.hp, flux:STATE.flux, frag:STATE.frag,
  tags:[...STATE.tags], inv:STATE.inventory, obj:STATE.objective, objJ:STATE.objectives, scene:STATE.scene, route:STATE.miniRoute, crude:STATE.crude, ascii:STATE.ascii
}));}
function load(){
  try{
    const s=JSON.parse(localStorage.getItem(SAVEKEY)||'null'); if(!s) return;
    STATE.arch = ARCHETYPES.find(a=>a.id===s.archId)||null;
    if(STATE.arch){ STATE.stats = {...STATE.arch.stats}; STATE.skills = {...STATE.arch.skills}; }
    Object.assign(STATE,{stress:s.stress??5,hp:s.hp??5,flux:s.flux??2,frag:s.frag??2});
    STATE.tags = new Set(s.tags||[]); STATE.inventory = s.inv||[]; STATE.objective=s.obj||STATE.objective; STATE.objectives=s.objJ||[];
    STATE.scene = s.scene||'prologue'; STATE.miniRoute=s.route||''; STATE.crude=!!s.crude; STATE.ascii = s.ascii!==false;
  }catch(e){console.warn(e)}
}

/* ------------------ ARCHETYPE MODAL ------------------ */
let selectedArch=null;
function renderArcheModal(){
  const L=el('#archList'); L.innerHTML='';
  ARCHETYPES.forEach(a=>{
    const card=document.createElement('div'); card.className='arch'; card.setAttribute('tabindex','0');
    card.innerHTML=`<img src="${a.img}" alt="${a.name}">
    <div class="pad"><h3>${a.name}</h3><p>${a.back}</p></div>
    <div class="statrow">
      <span class="b neu">NEU ${a.stats.NEU}</span>
      <span class="b vol">VOL ${a.stats.VOL}</span>
      <span class="b som">SOM ${a.stats.SOM}</span>
      <span class="b cin">CIN ${a.stats.CIN}</span>
    </div>
    <div class="tags"><span class="badge">${a.atout}</span></div>`;
    card.onclick=()=>selectArch(a,card);
    L.appendChild(card);
  });
}
function selectArch(a,card){
  selectedArch=a;
  document.querySelectorAll('.arch').forEach(x=>x.setAttribute('aria-selected','false'));
  card.setAttribute('aria-selected','true');
  el('#confirmArch').disabled=false;
}
function randomArch(){ selectArch(ARCHETYPES[Math.floor(Math.random()*ARCHETYPES.length)], document.querySelectorAll('.arch')[0]); }
function commitArch(){
  STATE.arch = selectedArch;
  STATE.stats = {...selectedArch.stats};
  STATE.skills = {...selectedArch.skills};
  STATE.inventory = [...selectedArch.startInv];
  addObjective('Archétype choisi: '+selectedArch.name);
  document.getElementById('archeModal').style.display='none';
  save(); renderScene();
}

/* ------------------ EXPORT/IMPORT ------------------ */
function exportSave(){
  const blob=new Blob([localStorage.getItem(SAVEKEY)||'{}'],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='trame_douce_v6_save.json'; a.click(); URL.revokeObjectURL(url);
}
function importSave(){
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{localStorage.setItem(SAVEKEY,r.result); load(); renderScene();}; r.readAsText(f); };
  inp.click();
}

/* ------------------ INIT ------------------ */
load();
renderStats(); renderAscii(); renderTimeline(); renderScene();
renderArcheModal();
document.getElementById('confirmArch').onclick=commitArch;
</script>
</body>
</html>
