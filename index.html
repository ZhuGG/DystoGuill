<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TRAME DOUCE — Guillotière (v6.4)</title>
<style>
:root{
  --bg:#0b0e15; --p:#12182a; --p2:#0e1423; --ink:#eaf2ff; --mut:#9fb1cf; --line:#1a2438;
  --a:#9cf6ff; --b:#ffc2e9; --warn:#ffbd73; --bad:#ff6b7a; --good:#78f2bb;
  --neu:#6ad0ff; --vol:#ff78a8; --som:#ffc76e; --cin:#92ffcc; --sh:0 8px 28px rgba(0,0,0,.35);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
a{color:var(--a)}
.header{position:sticky;top:0;z-index:20;display:flex;flex-direction:column;gap:12px;padding:calc(10px + env(safe-area-inset-top,0px)) 12px 10px;border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,rgba(15,20,34,.92),rgba(15,20,34,.65));backdrop-filter:blur(8px)}
.headerTop{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.header .row{display:flex;gap:8px;flex-wrap:wrap}
.header .title{font-weight:800;letter-spacing:.5px;flex:1}
.headerControls{display:flex;align-items:center;gap:8px;margin-left:auto}
.headerBadges{gap:8px;flex-wrap:wrap;width:100%}
.viewBadge{background:rgba(255,255,255,.04);border-style:dashed;color:var(--ink);font-weight:600}
.btn.ghost{background:rgba(13,20,33,.6);border-style:dashed;color:var(--ink)}
.iconBtn{padding:0 12px;height:38px;border:1px solid #2a3a58;background:linear-gradient(180deg,#161f31,#0f1624);border-radius:12px;color:var(--ink);font-size:20px;cursor:pointer;display:grid;place-items:center;font-weight:700;min-width:38px}
.menuWrap{position:relative}
.menuWrap.open .iconBtn{outline:2px solid var(--a)}
.navMenu{display:none;position:absolute;right:0;top:calc(100% + 8px);background:var(--p2);border:1px solid var(--line);border-radius:12px;padding:8px;min-width:180px;box-shadow:var(--sh);flex-direction:column;gap:6px}
.menuWrap.open .navMenu{display:flex}
.navMenu .tabbtn{width:100%;text-align:left;justify-content:flex-start}
.tabbtn,.btn{padding:10px 12px;border:1px solid #2a3a58;background:linear-gradient(180deg,#141f33,#223355);border-radius:12px;color:var(--ink);cursor:pointer;font-weight:700;display:inline-flex;align-items:center;justify-content:center;gap:6px;text-align:center}
.tabbtn[aria-pressed="true"],.btn.primary{outline:2px solid var(--a)}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3a58;background:var(--p2);color:var(--mut);padding:2px 8px;border-radius:999px;font-size:12px}
.icon{width:16px;height:16px;opacity:.9}
.grid{display:grid;gap:16px;grid-template-columns:minmax(280px,320px) minmax(0,1fr) minmax(300px,360px);max-width:1280px;margin:auto;padding:16px;padding-bottom:calc(16px + var(--safe-bottom))}
.col{background:var(--p);border:1px solid var(--line);border-radius:14px;box-shadow:var(--sh);overflow:hidden;display:flex;flex-direction:column;gap:16px}
.pad{padding:16px;display:flex;flex-direction:column;gap:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.sectionTitle{color:var(--mut);font-size:12px;text-transform:uppercase;margin:0 0 4px;letter-spacing:.8px}
.sectionIntro{margin:0;color:var(--mut);font-size:13px;line-height:1.5}
.saveActions{display:flex;flex-wrap:wrap;gap:8px}
.saveActions .btn{flex:1 1 150px;min-width:140px;padding:9px 12px;border-radius:10px;font-size:13px}
.btn.subtle{background:linear-gradient(180deg,#152033,#1f2d45);border:1px solid #32425f}
.btnIcon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;font-size:14px;opacity:.85}
.btnLabel{display:inline-flex;align-items:center;justify-content:center;gap:8px}
/* left */
.stat{display:grid;grid-template-columns:24px 1fr 24px;align-items:center;background:var(--p2);border:1px solid var(--line);border-radius:10px;padding:6px;min-width:120px}
.stat .dot{width:16px;height:16px;border-radius:5px} .stat .name{font-size:11px;color:var(--mut);text-transform:uppercase} .stat .val{font-weight:800;text-align:right}
.neu .dot{background:var(--neu)} .neu .val{color:var(--neu)} .vol .dot{background:var(--vol)} .vol .val{color:var(--vol)} .som .dot{background:var(--som)} .som .val{color:var(--som)} .cin .dot{background:var(--cin)} .cin .val{color:var(--cin)}
.resbar{display:flex;gap:8px}.res{flex:1;background:var(--p2);border:1px solid var(--line);border-radius:10px;overflow:hidden}
.res .lbl{font-size:12px;color:var(--mut);padding:6px 8px;border-bottom:1px solid var(--line)} .meter{height:6px;background:var(--line)}
.fill{height:6px;background:linear-gradient(90deg,var(--a),var(--b))} .fill.bad{background:linear-gradient(90deg,var(--bad),var(--warn))}
.inventory{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
.inventory li{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:10px;background:var(--p2);border:1px solid var(--line);font-size:13px}
.inventory-slot{display:inline-flex;align-items:center;justify-content:center;width:32px;height:24px;border-radius:8px;background:rgba(255,255,255,.05);border:1px solid var(--line);font-weight:700;color:var(--mut);font-variant-numeric:tabular-nums}
.inventory-item{flex:1}
.inventory-empty{justify-content:center;color:var(--mut);font-style:italic}
.ascii{font-family:Consolas,Menlo,monospace;font-size:12px;background:#0b0f15;border:1px solid var(--line);border-radius:12px;padding:10px;white-space:pre-wrap;color:#b9c7da}
/* story */
.storyImage{position:relative;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#0a0e13}
.storyImage img{width:100%;height:240px;object-fit:cover;filter:contrast(1.05) saturate(1.1) brightness(.88)}
@media (max-width: 900px){
  .storyImage img{height:200px}
  .header{position:sticky;gap:12px}
  .header .title{font-size:18px}
  .headerTop{align-items:flex-start}
  .headerControls{margin-left:0;width:100%;justify-content:flex-start;flex-wrap:wrap}
  .headerControls .btn,.headerControls .iconBtn{width:auto}
  .headerBadges{width:100%;justify-content:flex-start}
}
.storyImage .legend{position:absolute;left:10px;bottom:10px;background:rgba(10,14,19,.7);padding:6px 8px;border-radius:8px;border:1px solid var(--line);color:var(--mut);font-size:12px}
.storyBody{background:var(--p2);border:1px solid var(--line);border-radius:14px;padding:18px}
.choices{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.choice{position:relative;border:1px solid #2a3a58;background:linear-gradient(180deg,#151e31,#233355);padding:12px;border-radius:12px;cursor:pointer;transition:transform .15s ease,outline .15s ease}
.choice:hover,.choice:focus-visible{outline:2px solid var(--a)} .choice small{display:block;color:var(--mut)}
.choice:active{transform:translateY(1px)}
.choice .tags{position:absolute;right:8px;top:8px;display:flex;gap:6px;flex-wrap:wrap}
.tag{padding:2px 6px;border-radius:999px;border:1px solid var(--line);font-size:11px;background:rgba(255,255,255,.03)}
.attr-NEU{border-left:4px solid var(--neu)} .attr-VOL{border-left:4px solid var(--vol)} .attr-SOM{border-left:4px solid var(--som)} .attr-CIN{border-left:4px solid var(--cin)}
/* tests */
.testPanel{margin-top:12px;border:1px dashed #2a3a58;border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.02)}
.testControls label{flex:1 1 160px}
.testResult{display:none;margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-weight:700}
.testResult.show{display:block}
.testResult.success{border-color:var(--good);color:var(--good)}
.testResult.fail{border-color:var(--bad);color:var(--bad)}
.btn{padding:10px 12px;border:1px solid #2a3a58;background:linear-gradient(180deg,#151e31,#233355);border-radius:12px;color:var(--ink);cursor:pointer}
.btn[disabled]{opacity:.4;cursor:not-allowed}
/* right */
.log{height:360px;overflow:auto;background:var(--p2);border:1px solid var(--line);border-radius:12px;padding:8px}
.log .line{padding:6px 0;border-bottom:1px dashed var(--line);font-size:13px}
.timeline{height:160px;overflow:auto;background:var(--p2);border:1px solid var(--line);border-radius:12px;padding:8px}
.timeline .item{margin:4px 0;padding:8px;border-left:3px solid var(--b);background:rgba(255,255,255,.02);border-radius:8px}
.timeline .when{color:var(--mut);font-size:12px}
/* dice */
#diceOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:40}
.diceWrap{background:var(--p);border:1px solid var(--line);border-radius:14px;padding:16px;min-width:300px;text-align:center}
.cubes{display:flex;gap:16px;justify-content:center;margin:10px 0 4px 0}
.cube{width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg,#1b2330,#0b1017);border:1px solid #273243;display:grid;place-items:center;font-size:40px;color:#fff}
.diceActions{gap:10px;margin-top:12px;justify-content:center;flex-wrap:wrap}
.diceActions .btn{min-width:120px}
#diceInfo{margin-top:10px;color:var(--mut);line-height:1.5}
.diceSummary{font-weight:600;color:var(--ink)}
.diceBreakdown{margin-top:6px;font-size:13px;color:var(--mut)}
.diceStatus{margin-top:8px;font-weight:700}
.diceStatus.success{color:var(--good)}
.diceStatus.fail{color:var(--bad)}
@media (prefers-reduced-motion: reduce){ .cube{animation:none!important} }
.anim{animation:roll 1s ease-in-out infinite}
@keyframes roll{0%{transform:rotate(0)}33%{transform:rotate(12deg)}66%{transform:rotate(-9deg)}100%{transform:rotate(0)}}
/* modals */
.modalScreen{position:fixed;inset:0;background:rgba(10,14,19,.88);display:flex;align-items:center;justify-content:center;z-index:50;padding:24px;overflow-y:auto}
.modalBox{background:var(--p);border:1px solid var(--line);padding:20px;border-radius:16px;max-width:1000px;width:95%;max-height:calc(100vh - 48px);overflow:auto;box-shadow:var(--sh)}
.modalBox h2{margin:0 0 8px 0}
.introBox{background:linear-gradient(180deg,#111827,#0d131f);border:1px solid rgba(156,246,255,.25)}
.introLead{margin:0 0 12px 0;color:var(--mut);font-size:15px;line-height:1.7}
.introColumns{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:6px 0 16px 0}
.introColumns h3{margin:0 0 6px 0;color:var(--ink);font-size:16px;letter-spacing:.5px}
.introColumns ul{margin:0;padding-left:18px;color:var(--mut);font-size:14px;line-height:1.6}
.introColumns li{margin:0 0 8px 0}
.introNote{border:1px solid rgba(156,246,255,.18);background:rgba(156,246,255,.06);padding:12px;border-radius:12px;color:var(--mut);font-size:13px;line-height:1.6}
.introActions{justify-content:flex-end;margin-top:18px}
.introActions .btn{min-width:200px}
.arches{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.arch{border:2px solid #2a3a58;background:linear-gradient(180deg,#141a23,#0e141c);border-radius:14px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column;transition:transform .2s ease,outline .2s ease}
.arch:active{transform:translateY(1px)}
.arch img{width:100%;height:140px;object-fit:cover}
.arch .pad{padding:12px;display:flex;flex-direction:column;gap:8px}
.arch h3{margin:0 0 6px 0}
.arch p{margin:.4em 0;color:var(--mut);font-size:13px}
.arch .statrow{display:flex;gap:6px;padding:0 10px 10px 10px}
.arch .b{border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px}
.arch[aria-selected="true"]{outline:3px solid var(--a)}
/* tabs visibility */
[data-view="story"] .left,[data-view="story"] .right{display:none}
[data-view="profile"] .mid,[data-view="profile"] .right{display:none}
[data-view="journal"] .left,[data-view="journal"] .mid{display:none}
/* mobile: single column + bottom nav */
@media (max-width: 900px){
  body{font-size:15px}
  .grid{grid-template-columns:1fr; padding-bottom: calc(64px + var(--safe-bottom));}
  .log{height:220px}.timeline{height:160px}
  .mobilebar{display:flex}
  .col{border-radius:12px}
  .pad{padding:14px}
  .badge{font-size:11px;padding:4px 8px}
  .tabbtn,.btn{width:100%}
}
.choice .tags{pointer-events:none}
.choice strong{display:block}
.kabeGameBox{max-width:520px}
.kabeGameIntro{margin:0 0 12px 0;color:var(--mut);line-height:1.6}
.kabeGamePrompt{margin:0 0 12px 0;font-weight:600;color:var(--ink);line-height:1.5}
.kabeGamePalette{display:grid;gap:10px;margin-bottom:8px}
.kabeGamePalette .btn{width:100%;text-align:left;align-items:flex-start;flex-direction:column;gap:4px}
.kabeGamePalette .btn small{font-size:12px;color:var(--mut)}
.kabeGamePalette .btn.selected{outline:2px solid var(--a)}
.kabeGamePalette .btn.locked{opacity:.55;cursor:default}
.kabeGameSequence{margin-top:4px;padding:10px;border-radius:12px;border:1px dashed var(--line);background:rgba(255,255,255,.03);display:flex;flex-direction:column;gap:6px}
.kabeGameSequence .steps{display:flex;flex-direction:column;gap:6px}
.kabeGameSequence .step{display:flex;flex-direction:column;gap:2px;padding:6px 8px;border-radius:8px;background:rgba(0,0,0,.14);border:1px solid rgba(156,246,255,.12);font-size:13px}
.kabeGameSequence .step strong{font-size:12px;color:var(--mut)}
.kabeGameSequence .step.pending{opacity:.65;font-style:italic}
.kabeGameSequence .step.fail{border-color:var(--bad);color:var(--bad)}
.kabeGameSequence .step.success{border-color:var(--good);color:var(--good)}
.kabeGameMessage{margin-top:12px;color:var(--mut);line-height:1.6}
.kabeGameActions{justify-content:flex-end;margin-top:16px;flex-wrap:wrap;gap:10px}
.kabeGameActions .btn{min-width:150px}
@media (max-width: 600px){
  body{font-size:14px}
  .header{padding:12px 10px;gap:10px}
  .header .title{font-size:16px;line-height:1.25}
  .headerTop{gap:8px}
  .headerControls{gap:6px}
  .headerBadges{gap:6px}
  .viewBadge{font-size:10px}
  .badge{font-size:10px}
  .tabbtn,.btn{font-size:14px;padding:10px}
  .storyImage img{height:170px}
  .storyBody{padding:12px}
  .choices{gap:12px}
  .choice{padding:14px}
  .choice strong{font-size:15px}
  .choice small{font-size:12px}
  .choice .tags{position:static;margin-top:8px;justify-content:flex-start}
  .modalScreen{padding:16px 12px;align-items:flex-start;overflow-y:auto}
  .modalBox{width:100%;max-width:480px;max-height:calc(100vh - 32px);overflow:auto}
  .arches{grid-template-columns:1fr;gap:12px}
  .arch{flex-direction:row;align-items:center}
  .arch img{width:96px;height:96px}
  .arch .pad{padding:12px;flex:1}
  .arch h3{font-size:16px}
  .arch p{font-size:12px}
  .arch .statrow{flex-wrap:wrap;gap:6px}
  .arch .b{font-size:11px;padding:3px 6px}
  .mobilebar{gap:6px}
  .saveActions .btn{min-width:0;width:100%}
}
.mobilebar{display:none; position:fixed; left:0; right:0; bottom:0; z-index:30;
  padding:8px 10px calc(8px + var(--safe-bottom)); gap:8px; justify-content:space-around;
  background:linear-gradient(180deg,rgba(10,14,22,.1),rgba(10,14,22,.9)); backdrop-filter: blur(8px); border-top:1px solid var(--line);}
.mobilebar .tabbtn{flex:1; text-align:center}
</style>
</head>
<body data-view="all">
<header class="header">
  <div class="headerTop">
    <div class="title">⟡ TRAME DOUCE — <span id="loc">Guillotière</span></div>
    <div class="headerControls">
      <span class="badge viewBadge" id="viewIndicator">Vue : Tous</span>
      <button class="btn ghost" id="asciiBtn">HUD ASCII ✓</button>
      <div class="menuWrap" id="navWrap">
        <button class="iconBtn" id="navToggle" aria-haspopup="true" aria-expanded="false" aria-label="Changer de vue">⋯</button>
        <div class="navMenu" id="navMenu" role="menu">
          <button class="tabbtn" data-viewto="all" aria-pressed="true" role="menuitem">Tous</button>
          <button class="tabbtn" data-viewto="story" role="menuitem">Histoire</button>
          <button class="tabbtn" data-viewto="profile" role="menuitem">Profil</button>
          <button class="tabbtn" data-viewto="journal" role="menuitem">Journal</button>
        </div>
      </div>
    </div>
  </div>
  <div class="row headerBadges">
    <span class="badge"><img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Heart_coraz%C3%B3n.svg/32px-Heart_coraz%C3%B3n.svg.png"> Stress <span id="stressVal">2</span>/5</span>
    <span class="badge"><img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8b/OOjs_UI_icon_firstaid-ltr.svg/32px-OOjs_UI_icon_firstaid-ltr.svg.png"> Blessures <span id="hpVal">5</span>/5</span>
    <span class="badge"><img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Circle-icons-bulb.svg/32px-Circle-icons-bulb.svg.png"> Flux ◆ <span id="fluxVal">2</span></span>
    <span class="badge"><img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/42/Noun_Project_document_icon_1409169_cc.svg/32px-Noun_Project_document_icon_1409169_cc.svg.png"> Fragments ✦ <span id="fragVal">2</span></span>
  </div>
</header>

<main class="grid">
  <aside class="col left">
    <div class="pad">
      <div class="sectionTitle">Profil</div>
      <div class="row" id="statsRow"></div>
      <div class="resbar">
        <div class="res"><div class="lbl">Stress</div><div class="meter"><div class="fill bad" id="stressFill" style="width:40%"></div></div></div>
        <div class="res"><div class="lbl">Blessures</div><div class="meter"><div class="fill bad" id="hpFill" style="width:100%"></div></div></div>
      </div>
      <div class="sectionTitle">Mini-carte</div>
      <div class="ascii" id="miniMap"></div>
      <div class="sectionTitle">Inventaire</div>
      <ul class="inventory" id="inventoryList" aria-live="polite"></ul>
      <div class="sectionTitle">Sauvegarde</div>
      <p class="sectionIntro">Enregistre ta progression en local ou reprends une partie précédente depuis un fichier.</p>
      <div class="saveActions">
        <button class="btn subtle" id="btnExport" type="button"><span class="btnLabel"><span class="btnIcon" aria-hidden="true">💾</span><span>Sauvegarder</span></span></button>
        <button class="btn subtle" id="btnImport" type="button"><span class="btnLabel"><span class="btnIcon" aria-hidden="true">⤴</span><span>Importer</span></span></button>
      </div>
    </div>
    <div class="pad">
      <div class="sectionTitle">HUD ASCII</div>
      <div class="ascii" id="asciiHud"></div>
    </div>
  </aside>

  <section class="col mid">
    <div class="pad">
      <div class="storyImage">
        <img id="storyImg" loading="lazy" src="https://cdn.midjourney.com/2dad9bcd-090b-477d-915d-6fc46c5cc0ad/0_1.png" alt="">
        <div class="legend" id="imgLegend">Guillotière — pluie sous la Sourdine</div>
      </div>
      <div class="row"><span class="badge">Objectif: <span id="objectiveText">Tracer une voie sûre vers T1.</span></span></div>
      <div class="storyBody">
        <h2 id="storyTitle">Prologue</h2>
        <div id="storyText"></div>
        <div class="choices" id="choices"></div>
        <div class="testPanel" id="testPanel" style="display:none">
          <div class="row">
            <span class="badge">Test: <span id="testName">—</span></span>
            <span class="badge">DD <span id="testDD">10</span></span>
            <div style="margin-left:auto"></div>
          </div>
          <div class="row testControls" style="align-items:center;margin-top:6px">
            <label class="badge"><input type="checkbox" id="useFlux"> +2 Flux</label>
            <label class="badge"><input type="checkbox" id="usePush"> +2 Pousser sa chance</label>
            <label class="badge"><input type="checkbox" id="useFrag"> ✦ Fragment (indice fort, +1 Stress)</label>
            <button class="btn primary" id="rollBtn">Lancer les dés</button>
          </div>
          <div class="small" id="testHint"></div>
          <div class="testResult" id="testResult" role="status" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </section>

  <aside class="col right">
    <div class="pad">
      <div class="sectionTitle">Journal des dés</div>
      <div class="log" id="log"></div>
      <div class="sectionTitle">Journal d’objectifs</div>
      <div class="timeline" id="timeline"></div>
    </div>
  </aside>
</main>

<!-- Mobile bottom bar -->
<nav class="mobilebar">
  <button class="tabbtn" data-viewto="story">Histoire</button>
  <button class="tabbtn" data-viewto="profile">Profil</button>
  <button class="tabbtn" data-viewto="journal">Journal</button>
  <button class="tabbtn" data-viewto="all">Tous</button>
</nav>

<!-- Dice overlay -->
<div id="diceOverlay"><div class="diceWrap">
  <div>2d6 — maintien = animation</div>
  <div class="cubes"><div class="cube anim" id="d1">•</div><div class="cube anim" id="d2">•</div></div>
  <div class="row diceActions" style="justify-content:center">
    <button class="btn primary" id="btnStopDice" aria-label="Figer le résultat du lancer">Figer le résultat</button>
    <button class="btn" id="btnResolveDice" style="display:none">Continuer</button>
  </div>
  <div id="diceInfo" class="small" aria-live="polite"></div>
</div></div>

<!-- Intro -->
<div id="introModal" class="modalScreen">
  <div class="modalBox introBox" style="max-width:900px">
    <h2>TRAME DOUCE — Préambule</h2>
    <p class="introLead">La Guillotière est engluée sous <b>la Sourdine</b>, un grondement électromagnétique qui brouille les voix, avale les souvenirs et dérègle les capteurs. Les habitants s’accrochent aux fragments de mémoire qui restent.</p>
    <p class="introLead">Pendant que la pluie polit les façades, la sous-station <b>T1</b> décroche du réseau. Si personne ne rétablit le flux, le quartier s’éteint et les voies d’évacuation se referment.</p>
    <div class="introColumns">
      <div>
        <h3>Ce que fait la Sourdine</h3>
        <ul>
          <li><b>Étire le temps</b> : sans notes, les souvenirs s’effacent.</li>
          <li><b>Ferme des portes</b> : chaque refus alimente la méfiance des communautés.</li>
          <li><b>Désoriente la technologie</b> : le HUD ASCII reste le moyen le plus fiable de suivre ta progression.</li>
        </ul>
      </div>
      <div>
        <h3>Ta mission</h3>
        <ul>
          <li>Cartographier une traversée sûre de la Place du Pont jusqu’à <b>T1</b>.</li>
          <li>Composer avec les acteurs du quartier pour gagner du <b>Flux</b> et des <b>Fragments</b>.</li>
          <li>Choisir un archétype dont les talents peuvent renverser la situation.</li>
        </ul>
      </div>
    </div>
    <p class="introLead">Chaque scène offre des choix, parfois des tests de dés. Négocier, détourner ou réparer modifie la tension, ouvre des routes ou t’enferme dans des impasses.</p>
    <p class="introLead">Quand tu es prêt·e, sélectionne un archétype. Sa manière de parler au quartier définira les opportunités qui se dévoilent.</p>
    <div class="introNote">Ton avancée est conservée dans ton navigateur. Sauvegarde régulièrement pour garder la trace de ce que la Sourdine pourrait faire oublier.</div>
    <div class="row introActions"><button class="btn primary" id="btnChooseArch">Choisir un archétype</button></div>
  </div>
</div>

<!-- Archetypes -->
<div id="archModal" class="modalScreen" style="display:none">
  <div class="modalBox">
    <h2>Choisis ton archétype</h2>
    <div class="arches" id="archList"></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="btnRandom">Au hasard</button>
      <button class="btn primary" id="btnConfirm" disabled>Valider</button>
    </div>
  </div>
</div>

<div id="kabeGameModal" class="modalScreen" style="display:none" aria-hidden="true">
  <div class="modalBox kabeGameBox">
    <h2>Rituel du Kabé clandestin</h2>
    <p class="kabeGameIntro">Kabé, maître des apéros clandestins, orchestre un rituel d’infusion pour garder la salle accordée. Enchaîne les gestes dans le bon ordre pour offrir une bouffée de douceur.</p>
    <div id="kabeGamePrompt" class="kabeGamePrompt"></div>
    <div id="kabeGamePalette" class="kabeGamePalette" role="group" aria-live="polite"></div>
    <div id="kabeGameSequence" class="kabeGameSequence" aria-live="polite"></div>
    <div id="kabeGameMessage" class="kabeGameMessage" role="status" aria-live="polite"></div>
    <div class="row kabeGameActions">
      <button class="btn subtle" id="kabeGameUndo" type="button">Annuler le dernier geste</button>
      <button class="btn subtle" id="kabeGameReset" type="button">Réinitialiser</button>
      <button class="btn primary" id="kabeGameServe" type="button">Servir la coupe</button>
      <button class="btn subtle" id="kabeGameRetry" type="button">Nouveau rituel</button>
      <button class="btn primary" id="kabeGameClose" type="button">Fermer</button>
    </div>
  </div>
</div>

<script>
/* ======= DATA ======= */
const ARCH=[
 {id:'noor',name:'Noor — Dormeuse du pont',img:'https://cdn.midjourney.com/a3b1416e-ee0e-4c20-930a-7ffd8a11813f/0_0.png',
  back:'Tu dors sous le tablier quand il fait doux. Tu sais écouter quand les autres parlent trop.',
  stats:{NEU:2,VOL:3,SOM:1,CIN:3},skills:{Furtivité:1,Empathie:1},start:['Feuillet-mica','Cutter','Gants usés']},
 {id:'milo',name:'Milo — Revendeur d’appoint',img:'https://cdn.midjourney.com/80762336-8ec1-4cc1-8c37-7c4107864bab/0_2.png',
  back:'Piles refondues, médocs, rumeurs. Tu parles cash et sens la merde à quinze mètres.',
  stats:{NEU:3,VOL:3,SOM:1,CIN:2},skills:{Intimidation:1,Déduction:1},start:['Lampe plate','Note marquée','Briquet']},
 {id:'rayan',name:'Rayan — Électricien clandestin',img:'https://cdn.midjourney.com/0e627014-f83a-41bd-9c3f-e4d828a9e555/0_3.png',
  back:'Tu connais les coffrets et les gaines qui chantent. Tu parles au cuivre comme à un gosse têtu.',
  stats:{NEU:3,VOL:2,SOM:3,CIN:2},skills:{Mécanique:1,Cryptanalyse:1},start:['Tournevis isolé','Aimant-alu','Ruban textile']}
];
const IMG={pro:{src:'https://cdn.midjourney.com/56285542-dbca-4ce6-b483-253548e35fd2/0_3.png',lg:'Souterrain — goutte à goutte'},
 place:{src:'https://cdn.midjourney.com/eaaf9643-3d4c-44b1-9ed1-7c243133a5c5/0_0.png',lg:'Place du Pont — pluie sur bitume'},
 maz:{src:'https://cdn.midjourney.com/b418e0bc-0e86-496e-a2d8-0eb310dbe984/0_0.png',lg:'Friche Mazagran — murs qui boivent'},
 ber:{src:'https://cdn.midjourney.com/9422d8a5-60dd-441f-9007-32d0dc57f3a5/0_0.png',lg:'Berges — darses envasées'},
 pon:{src:'https://cdn.midjourney.com/bb9836dc-9370-41d6-9df7-08fc0f2a9a78/0_2.png',lg:'Pont de la Guill’ — courant bas'},
 t1:{src:'https://cdn.midjourney.com/d62c2fce-31b6-4c23-8437-2d27d6a9eab8/0_1.png',lg:'Sous-station T1 — panneaux griffés'}
};
const ST={arch:null,stats:{NEU:2,VOL:2,SOM:2,CIN:2},skills:{},stress:2,hp:5,flux:2,frag:2,
 inv:[],tags:new Set(),scene:'prologue',objective:'Tracer une voie sûre vers T1.',objLog:[],visited:new Set(),ascii:true};
const VISIT_KEYS=[
 {key:'prologue',match:s=>s==='prologue'},
 {key:'place',match:s=>s.startsWith('place_')},
 {key:'collectif',match:s=>s==='place_collectif'},
 {key:'maz',match:s=>s.startsWith('maz_')},
 {key:'kabe',match:s=>s==='maz_apero'},
 {key:'atelier',match:s=>s==='maz_atelier'},
 {key:'ber',match:s=>s.startsWith('ber_')},
 {key:'patrouille',match:s=>s==='ber_patrouille'},
 {key:'pon',match:s=>s.startsWith('pon_')},
 {key:'ombre',match:s=>s==='pon_shadow'},
 {key:'t1',match:s=>s.startsWith('t1_')},
 {key:'perimetre',match:s=>s==='t1_overlook'}
];
function markVisited(scene){
  VISIT_KEYS.forEach(entry=>{ if(entry.match(scene)) ST.visited.add(entry.key); });
}
function clearEndingTags(){ ['End_Social','End_Infil','End_Tech','End_Contournement','End_Noise','End_Soft'].forEach(t=>ST.tags.delete(t)); }
function markEndingApproach(){
  if(ST.tags.has('Pont_Escorte')||ST.tags.has('Collectif_Favor')||ST.tags.has('T1_Soutien')) ST.tags.add('End_Social');
  if(ST.tags.has('Pont_Souterrain')||ST.tags.has('T1_Grille')) ST.tags.add('End_Infil');
  if(ST.tags.has('BadgeTech')||ST.tags.has('BadgeTech_Used')||ST.tags.has('Acces_Tech')||ST.tags.has('T1_Silence')) ST.tags.add('End_Tech');
}
function pickEnding(mode){
  const social=ST.tags.has('End_Social');
  const infiltr=ST.tags.has('End_Infil');
  const tech=ST.tags.has('End_Tech');
  if(mode==='cont'){
    if(tech) return 'ep_cont_tech';
    if(social) return 'ep_cont_social';
    if(infiltr) return 'ep_cont_shadow';
    return 'ep_cont';
  }
  if(mode==='noise'){
    if(tech) return 'ep_noise_tech';
    if(infiltr) return 'ep_noise_shadow';
    if(social) return 'ep_noise_social';
    return 'ep_noise';
  }
  if(mode==='soft'){
    if(social) return 'ep_soft_collectif';
    if(infiltr) return 'ep_soft_shadow';
    if(tech) return 'ep_soft_tech';
    return 'ep_soft';
  }
  return 'ep_silent';
}
const SAVE='td_v6_4';

/* ======= HELPERS ======= */
const VIEW_LABELS={all:'Tous',story:'Histoire',profile:'Profil',journal:'Journal'};
const $=q=>document.querySelector(q);
const navWrap=document.getElementById('navWrap');
const navToggle=document.getElementById('navToggle');
const navMenu=document.getElementById('navMenu');
const slotLabel=idx=>String(idx+1).padStart(2,'0');
const hasItem=name=>ST.inv.includes(name);
function gainItem(name){
  if(!ST.inv.includes(name)){
    ST.inv.push(name);
  }
}

function updateViewIndicator(v){const badge=$('#viewIndicator'); if(badge){badge.textContent='Vue : '+(VIEW_LABELS[v]||'Tous');}}
function openNavMenu(){if(!navWrap)return;navWrap.classList.add('open');if(navToggle)navToggle.setAttribute('aria-expanded','true');}
function closeNavMenu(){if(!navWrap)return;navWrap.classList.remove('open');if(navToggle)navToggle.setAttribute('aria-expanded','false');}
function toggleNavMenu(){if(navWrap?.classList.contains('open')){closeNavMenu();}else{openNavMenu();}}
updateViewIndicator(document.body.getAttribute('data-view')||'all');
if(navToggle){navToggle.addEventListener('click',e=>{e.stopPropagation();toggleNavMenu();});}
document.addEventListener('click',e=>{if(navWrap&&!navWrap.contains(e.target)){closeNavMenu();}});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeNavMenu();closeKabeGame();}});
function log(t){const L=$('#log');const d=document.createElement('div');d.className='line';d.textContent=t;L.prepend(d)}
function addObj(t){ST.objLog.push({t:Date.now(),text:t}); renderTimeline() }
function setView(v){
  document.body.setAttribute('data-view',v);
  document.querySelectorAll('[data-viewto]').forEach(b=>b.setAttribute('aria-pressed', b.getAttribute('data-viewto')===v ? 'true' : 'false'));
  updateViewIndicator(v);
}
function setupNav(){
  document.querySelectorAll('[data-viewto]').forEach(b=>{
    b.addEventListener('click', e=>{ setView(b.getAttribute('data-viewto')); closeNavMenu(); });
  });
}
$('#asciiBtn').addEventListener('click',()=>{ST.ascii=!ST.ascii;renderAscii();$('#asciiBtn').textContent='HUD ASCII '+(ST.ascii?'✓':'✗')});
function bars(){ $('#stressVal').textContent=ST.stress; $('#hpVal').textContent=ST.hp; $('#fluxVal').textContent=ST.flux; $('#fragVal').textContent=ST.frag;
  $('#stressFill').style.width=(ST.stress/5*100)+'%'; $('#hpFill').style.width=(ST.hp/5*100)+'%'; }
function renderStats(){const r=$('#statsRow');r.innerHTML='';const s=ST.stats;
  const mk=(cls,nm,v)=>`<div class="stat ${cls}"><div class="dot"></div><div class="name">${nm}</div><div class="val">${v}</div></div>`;
  r.insertAdjacentHTML('beforeend',mk('neu','Neuro',s.NEU)); r.insertAdjacentHTML('beforeend',mk('vol','Volonté',s.VOL));
  r.insertAdjacentHTML('beforeend',mk('som','Somatique',s.SOM)); r.insertAdjacentHTML('beforeend',mk('cin','Cinétique',s.CIN));
}
function renderInventory(){
  const list=$('#inventoryList');
  if(!list) return;
  list.innerHTML='';
  if(!ST.inv.length){
    const empty=document.createElement('li');
    empty.className='inventory-empty';
    empty.textContent='Aucun objet.';
    list.appendChild(empty);
    return;
  }
  ST.inv.forEach((item,idx)=>{
    const li=document.createElement('li');
    li.innerHTML=`<span class="inventory-slot">${slotLabel(idx)}</span><span class="inventory-item">${item}</span>`;
    list.appendChild(li);
  });
}
function renderAscii(){ if(!ST.ascii){$('#asciiHud').textContent='(désactivé)'; $('#miniMap').textContent='(désactivé)'; return;}
  const asciiLines=[
    '╔══[ ATH ]══════════════════════════════════════╗',
    `║ ${ST.arch?ST.arch.name:'—'}`,
    `║ NEU ${ST.stats.NEU} VOL ${ST.stats.VOL} SOM ${ST.stats.SOM} CIN ${ST.stats.CIN}`,
    `║ Stress ${'█'.repeat(ST.stress)}${'░'.repeat(5-ST.stress)}  Bless ${'█'.repeat(ST.hp)}${'░'.repeat(5-ST.hp)}`,
    `║ Flux ◆${ST.flux}  Frag ✦${ST.frag}`,
    '║ Inventaire:'
  ];
  if(ST.inv.length){ ST.inv.forEach((item,idx)=>{ asciiLines.push(`║   ${slotLabel(idx)} ▸ ${item}`); }); }
  else { asciiLines.push('║   (vide)'); }
  asciiLines.push(`║ Scène: ${ST.scene}`);
  asciiLines.push(`║ Tags: ${[...ST.tags].join(', ')||'—'}`);
  asciiLines.push('╚════════════════════════════════════════════════╝');
  $('#asciiHud').textContent=asciiLines.join('\n'); renderMiniMap(); }
function renderMiniMap(){const v=s=>ST.visited.has(s)?'●':'○';
 $('#miniMap').textContent=`[Guillotière]
  ${v('prologue')} Prologue
  ├─ ${v('place')} Place du Pont
  │   └─ ${v('collectif')} Assemblée couverte
  ├─ ${v('maz')} Mazagran
  │   ├─ ${v('kabe')} Kabé — apéros clandestins
  │   └─ ${v('atelier')} Atelier de fortune
  ├─ ${v('ber')} Berges
  │   └─ ${v('patrouille')} Patrouille fluviale
  ├─ ${v('pon')} Pont de la Guill’
  │   └─ ${v('ombre')} Contre-voie
  └─ ${v('t1')} T1
      └─ ${v('perimetre')} Périmètre interne
`; }
function renderTimeline(){const T=$('#timeline');T.innerHTML='';ST.objLog.slice().reverse().forEach(o=>{const d=document.createElement('div');d.className='item';d.innerHTML=`<div>${o.text}</div><div class="when">${new Date(o.t).toLocaleTimeString()}</div>`;T.appendChild(d)})}
function save(){localStorage.setItem(SAVE,JSON.stringify({a:ST.arch?.id,s:ST.stats,k:ST.skills,st:ST.stress,h:ST.hp,f:ST.flux,g:ST.frag,i:ST.inv,t:[...ST.tags],sc:ST.scene,o:ST.objective,ol:ST.objLog,v:[...ST.visited],as:ST.ascii}))}
function load(){try{const d=JSON.parse(localStorage.getItem(SAVE)||'null');if(!d)return;ST.arch=ARCH.find(x=>x.id===d.a)||null; if(ST.arch){ST.stats={...ST.arch.stats};ST.skills={...ST.arch.skills};ST.inv=[...ST.arch.start]}
  Object.assign(ST,{stress:d.st??2,hp:d.h??5,flux:d.f??2,frag:d.g??2});ST.inv=d.i||ST.inv;ST.tags=new Set(d.t||[]);
  if(ST.tags.has('Kabe_GameWon')){ST.tags.delete('Kabe_GameWon');ST.tags.add('Kabe_RitualWon');}
  ST.scene=d.sc||'prologue';ST.objective=d.o||ST.objective;ST.objLog=d.ol||[];ST.visited=new Set(d.v||[]);ST.ascii=d.as!==false}catch(e){}}
/* exporter/importer */
$('#btnExport').addEventListener('click',()=>{const blob=new Blob([localStorage.getItem(SAVE)||'{}'],{type:'application/json'});const u=URL.createObjectURL(blob);const a=document.createElement('a');a.href=u;a.download='trame_douce_v6_4_sauvegarde.json';a.click();URL.revokeObjectURL(u)});
$('#btnImport').addEventListener('click',()=>{const i=document.createElement('input');i.type='file';i.accept='application/json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{localStorage.setItem(SAVE,r.result);load();render()};r.readAsText(f)};i.click()});

const KABE_GESTURES={
  brume:{name:'Brume d’absinthe',notes:'Assourdit la salle et adoucit la Sourdine.'},
  braise:{name:'Braise confite',notes:'Chaleur fumée qui tient les cœurs éveillés.'},
  givre:{name:'Givre de menthe noire',notes:'Froid sec qui tranche les excès.'},
  pulse:{name:'Pulse magnétique',notes:'Battement salin qui cale la ronde.'},
  sève:{name:'Sève cardée',notes:'Épaisseur végétale qui rassure les nerfs.'},
  voile:{name:'Voile de sureau',notes:'Fleurs blanches qui filtrent la Sourdine.'},
  zeste:{name:'Zeste d’orage',notes:'Agrume électrique qui réveille le palais.'},
  sel:{name:'Sel de darse',notes:'Cristaux salins qui rappellent le quai.'}
};
const KABE_RITUALS=[
  {id:'velours',name:'Velours de veille',clue:'Kabé veut endormir les capteurs : couvre la salle, stabilise, puis scelle avec une chaleur douce.',sequence:['voile','sève','braise'],palette:['voile','pulse','sève','braise','zeste']},
  {id:'orage',name:'Orage contenu',clue:'Il faut réveiller la ronde sans casser le silence : une pointe vive, calmer aussitôt, puis verrouiller par un souffle froid.',sequence:['zeste','brume','givre'],palette:['zeste','brume','givre','braise','pulse']},
  {id:'rebond',name:'Rebond des habitués',clue:'Kabé réclame un rythme rebondissant : pulse la table, lie avec un voile, puis relève par une douceur végétale.',sequence:['pulse','voile','sève'],palette:['pulse','voile','sève','brume','givre']},
  {id:'rade',name:'Ancre des darses',clue:'Les mariniers veulent oublier la vase : appelle la brume, verse le sel des quais, termine par une braise confite.',sequence:['brume','sel','braise'],palette:['brume','sel','braise','sève','zeste']},
  {id:'clair',name:'Clair sous la Sourdine',clue:'Pour garder les idées claires : givre l’esprit, impose une pulse régulière, referme avec un voile protecteur.',sequence:['givre','pulse','voile'],palette:['givre','pulse','voile','brume','sève']}
];
let kabeGameState=null;

function openKabeGame(){
  startKabeRitual();
  const modal=document.getElementById('kabeGameModal');
  if(modal){
    modal.style.display='flex';
    modal.setAttribute('aria-hidden','false');
  }
}

function closeKabeGame(){
  const modal=document.getElementById('kabeGameModal');
  const wasOpen=modal && modal.style.display!=='none';
  if(modal){
    modal.style.display='none';
    modal.setAttribute('aria-hidden','true');
  }
  kabeGameState=null;
  renderKabeGame();
  if(wasOpen){
    render();
  }
}

function startKabeRitual(){
  const ritual=KABE_RITUALS[Math.floor(Math.random()*KABE_RITUALS.length)];
  kabeGameState={ritual,selected:[],locked:false,feedback:null,firstWin:false};
  renderKabeGame();
}

function handleKabeGesture(id){
  if(!kabeGameState||kabeGameState.locked) return;
  if(!KABE_GESTURES[id]) return;
  if(kabeGameState.selected.includes(id)) return;
  const len=kabeGameState.ritual.sequence.length;
  if(kabeGameState.selected.length>=len) return;
  kabeGameState.selected.push(id);
  kabeGameState.feedback=null;
  renderKabeGame();
}

function undoKabeGesture(){
  if(!kabeGameState||kabeGameState.locked) return;
  if(kabeGameState.selected.length===0) return;
  kabeGameState.selected.pop();
  kabeGameState.feedback=null;
  renderKabeGame();
}

function resetKabeGesture(){
  if(!kabeGameState||kabeGameState.locked) return;
  kabeGameState.selected=[];
  kabeGameState.feedback=null;
  renderKabeGame();
}

function serveKabeRitual(){
  if(!kabeGameState||kabeGameState.locked) return;
  const {ritual,selected}=kabeGameState;
  const needed=ritual.sequence.length;
  if(selected.length<needed){
    kabeGameState.feedback='incomplete';
    renderKabeGame();
    return;
  }
  const success=ritual.sequence.every((step,idx)=>selected[idx]===step);
  if(success){
    const firstWin=!ST.tags.has('Kabe_RitualWon');
    kabeGameState.locked=true;
    kabeGameState.feedback='success';
    kabeGameState.firstWin=firstWin;
    if(firstWin){
      if(ST.stress>0){
        ST.stress=Math.max(0,ST.stress-1);
      }
      ST.tags.add('Kabe_RitualWon');
      addObj('Rituel de Kabé maîtrisé : stress allégé.');
      log('Kabé approuve le rituel parfait. Stress -1.');
    }else{
      log('Kabé sourit : la séquence est impeccable.');
    }
    bars();
    renderAscii();
    save();
  }else{
    kabeGameState.feedback='fail';
  }
  renderKabeGame();
}

function renderKabeGame(){
  const palette=document.getElementById('kabeGamePalette');
  const prompt=document.getElementById('kabeGamePrompt');
  const sequenceBox=document.getElementById('kabeGameSequence');
  const message=document.getElementById('kabeGameMessage');
  if(!palette||!prompt||!sequenceBox||!message){
    return;
  }
  if(!kabeGameState){
    palette.innerHTML='';
    prompt.textContent='';
    sequenceBox.innerHTML='';
    message.textContent='';
    const undo=document.getElementById('kabeGameUndo');
    const reset=document.getElementById('kabeGameReset');
    const serve=document.getElementById('kabeGameServe');
    if(undo) undo.disabled=true;
    if(reset) reset.disabled=true;
    if(serve) serve.disabled=true;
    return;
  }
  const {ritual,selected,locked,feedback}=kabeGameState;
  prompt.innerHTML=`<strong>${ritual.name}</strong> — ${ritual.clue}`;
  palette.innerHTML='';
  ritual.palette.forEach(id=>{
    const info=KABE_GESTURES[id];
    if(!info) return;
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='btn';
    if(locked) btn.classList.add('locked');
    if(selected.includes(id)) btn.classList.add('selected');
    btn.disabled=locked||selected.includes(id);
    btn.innerHTML=`<span>${info.name}</span><small>${info.notes}</small>`;
    btn.addEventListener('click',()=>handleKabeGesture(id));
    palette.appendChild(btn);
  });

  const seqLen=ritual.sequence.length;
  const steps=document.createElement('div');
  steps.className='steps';
  for(let i=0;i<seqLen;i++){
    const wrap=document.createElement('div');
    wrap.className='step';
    const chosen=selected[i];
    if(!chosen){
      wrap.classList.add('pending');
      wrap.innerHTML=`<strong>${i+1}.</strong> En attente`;
    }else{
      const info=KABE_GESTURES[chosen];
      wrap.innerHTML=`<strong>${i+1}.</strong> ${info?info.name:chosen}`;
      if((locked||feedback==='fail') && ritual.sequence[i]===chosen){
        wrap.classList.add('success');
      }else if((locked||feedback==='fail') && ritual.sequence[i]!==chosen){
        wrap.classList.add('fail');
      }
    }
    steps.appendChild(wrap);
  }
  sequenceBox.innerHTML='';
  sequenceBox.appendChild(steps);

  let msg='';
  if(locked && feedback==='success'){
    msg=kabeGameState.firstWin
      ? 'Kabé approuve : le rituel parfait calme la salle. Stress -1.'
      : 'Kabé acquiesce. Tu maîtrises encore la séquence.';
  }else if(feedback==='fail'){
    const missIndex=ritual.sequence.findIndex((step,idx)=>selected[idx]!==step);
    if(missIndex>=0){
      const expected=KABE_GESTURES[ritual.sequence[missIndex]];
      const expName=expected?expected.name:'un autre geste';
      msg=`La coupe manque d’équilibre. Kabé attendait ${expName} en ${missIndex+1}ᵉ geste.`;
    }else{
      msg='La coupe manque d’équilibre. Annule un geste ou recommence la séquence.';
    }
  }else if(feedback==='incomplete'){
    msg='La coupe n’est pas prête : complète la séquence avant de servir.';
  }else if(selected.length===0){
    msg=`Choisis ${seqLen} gestes dans l’ordre. Kabé observe chaque mouvement.`;
  }else if(selected.length<seqLen){
    msg=`Geste ${selected.length+1} sur ${seqLen} : écoute la salle avant de poursuivre.`;
  }else{
    msg='Quand tu es prêt·e, sers la coupe pour que Kabé juge la ronde.';
  }
  message.textContent=msg;

  const undo=document.getElementById('kabeGameUndo');
  const reset=document.getElementById('kabeGameReset');
  const serve=document.getElementById('kabeGameServe');
  if(undo) undo.disabled=locked||selected.length===0;
  if(reset) reset.disabled=locked||selected.length===0;
  if(serve) serve.disabled=locked||selected.length<seqLen;
}

const kabeRetry=document.getElementById('kabeGameRetry');
if(kabeRetry){
  kabeRetry.addEventListener('click',()=>{
    startKabeRitual();
  });
}
const kabeClose=document.getElementById('kabeGameClose');
if(kabeClose){
  kabeClose.addEventListener('click',()=>{
    closeKabeGame();
  });
}
const kabeUndo=document.getElementById('kabeGameUndo');
if(kabeUndo){
  kabeUndo.addEventListener('click',()=>{
    undoKabeGesture();
  });
}
const kabeReset=document.getElementById('kabeGameReset');
if(kabeReset){
  kabeReset.addEventListener('click',()=>{
    resetKabeGesture();
  });
}
const kabeServe=document.getElementById('kabeGameServe');
if(kabeServe){
  kabeServe.addEventListener('click',()=>{
    serveKabeRitual();
  });
}

/* ======= SCENES ======= */
const SC={
 prologue:{
  img:IMG.pro,title:'Prologue — La Sourdine',text:()=>`
  <p>La pluie plaque les enseignes de la Place du Pont et étire les halos des néons. Sous <b>la Sourdine</b>, les voix deviennent feutrées, les souvenirs glissent et ton HUD vacille par à-coups.</p>
  <p>La sous-station <b>T1</b> décroche du réseau : si elle lâche, la Guill’ s’assombrit et les voies d’évacuation se referment.</p>
  <p>Il te faut un itinéraire sûr. <i>Noor</i> connaît les caves, <i>Milo</i> négocie avec les guetteurs, ou tu peux lire seul·e le courant qui serpente sous la pluie.</p>`,
  choices:[
    {label:'Retrouver Noor, la dormeuse du pont',hint:'Guide discret vers les Berges (furtivité)',go:'place_noor'},
    {label:'Marcher vers Milo, le revendeur',hint:'Passe-droit potentiel au Pont',go:'place_milo'},
    {label:'Observer la foule par toi-même',hint:'Tracer une route sans allié',go:'place_solo'}
  ]
 },
 place_noor:{
 img:IMG.place,title:'Place du Pont — Noor',text:()=>`
  <p>Noor s’abrite sous une bâche plastique, capuche rabattue, regard calme mais précis. Elle connaît les caves qui mènent aux <b>Berges</b> et repère déjà les issues derrière toi.</p>
  <p>Elle ouvrira la voie si tu récupères <b>son sac</b> oublié à <b>Mazagran</b>, celui qui contient un feuillet d’itinéraires griffonné à la main.</p>`,
  choices:[
    {label:'Accepter et récupérer son sac',hint:'Nouvel objectif : ramener le sac de Noor',immediate:s=>{s.tags.add('Noor');s.objective='Ramener le sac de Noor pour ouvrir la voie des caves.';addObj('Nouvel objectif : rapporter le sac de Noor.');},go:'maz_noor'},
    {label:'Refuser mais prendre son indice',hint:'Indice de trappe sans accompagnement',immediate:s=>{s.tags.add('Indice_Trappe');s.objective='Trouver la trappe technique indiquée par Noor.';addObj('Indice obtenu : emplacement de la trappe.');},go:'maz_common'},
    {label:'Rester sur la Place et observer',hint:'Ouvrir d’autres approches sous l’auvent',go:'place_return'}
  ]
 },
 place_milo:{
 img:IMG.place,title:'Place du Pont — Milo',text:()=>`
  <p>Milo recompte des câbles sous un parapluie troué. Son réseau alimente les guetteurs du <b>Pont</b>. Il peut obtenir un laissez-passer si tu récupères un <b>coffret</b> caché à <b>Mazagran</b>.</p>
  <p>Le deal est clair : tu rapportes le coffret, il parle aux guetteurs et partage un code de reconnaissance gravé sur le plomb.</p>`,
  choices:[
    {label:'Accepter le deal du coffret',hint:'Passe-droit à gagner si tu réussis',immediate:s=>{s.tags.add('Milo');s.objective='Ramener le coffret scellé à Milo pour obtenir le passe.';addObj('Nouvel objectif : récupérer le coffret de Milo.');},go:'maz_milo'},
    {label:'Refuser et rester indépendant·e',hint:'Route neutre vers Mazagran',immediate:s=>{s.objective='Chercher un passage neutre par Mazagran.';},go:'maz_common'},
    {label:'Explorer la Place par soi-même',hint:'Observer les assemblées abritées',go:'place_return'}
  ]
 },
 place_solo:{
 img:IMG.place,title:'Place du Pont — Lire la foule',text:()=>`
  <p>Tu te laisses porter par la foule. La pluie trace des courants sur le bitume et les rumeurs roulent d’un abri à l’autre. Tout converge vers <b>Mazagran</b> avant de glisser vers les <b>Berges</b>.</p>
  <p>Reste à décider si tu suis le courant, si tu glanes des indices sous l’auvent ou si tu forces un passage direct.</p>`,
  choices:[
    {label:'Suivre le flux jusqu’à Mazagran',hint:'Collecter des indices avant les Berges',go:'maz_common'},
    {label:'Forcer un passage vers les Berges',hint:'Contourner la friche sans aide',go:'ber_entry'},
    {label:'Se glisser sous l’auvent du Collectif',hint:'Voie sociale potentielle',go:'place_collectif'}
  ]
 },

 place_return:{
  img:IMG.place,title:'Place du Pont — Carrefour sous la Sourdine',text:()=>{
   const notes=[];
   if(ST.tags.has('Noor_Sac')&&!ST.tags.has('Noor_Trust')){notes.push('Noor surveille ton sac, prête à filer vers les caves.');}
   else if(ST.tags.has('Noor_Trust')){notes.push('Noor garde la trappe entrouverte, signe discret de confiance.');}
   if(ST.tags.has('Coffret_Milo')&&!ST.tags.has('Milo_Pass')){notes.push('Milo attend le coffret, parapluie battant.');}
   else if(ST.tags.has('Milo_Pass')){notes.push('Le laissez-passer de Milo luit brièvement sous la pluie.');}
   if(ST.tags.has('Collectif_Favor')&&!ST.tags.has('Collectif_Pret')){notes.push('Le Collectif suit chacun de tes gestes, prêt à te couvrir jusqu’au Pont.');}
   else if(ST.tags.has('Collectif_Pret')){notes.push('L’escorte du Collectif attend un signe pour t’accompagner au Pont.');}
   if(ST.inv.includes('Badge maintenance')){notes.push('Un badge de maintenance pulse dans ta poche, promesse d’un accès technique.');}
   const extra=notes.join(' ')||'Les regards glissent vers Mazagran, vers le Pont, vers ceux qui bricolent leur survie.';
   return `<p>La Place du Pont clignote sous la Sourdine, les bâches claquent au rythme des pas.</p><p>${extra}</p>`;
  },
  choices:()=>{
   const arr=[];
   if(ST.tags.has('Noor')&&ST.tags.has('Noor_Sac')&&!ST.tags.has('Noor_Trust')){
    arr.push({label:'Remettre le sac à Noor',hint:'Voie sociale vers les caves',immediate:s=>{s.tags.delete('Noor_Sac');s.tags.add('Noor_Trust');s.objective='Suivre Noor par les caves vers les Berges.';addObj('Noor récupère son sac et t’offre la trappe des caves.');},go:'place_return'});
   }
   if(ST.tags.has('Milo')&&ST.tags.has('Coffret_Milo')&&!ST.tags.has('Milo_Pass')){
    arr.push({label:'Livrer le coffret à Milo',hint:'Passe-droit vers le Pont',immediate:s=>{s.tags.delete('Coffret_Milo');s.tags.add('Milo_Pass');s.inv=s.inv.filter(it=>it!=='Coffret (Milo)');s.objective='Utiliser le laissez-passer de Milo pour franchir le Pont.';addObj('Milo tamponne ton laissez-passer et te fait un clin d’œil.');},go:'place_return'});
   }
   if(ST.tags.has('Collectif_Favor')&&!ST.tags.has('Collectif_Pret')){
    arr.push({label:'Prévenir le Collectif de ton départ',hint:'Prépare une escorte sociale',immediate:s=>{s.tags.add('Collectif_Pret');s.objective='Rejoindre le Pont avec l’appui du Collectif.';addObj('Le Collectif prépare une escorte pour le Pont.');},go:'place_return'});
   }
   if(hasItem('Feuillet-mica')&&!ST.tags.has('Feuillet_Map')){
    arr.push({label:'Déplier le feuillet-mica',hint:'Cartographier un conduit oublié vers T1',immediate:s=>{s.tags.add('Feuillet_Map');s.objective='Suivre les repères du feuillet vers une gaine discrète.';addObj('Les tracés UV du feuillet révèlent un détour sûr.');},go:'place_return'});
   }
    arr.push({label:'Rejoindre l’assemblée sous l’auvent',hint:'Chercher des appuis sociaux',go:'place_collectif'});
   arr.push({label:'Retourner vers Mazagran',hint:'Explorer la friche encore humide',go:'maz_common'});
   arr.push({label:'Descendre vers les Berges',hint:'Retrouver la trappe technique',go:'ber_entry'});
   arr.push({label:'S’approcher du Pont',hint:'Tester les contrôles en place',go:'pon_pass'});
   return arr;
  }
 },
 place_collectif:{
  img:IMG.place,title:'Place du Pont — Assemblée couverte',text:()=>`
  <p>Sous l’auvent, des tables pliantes croulent sous les radios démontées. Les membres du Collectif griffonnent des plans pour contourner la Sourdine.</p>
  <p>Ils peuvent fournir escortes, rumeurs ou accès techniques si tu prouves ta valeur.</p>`,
  choices:[
    {label:'Partager la note marquée de Milo',hint:'Utiliser la recommandation pour convaincre',when:()=>hasItem('Note marquée')&&!ST.tags.has('Collectif_Favor'),immediate:s=>{s.tags.add('Collectif_Favor');s.objective='Le Collectif peut préparer une escorte vers le Pont.';addObj('La note marquée circule sous l’auvent : confiance gagnée.');},go:'place_return'},
    {label:'Partager ton itinéraire',hint:'VOL/Empathie (10) — obtenir une escorte',when:()=>!ST.tags.has('Collectif_Favor'),test:{stat:'VOL',skill:'Empathie',dd:10,
      ok:s=>{s.tags.add('Collectif_Favor');s.objective='Le Collectif peut préparer une escorte vers le Pont.';addObj('Le Collectif accepte de couvrir ton passage.');},
      ko:s=>{s.stress=Math.min(5,s.stress+1);log('La discussion s’échauffe. +1 Stress.');}
    },goOK:'place_return',goKO:'place_collectif'},
    {label:'Écouter sans être vu',hint:'CIN/Furtivité (11) — récupérer le planning des guetteurs',when:()=>!ST.tags.has('Collectif_Dossier'),test:{stat:'CIN',skill:'Furtivité',dd:11,
      ok:s=>{s.tags.add('Collectif_Dossier');s.objective='Exploiter le planning des guetteurs pour traverser le Pont.';addObj('Planning des guetteurs mémorisé.');},
      ko:s=>{s.stress=Math.min(5,s.stress+1);log('Un regard te fixe. +1 Stress.');}
    },goOK:'place_return',goKO:'place_collectif'},
    {label:'Rétablir leur relais radio',hint:'NEU/Mécanique (11) — badge de maintenance',when:()=>!ST.tags.has('BadgeTech'),test:{stat:'NEU',skill:'Mécanique',dd:11,
      ok:s=>{gainItem('Badge maintenance');s.tags.add('BadgeTech');s.objective='Utiliser le badge pour contourner la surveillance du Pont.';addObj('Badge de maintenance prêt pour les contrôles.');},
      ko:s=>{s.hp=Math.max(0,s.hp-1);log('Une étincelle te mord. +1 Blessure.');}
    },goOK:'place_return',goKO:'place_collectif'},
    {label:'Revenir vers la Place principale',hint:'Faire le point avec tes contacts',go:'place_return'}
  ]
 },
 maz_common:{
 img:IMG.maz,title:'Friche Mazagran — Cour',text:()=>`
  <p>Le conteneur-atelier bourdonne. Une échelle plonge vers la cave. Sur l’établi : un <b>feuillet-mémoire</b> annoté. En bas, un <b>coffret scellé</b> attend dans l’ombre.</p>`,
  choices:[
    {label:'Lire le feuillet annoté',hint:'NEU/Mnémographie (10) — repérer la trappe',test:{stat:'NEU',skill:'Mnémographie',dd:10,
      ok:s=>{s.tags.add('Motif_R');s.objective='Atteindre la trappe technique depuis les Berges.';addObj('Indice : localisation de la trappe technique vers T1.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Le motif te vrille. +1 Stress.')}}},
    {label:'Saisir le coffret scellé',hint:'Ajouter l’objet à ton inventaire',immediate:s=>{gainItem('Coffret scellé');s.objective='Transporter le coffret sans attirer l’attention.';addObj('Coffret scellé rangé dans ton sac.');}},
    {label:'Franchir la porte du Kabé',hint:'Respirer un instant loin de la Sourdine',when:()=>ST.stress>0&&!ST.tags.has('Kabe_Apero'),go:'maz_apero'},
    {label:'Descendre vers les Berges',hint:'Prendre la cave jusqu’aux darses',go:'ber_entry'},
    {label:'Se faufiler vers l’atelier latéral',hint:'Rencontrer les ouvriers de la friche',go:'maz_atelier'},
    {label:'Retourner vers la Place du Pont',hint:'Faire le point avec Noor, Milo ou le Collectif',go:'place_return'}
 ]
},
 maz_apero:{
  img:IMG.maz,title:'Mazagran — Kabé clandestin',text:()=>{
   const first=!ST.tags.has('Kabe_Apero');
   if(first){
    ST.tags.add('Kabe_Apero');
    ST.stress=Math.max(0,ST.stress-1);
    addObj('Kabé clandestin : tu respires avec la ronde. Stress -1.');
    log('Le Kabé te délasse. -1 Stress.');
   }
  const souffle=first
   ? 'Un verre tiède passe de main en main, la rumeur couvre la Sourdine. Ton souffle ralentit.'
   : 'Les habitué·es te reconnaissent et gardent une place au chaud.';
  const defi=ST.tags.has('Kabe_RitualWon')
   ? 'Kabé t’invite à rejouer le rituel pour garder la salle accordée : la séquence est devenue votre signe discret.'
   : 'Kabé, maître des apéros clandestins, te propose un rituel d’infusion : enchaîner les gestes parfaits pour chasser la pression.';
   return `
  <p>Kabé orchestre le refuge : il dirige les apéros clandestins, rythme les souffles et surveille la Sourdine qui cogne.</p>
  <p>${souffle}</p>
  <p>${defi}</p>`;
  },
  choices:()=>[
    {label:'Composer le rituel du Kabé',hint:ST.tags.has('Kabe_RitualWon')?'Mini-jeu : rejouer pour le panache':'Mini-jeu : aligner la bonne séquence (stress -1 à la première victoire)',immediate:()=>openKabeGame()},
    {label:'Chuchoter un merci et ressortir',hint:'Retourner à la cour de Mazagran',go:'maz_common'},
    {label:'Suivre l’escalier vers les Berges',hint:'Retrouver la cave en douceur',go:'ber_entry'},
    {label:'Remonter vers la Place du Pont',hint:'Partager la chaleur du Kabé avec tes contacts',go:'place_return'}
  ]
 },
 maz_noor:{
 img:IMG.maz,title:'Mazagran — Le sac de Noor',text:()=>`
  <p>Le sac de Noor est coincé derrière un banc soudé. Les sangles collées à la rouille cèdent par à-coups tandis que l’eau goutte des bâches avec un rythme patient.</p>
  <p>Tu peux forcer le métal, t’aider de ton matériel ou descendre par la cave pour ressortir discrètement.</p>`,
  choices:[
    {label:'Forcer le banc',hint:'SOM/Mécanique (12) — libérer le sac (échec : +1 Blessure)',test:{stat:'SOM',skill:'Mécanique',dd:12,
      ok:s=>{s.tags.add('Noor_Sac');s.objective='Ramener le sac à Noor sur la Place du Pont.';addObj('Sac de Noor récupéré.');},ko:s=>{s.hp=Math.max(0,s.hp-1);log('Tu t’écorches sur le métal. +1 Blessure.')}}},
    {label:'Passer par la cave',hint:'CIN/Furtivité (10) — ressortir sans alerter',test:{stat:'CIN',skill:'Furtivité',dd:10,
      ok:s=>{s.tags.add('Sortie_Discrète');log('Personne ne t’a vu.');},ko:s=>{log('Lampe qui claque. Pas de dégâts.')}}},
    {label:'Découper les sangles au cutter',hint:'Utiliser ton outil pour libérer le sac sans bruit',when:()=>hasItem('Cutter')&&!ST.tags.has('Noor_Sac'),immediate:s=>{s.tags.add('Noor_Sac');s.objective='Ramener le sac à Noor sur la Place du Pont.';addObj('Le cutter entaille les sangles : sac de Noor libéré.');log('Le cutter grignote la rouille.');},go:'place_return'},
    {label:'Faire levier avec le tournevis isolé',hint:'Exploiter ton tournevis pour dégager le banc',when:()=>hasItem('Tournevis isolé')&&!ST.tags.has('Noor_Sac'),immediate:s=>{s.tags.add('Noor_Sac');s.tags.add('Sortie_Discrète');s.objective='Ramener le sac à Noor sur la Place du Pont.';addObj('Le tournevis isolé fait céder le banc sans déclencher d’alarme.');},go:'place_return'},
    {label:'Filer aux Berges',hint:'Rejoindre les darses sans perdre de temps',go:'ber_entry'},
    {label:'Investir l’atelier voisin',hint:'Tenter un détour social ou technique',go:'maz_atelier'},
    {label:'Retourner à la Place du Pont',hint:'Remettre le sac ou chercher du soutien',go:'place_return'}
  ]
 },
 maz_milo:{
 img:IMG.maz,title:'Mazagran — Le coffret de Milo',text:()=>`
  <p>Le coffret frappé du sceau de Milo est sanglé à un crochet. Des motifs gravés luisent sous la pluie ; le plomb est déjà ébréché et un code y est poinçonné.</p>`,
  choices:[
    {label:'Détacher le coffret pour Milo',hint:'Prépare le passe au Pont',immediate:s=>{s.tags.add('Coffret_Milo');gainItem('Coffret (Milo)');s.objective='Apporter le coffret à Milo pour obtenir le laissez-passer.';addObj('Coffret de Milo sécurisé.');}},
    {label:'Inspecter le coffret à la lampe plate',hint:'Révéler le code gravé (sans l’ouvrir)',when:()=>hasItem('Lampe plate')&&!ST.tags.has('Milo_Code'),immediate:s=>{s.tags.add('Milo_Code');s.objective='Utiliser le code de Milo pour traverser le Pont sans montrer le coffret.';addObj('Le faisceau révèle le code du coffret de Milo.');log('La lampe rase les motifs et révèle des chiffres cachés.');},go:'maz_milo'},
    {label:'Prendre la cave vers les Berges',hint:'Continuer vers la trappe technique',go:'ber_entry'},
    {label:'Se glisser vers l’atelier latéral',hint:'Approcher les ouvriers en douce',go:'maz_atelier'},
    {label:'Retourner vers la Place du Pont',hint:'Négocier le laissez-passer avec Milo',go:'place_return'}
  ]
 },

 maz_atelier:{
  img:IMG.maz,title:'Mazagran — Atelier latéral',text:()=>`
  <p>À l’intérieur, des ouvriers alignent des batteries sur des palettes et recalent une <b>nacelle</b> suspendue au-dessus de la vase.</p>
  <p>Ils cherchent des bras, des infos ou un coup de main technique.</p>`,
  choices:[
    {label:'Négocier avec la contremaîtresse',hint:'VOL/Empathie (10) — obtenir leur confiance',when:()=>!ST.tags.has('Atelier_Allie'),test:{stat:'VOL',skill:'Empathie',dd:10,
      ok:s=>{s.tags.add('Atelier_Allie');s.objective='Les ouvriers peuvent couvrir ton passage jusqu’aux Berges.';addObj('Les ouvriers de Mazagran te reconnaissent comme allié.');},
      ko:s=>{s.stress=Math.min(5,s.stress+1);log('On te jauge froidement. +1 Stress.');}
    },goOK:'maz_atelier',goKO:'maz_atelier'},
    {label:'Forcer le casier technique',hint:'CIN/Furtivité (10) — récupérer un badge',when:()=>!ST.tags.has('BadgeTech'),test:{stat:'CIN',skill:'Furtivité',dd:10,
      ok:s=>{gainItem('Badge maintenance');s.tags.add('BadgeTech');s.objective='Utiliser le badge pour traverser les contrôles du Pont.';addObj('Badge de maintenance subtilisé.');},
      ko:s=>{s.stress=Math.min(5,s.stress+1);log('Un crochet grince. +1 Stress.');}
    },goOK:'maz_atelier',goKO:'maz_atelier'},
    {label:'Calibrer leur génératrice',hint:'NEU/Mécanique (10) — stabiliser la nacelle',when:()=>!ST.tags.has('Berges_Stable'),test:{stat:'NEU',skill:'Mécanique',dd:10,
      ok:s=>{s.tags.add('Berges_Stable');s.objective='Descendre par la nacelle stabilisée vers les Berges.';addObj('La génératrice cale la nacelle : accès plus stable.');},
      ko:s=>{s.hp=Math.max(0,s.hp-1);log('Courant récalcitrant. +1 Blessure.');}
    },goOK:'maz_atelier',goKO:'maz_atelier'},
    {label:'Sangler la nacelle avec ton ruban textile',hint:'Mettre ton matériel au service de l’atelier',when:()=>hasItem('Ruban textile')&&!ST.tags.has('Berges_Stable'),immediate:s=>{s.tags.add('Berges_Stable');s.objective='Descendre par la nacelle stabilisée vers les Berges.';addObj('Ton ruban textile verrouille les attaches de la nacelle.');},go:'maz_atelier'},
    {label:'Retourner à la cour de Mazagran',hint:'Revenir vers les autres pistes',go:'maz_common'},
    {label:'Descendre vers les Berges',hint:'Suivre la voie préparée',go:'ber_entry'}
  ]
 },
 ber_entry:{
 img:IMG.ber,title:'Berges — Darses',text:()=>{
  const hints=[];
  if(ST.tags.has('Feuillet_Map')){hints.push('Les repères UV du feuillet scintillent sur un capot presque noyé.');}
  if(hasItem('Aimant-alu')){hints.push('Ton aimant-alu pulse doucement lorsque tu le rapproches du loquet.');}
  const extra=hints.length?`<p>${hints.join(' ')}</p>`:'';
  return `
  <p>La vase masque une trappe d’entretien. À chaque contact, le métal grince et vibre.</p>${extra}`;
 },
  choices:()=>{
    const arr=[
      {label:'Décrocher la trappe technique',hint:'NEU/Cryptanalyse (10) — ouvrir l’accès vers T1',test:{stat:'NEU',skill:'Cryptanalyse',dd:10,
        ok:s=>{s.tags.add('Acces_Tech');s.objective='Descendre vers T1 par la trappe technique.';addObj('Trappe vers T1 ouverte.');},ko:s=>{log('Contacts oxydés : il faudra insister.')}}},
      {label:'Remonter vers le Pont',hint:'Avec le coffret de Milo : passe-droit assuré',go:'pon_pass'}
    ];
    if(ST.tags.has('Feuillet_Map')&&!ST.tags.has('T1_Grille')){
      arr.push({label:'Suivre les repères du feuillet-mica',hint:'Utiliser la cartographie secrète de Noor',immediate:s=>{s.tags.add('Pont_Souterrain');s.tags.add('T1_Grille');s.objective='Atteindre T1 via la gaine repérée sur le feuillet.';addObj('Le feuillet révèle une gaine intacte vers T1.');log('Les repères UV scintillent : un passage s’ouvre.');},go:'pon_shadow'});
    }
    if(hasItem('Aimant-alu')&&!ST.tags.has('Acces_Tech')){
      arr.push({label:'Soulever la trappe avec ton aimant-alu',hint:'Déverrouiller en silence grâce à ton outil',immediate:s=>{s.tags.add('Acces_Tech');s.objective='Descendre vers T1 par la trappe technique.';addObj('Aimant-alu décroche les loquets de la trappe.');log('L’aimant attire les goupilles : la trappe bascule.');},go:'t1_overlook'});
    }
    if(ST.tags.has('Atelier_Allie')&&ST.tags.has('Berges_Stable')){
      arr.push({label:'Appeler la nacelle des ouvriers',hint:'Voie technique sécurisée',immediate:s=>{s.tags.add('Acces_Tech');s.tags.add('T1_Soutien');s.objective='Suivre la nacelle stabilisée jusqu’au périmètre de T1.';addObj('La nacelle de Mazagran t’abaisse vers la sous-station.');},go:'t1_overlook'});
    }
    arr.push({label:'Suivre la patrouille fluviale',hint:'Déployer un détour social ou furtif',go:'ber_patrouille'});
    if(ST.tags.has('Collectif_Dossier')){
      arr.push({label:'Rediriger les rondes grâce au planning volé',hint:'Créer une diversion sur le Pont',immediate:s=>{s.tags.delete('Collectif_Dossier');s.tags.add('Pont_Distrait');addObj('Tu détournes une patrouille loin du Pont.');},go:'ber_patrouille'});
    }
    arr.push({label:'Retourner vers la Place du Pont',hint:'Faire le point sur les alliances',go:'place_return'});
    return arr;
  }
 },

 ber_patrouille:{
  img:IMG.ber,title:'Berges — Patrouille fluviale',text:()=>`
  <p>Une barge grince contre les pieux. La patrouille fluviale tient les accès secondaires et jauge ton approche.</p>`,
  choices:[
    {label:'Négocier un couloir sûr',hint:'VOL/Empathie (10) — obtenir une escorte',test:{stat:'VOL',skill:'Empathie',dd:10,
      ok:s=>{s.tags.add('Pont_Escorte');s.objective='Traverser le Pont escorté par la patrouille.';addObj('La patrouille fluviale t’offre un passage encadré.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('On te renvoie vers la vase. +1 Stress.');}},goOK:'ber_entry',goKO:'ber_patrouille'},
    {label:'Suivre la patrouille à distance',hint:'CIN/Furtivité (11) — repérer la contre-voie',test:{stat:'CIN',skill:'Furtivité',dd:11,
      ok:s=>{s.tags.add('Pont_Souterrain');s.objective='Passer sous le pont par la contre-voie.';addObj('Itinéraire sous le tablier repéré.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Un projecteur t’accroche. +1 Stress.');}},goOK:'pon_shadow',goKO:'ber_patrouille'},
    {label:'Allumer une flamme de détresse',hint:'Utiliser ton briquet pour détourner la patrouille',when:()=>hasItem('Briquet')&&!ST.tags.has('Pont_Distrait'),immediate:s=>{s.tags.add('Pont_Distrait');s.objective='Profiter de la confusion pour franchir le Pont.';addObj('Une flamme brève attire la patrouille vers la vase.');log('Le briquet déclenche une flamme brève : la patrouille se disperse.');},go:'ber_entry'},
    {label:'Saboter le relais de détection',hint:'NEU/Cryptanalyse (11) — détourner les capteurs',test:{stat:'NEU',skill:'Cryptanalyse',dd:11,
      ok:s=>{s.tags.add('Pont_Distrait');s.objective='Profiter de la confusion pour franchir le Pont.';addObj('Les capteurs du Pont partent en boucle.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Les alarmes grincent. +1 Stress.');}},goOK:'ber_entry',goKO:'ber_patrouille'},
    {label:'Revenir vers les darses',hint:'Changer de stratégie',go:'ber_entry'}
  ]
 },
 pon_pass:{
 img:IMG.pon,title:'Pont de la Guill’ — Passage',text:()=>`
  <p>Deux guetteurs s’abritent sous le pont. Leurs badges grésillent et ils attendent un signe convaincant pour laisser passer quiconque vers T1.</p>`,
  choices:()=>{
    const a=[];
    if(ST.tags.has('Milo_Pass')){
      a.push({label:'Montrer le laissez-passer de Milo',hint:'Passe-droit négocié',immediate:s=>{s.objective='Traverser le Pont et atteindre T1.';log('Le laissez-passer de Milo claque, les guetteurs s’écartent.');},go:'t1_entry'});
    }else if(ST.tags.has('Coffret_Milo')){
      a.push({label:'Montrer le coffret — franchir le Pont',hint:'Passe-droit négocié avec Milo',immediate:s=>{s.objective='Traverser le Pont et atteindre T1.';log('« C’est pour Milo. » On te laisse filer.');},go:'t1_entry'});
    }
    if(ST.tags.has('Collectif_Pret')&&!ST.tags.has('Pont_Escorte')){
      a.push({label:'Appeler l’escorte du Collectif',hint:'Voie sociale préparée',immediate:s=>{s.tags.add('Pont_Escorte');s.objective='Traverser le Pont escorté par le Collectif.';addObj('Le Collectif t’encadre jusqu’au tablier.');},go:'t1_entry'});
    }
    if(ST.tags.has('Pont_Escorte')){
      a.push({label:'Suivre l’escorte jusqu’à T1',hint:'Route sociale sécurisée',immediate:s=>{s.objective='Laisser l’escorte te mener au périmètre de T1.';},go:'t1_entry'});
    }
    if(ST.tags.has('Milo_Code')&&!ST.tags.has('Milo_Pass')&&!ST.tags.has('Pont_Escorte')){
      a.push({label:'Énoncer le code gravé du coffret',hint:'Convaincre les guetteurs sans montrer de preuve',immediate:s=>{s.objective='Traverser le Pont et atteindre T1.';log('Le code de Milo ouvre la voie : les guetteurs te laissent filer.');},go:'t1_entry'});
    }
    if(ST.tags.has('Collectif_Dossier')){
      a.push({label:'Révéler le planning volé',hint:'Mettre la pression sur les guetteurs',immediate:s=>{s.tags.delete('Collectif_Dossier');s.tags.add('Pont_Distrait');addObj('Les guetteurs lâchent du lest face aux preuves.');},go:'pon_pass'});
    }
    if(ST.inv.includes('Badge maintenance')){
      a.push({label:'Badger la console de service',hint:'NEU/Mécanique (10) — accès technique',test:{stat:'NEU',skill:'Mécanique',dd:10,
        ok:s=>{s.tags.add('BadgeTech_Used');s.tags.add('Acces_Tech');s.inv=s.inv.filter(it=>it!=='Badge maintenance');s.objective='Remonter le couloir technique vers T1.';addObj('Badge de maintenance accepté sur le Pont.');},
        ko:s=>{s.stress=Math.min(5,s.stress+1);log('Le lecteur clignote rouge. +1 Stress.');}
      },goOK:'t1_entry',goKO:'pon_pass'});
    }
    if(ST.tags.has('Pont_Distrait')){
      a.push({label:'Profiter des capteurs en boucle',hint:'Glisser pendant la confusion',go:'pon_shadow'});
    }
    if(!ST.tags.has('Milo_Pass')){
      a.push({label:'Parler sec aux guetteurs',hint:'VOL/Intimidation (10) — passer par la parole',test:{stat:'VOL',skill:'Intimidation',dd:10,
        ok:s=>{s.objective='Traverser le Pont et atteindre T1.';log('Ça passe. Personne n’a envie d’histoires.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('On te balade. +1 Stress.');}
      },go:'t1_entry'});
      a.push({label:'Se glisser le long des barrières',hint:'CIN/Furtivité (12) — contour discret',test:{stat:'CIN',skill:'Furtivité',dd:12,
        ok:s=>{s.objective='Traverser le Pont et atteindre T1.';log('Tu files comme une ombre.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Repéré·e, tu forces. +1 Stress.');}
      },go:'t1_entry'});
    }
    a.push({label:'Descendre sous le tablier',hint:'Voie d’infiltration vers la contre-voie',go:'pon_shadow'});
    a.push({label:'Revenir vers la Place',hint:'Changer d’approche',go:'place_return'});
    return a;
  }
},

 pon_shadow:{
  img:IMG.pon,title:'Pont de la Guill’ — Contre-voie',text:()=>`
  <p>Sous le tablier, l’eau gifle les piliers. Des câbles pendent et une grille d’inspection bat au vent.</p>`,
  choices:[
    {label:'Ramper jusqu’à la grille',hint:'CIN/Furtivité (10) — baliser une infiltration',when:()=>!ST.tags.has('T1_Grille'),test:{stat:'CIN',skill:'Furtivité',dd:10,
      ok:s=>{s.tags.add('Pont_Souterrain');s.tags.add('T1_Grille');s.objective='Atteindre le périmètre de T1 par la grille d’inspection.';addObj('Chemin sous le tablier balisé.');},
      ko:s=>{s.stress=Math.min(5,s.stress+1);log('Une éclaboussure bruyante trahit ta présence. +1 Stress.');}},goOK:'t1_overlook',goKO:'pon_shadow'},
    {label:'Pirater le relais de surveillance',hint:'NEU/Cryptanalyse (11) — déclencher une boucle',test:{stat:'NEU',skill:'Cryptanalyse',dd:11,
      ok:s=>{s.tags.add('Pont_Distrait');addObj('Les capteurs du pont se remettent à zéro dans un grésillement.');},
      ko:s=>{s.stress=Math.min(5,s.stress+1);log('Le relais claque et t’oblige à reculer. +1 Stress.');}},goOK:'pon_pass',goKO:'pon_shadow'},
    {label:'Allumer une flamme rassurante',hint:'Utiliser ton briquet pour faire baisser la pression (stress -1)',when:()=>hasItem('Briquet')&&!ST.tags.has('Briquet_Calm')&&ST.stress>0,immediate:s=>{s.stress=Math.max(0,s.stress-1);s.tags.add('Briquet_Calm');log('La flamme vacille mais t’apaise. Stress -1.');},go:'pon_shadow'},
    {label:'Revenir vers les Berges',hint:'Retenter depuis les darses',go:'ber_entry'},
    {label:'Remonter vers la Place',hint:'Reprendre son souffle sous l’auvent',go:'place_return'}
  ]
 },
 t1_entry:{
 img:IMG.t1,title:'Sous-station T1 — Plans froissés',text:()=>`
  <p>« La douceur est une technologie », griffonné à la craie sur le béton. La porte principale tremble ; la grille renvoie un souffle tiède.</p>`,
  choices:()=>{
    const arr=[
      {label:'Déverrouiller la porte principale',hint:'NEU/Cryptanalyse (12) — ouvrir l’accès frontal',test:{stat:'NEU',skill:'Cryptanalyse',dd:12,
        ok:s=>{s.tags.add('T1_Ouverte');s.objective='Stabiliser le cœur de T1.';addObj('Porte principale de T1 ouverte.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Le ton faux te vrille. +1 Stress.');}}},
      {label:'Se glisser par la grille',hint:'CIN/Furtivité (10) — infiltration par le bas',test:{stat:'CIN',skill:'Furtivité',dd:10,
        ok:s=>{s.tags.add('T1_Grille');s.objective='Stabiliser le cœur de T1.';addObj('Tu t’infiltres par la grille.');},ko:s=>{log('Une vis tinte. Tu attends.');}}}
    ];
    if(hasItem('Tournevis isolé')&&!ST.tags.has('T1_Grille')){
      arr.push({label:'Démonter le panneau latéral',hint:'Utiliser ton tournevis pour créer un accès discret',immediate:s=>{s.tags.add('T1_Grille');s.tags.add('Acces_Tech');s.objective='Glisser vers le cœur de T1 par le panneau démonté.';addObj('Panneau latéral démonté grâce au tournevis isolé.');},go:'t1_overlook'});
    }
    if(ST.tags.has('Milo_Code')&&!ST.tags.has('T1_Ouverte')){
      arr.push({label:'Projeter le motif relevé sur la serrure',hint:'NEU/Déduction (9) — exploiter les codes de Milo',test:{stat:'NEU',skill:'Déduction',dd:9,
        ok:s=>{s.tags.add('T1_Ouverte');s.objective='Stabiliser le cœur de T1.';addObj('Le motif gravé synchronise la serrure de T1.');},
        ko:s=>{s.stress=Math.min(5,s.stress+1);log('Le motif rebondit sans effet. +1 Stress.');}
      },goOK:'t1_entry',goKO:'t1_entry'});
    }
    if(ST.tags.has('Noor_Trust')){
      arr.push({label:'Noor entrouvre la porte',hint:'Voie sociale depuis les caves',immediate:s=>{s.objective='Stabiliser le cœur de T1.';addObj('Noor te fait entrer par la cave.');}});
    }
    if(ST.tags.has('Pont_Escorte')&&!ST.tags.has('T1_Soutien')){
      arr.push({label:'Laisser l’escorte sécuriser l’entrée',hint:'Appui social pour tenir le périmètre',immediate:s=>{s.tags.add('T1_Soutien');s.objective='Stabiliser le cœur de T1 avec l’appui de l’escorte.';addObj('L’escorte verrouille l’entrée de T1.');},go:'t1_entry'});
    }
    if(ST.tags.has('Acces_Tech')||ST.tags.has('T1_Silence')){
      arr.push({label:'Suivre le couloir technique',hint:'Contourner par la passerelle',go:'t1_overlook'});
    }
    arr.push({label:'Contourner par la passerelle extérieure',hint:'Explorer le périmètre avant d’agir',go:'t1_overlook'});
    arr.push({label:'Revenir vers le Pont',hint:'Changer d’approche',go:'pon_pass'});
    arr.push({label:'Accéder au cœur',hint:'Disponible si une entrée est ouverte',when:()=>ST.tags.has('T1_Ouverte')||ST.tags.has('T1_Grille')||ST.tags.has('Noor_Trust')||ST.tags.has('T1_Soutien'),go:'t1_core'});
    return arr;
  }
 },

 t1_overlook:{
  img:IMG.t1,title:'Sous-station T1 — Périmètre',text:()=>`
  <p>La passerelle technique contourne le bâtiment. Des capteurs clignotent, certains arrachés par la Sourdine.</p>`,
  choices:[
    {label:'Se faufiler dans la gaine',hint:'CIN/Furtivité (10) — se positionner près du cœur',when:()=>!ST.tags.has('T1_Grille'),test:{stat:'CIN',skill:'Furtivité',dd:10,
      ok:s=>{s.tags.add('T1_Grille');s.objective='Stabiliser le cœur de T1 depuis la grille interne.';addObj('Gaine d’accès sécurisée.');},ko:s=>{s.stress=Math.min(5,s.stress+1);log('Un rivet claque. +1 Stress.');}},goOK:'t1_entry',goKO:'t1_overlook'},
    {label:'Synchroniser les capteurs',hint:'NEU/Cryptanalyse (11) — imposer un silence technique',when:()=>!ST.tags.has('T1_Silence'),test:{stat:'NEU',skill:'Cryptanalyse',dd:11,
      ok:s=>{s.tags.add('T1_Silence');s.tags.add('Acces_Tech');s.objective='Stabiliser le cœur de T1 à partir du périmètre sécurisé.';addObj('Capteurs synchronisés : la Sourdine se fait plus douce.');},
      ko:s=>{s.stress=Math.min(5,s.stress+1);log('Le réseau résiste. +1 Stress.');}},goOK:'t1_entry',goKO:'t1_overlook'},
    {label:'Coordonner l’escorte',hint:'VOL/Empathie (10) — utiliser l’appui social',when:()=>ST.tags.has('Pont_Escorte')&&!ST.tags.has('T1_Soutien'),test:{stat:'VOL',skill:'Empathie',dd:10,
      ok:s=>{s.tags.add('T1_Soutien');s.objective='Stabiliser le cœur de T1 avec un périmètre tenu par tes alliés.';addObj('L’escorte verrouille les issues autour de T1.');},
      ko:s=>{s.stress=Math.min(5,s.stress+1);log('La coordination déraille. +1 Stress.');}},goOK:'t1_entry',goKO:'t1_overlook'},
    {label:'Revenir à l’entrée principale',hint:'Retenter les accès frontaux',go:'t1_entry'},
    {label:'Rejoindre le Pont',hint:'Changer de stratégie',go:'pon_pass'}
  ]
 },
 t1_core:{
  img:IMG.t1,title:'Sous-station T1 — Cœur',text:()=>`
  <p>Le cœur de T1 vibre. Trois leviers bricolés clignotent : <b>Contournement</b>, <b>Relance</b>, <b>Trame douce</b>. Chaque option a son prix.</p>`,
  choices:()=>{
    const arr=[];
    if(hasItem('Gants usés')&&!ST.tags.has('Leviers_Prepares')){
      arr.push({label:'Enfiler tes gants sur les leviers',hint:'Préparer les commandes contre les arcs',immediate:s=>{s.tags.add('Leviers_Prepares');addObj('Les leviers sont isolés par tes gants usés.');log('Tu glisses tes gants usés sur les leviers : l’arc sera amorti.');},go:'t1_core'});
    }
    if(hasItem('Ruban textile')&&!ST.tags.has('Leviers_Prepares')){
      arr.push({label:'Enrubanner les câbles avec ton ruban',hint:'Renforcer l’isolation avant d’agir',immediate:s=>{s.tags.add('Leviers_Prepares');addObj('Le ruban textile amortit les arcs autour des leviers.');log('Tu bandes les leviers de ruban textile.');},go:'t1_core'});
    }
    arr.push({label:'Contournement — gagner du temps',hint:'SOM/Mécanique (10) — détourner les flux (+1 Flux)',test:{stat:'SOM',skill:'Mécanique',dd:10,
      ok:s=>{s.flux=Math.max(0,s.flux+1);s.objective='Quitter la zone avant la prochaine alerte.';addObj('Contournement posé : la nuit tiendra un peu plus.');clearEndingTags();markEndingApproach();s.tags.add('End_Contournement');},
      ko:s=>{
        if(s.tags.has('Leviers_Prepares')){
          s.tags.delete('Leviers_Prepares');
          log('La protection improvisée brûle mais tu restes indemne.');
        }else{
          s.hp=Math.max(0,s.hp-1);
          log('Coup de jus. +1 Blessure.');
        }
      }
    },goOK:()=>pickEnding('cont'),goKO:'ep_silent'});
    arr.push({label:'Relance — plus risqué',hint:'NEU/Déduction (12) — redémarrage bruyant',test:{stat:'NEU',skill:'Déduction',dd:12,
      ok:s=>{s.tags.add('Relance');addObj('Relance réussie : T1 repart en claquant.');clearEndingTags();markEndingApproach();s.tags.add('End_Noise');},
      ko:s=>{
        if(s.tags.has('Leviers_Prepares')){
          s.tags.delete('Leviers_Prepares');
          log('Le ruban fume mais tu restes concentré·e.');
        }else{
          s.stress=Math.min(5,s.stress+1);
          log('Tu recules. +1 Stress.');
        }
      }
    },goOK:()=>pickEnding('noise'),goKO:'ep_silent'});
    arr.push({label:'Trame douce — protéger les souvenirs',hint:'VOL/Empathie (12) + ✦ — apaiser la Sourdine',test:{stat:'VOL',skill:'Empathie',dd:12,needsFrag:true,
      ok:s=>{s.tags.add('Trame_Douce');s.frag=Math.max(0,s.frag-1);addObj('Voile tiré : les mémoires restent en place.');clearEndingTags();markEndingApproach();s.tags.add('End_Soft');},
      ko:s=>{log('Tu n’oses pas. Rien ne casse.');}
    },goOK:()=>pickEnding('soft'),goKO:'ep_silent'});
    return arr;
  }
 },
 ep_cont:{img:IMG.t1,title:'Épilogue — Contournement',text:()=>`
  <p>Le quartier respire encore. Ce n’est pas brillant, mais tu as gagné quelques heures.</p>`,choices:[{label:'Recommencer (retour Prologue)',go:'prologue'}]},

 ep_cont_social:{img:IMG.t1,title:'Épilogue — Contournement collectif',text:()=>`
  <p>Le contournement reste discret grâce aux relais du quartier. Les escortes bloquent les curieux et entretiennent la dérivation.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_cont_shadow:{img:IMG.t1,title:'Épilogue — Contournement clandestin',text:()=>`
  <p>Sous le tablier, tu maintiens la dérivation sans qu’aucun guetteur ne comprenne comment tu as filé.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_cont_tech:{img:IMG.t1,title:'Épilogue — Contournement technique',text:()=>`
  <p>Les capteurs stabilisés guident le flux de réserve. T1 ronronne à bas bruit, mais tu sais où surveiller les prochains points chauds.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_noise:{img:IMG.t1,title:'Épilogue — Relance',text:()=>`
  <p>T1 claque comme une ampoule neuve. Certains applaudiront, d’autres t’en voudront pour le vacarme.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},

 ep_noise_social:{img:IMG.t1,title:'Épilogue — Relance soutenue',text:()=>`
  <p>Le vacarme de T1 est couvert par les chants et les slogans. Les collectifs assument le bruit et revendiquent la relance.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_noise_shadow:{img:IMG.t1,title:'Épilogue — Relance fantôme',text:()=>`
  <p>La relance tonne, mais tu disparais déjà sur la contre-voie. On ne sait pas qui a rendu la lumière.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_noise_tech:{img:IMG.t1,title:'Épilogue — Relance calibrée',text:()=>`
  <p>Les transformateurs claquent en cadence. Tu laisses derrière toi des diagnostics détaillés et des alarmes maîtrisées.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_soft:{img:IMG.t1,title:'Épilogue — Trame douce',text:()=>`
  <p>La Sourdine se relâche. Des visages se souviennent mieux. Tu laisses la nuit respirer.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},

 ep_soft_collectif:{img:IMG.t1,title:'Épilogue — Trame douce partagée',text:()=>`
  <p>Les souvenirs se solidarisent sur la Place. Le Collectif transmet ce qu’il a appris pour maintenir la douceur.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_soft_shadow:{img:IMG.t1,title:'Épilogue — Trame douce furtive',text:()=>`
  <p>Tu quittes T1 sans bruit. Derrière toi, la Sourdine se calme le long du passage souterrain.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_soft_tech:{img:IMG.t1,title:'Épilogue — Trame douce synchronisée',text:()=>`
  <p>Les capteurs alignés diffusent un voile stable. Les habitants respirent enfin sans craindre l’oubli immédiat.</p>`,choices:[{label:'Recommencer',go:'prologue'}]},
 ep_silent:{img:IMG.t1,title:'Épilogue — Silence',text:()=>`
  <p>T1 se tait. Tu coupes proprement et promets de revenir avec plus de temps.</p>`,choices:[{label:'Recommencer',go:'prologue'}]}
};

/* ======= RENDER ENGINE ======= */
function render(){
  markVisited(ST.scene);
  const sc=SC[ST.scene]; if(!sc) return;
  if(ST.scene==='prologue'){ST.objective='Tracer une voie sûre vers T1.';}
  $('#storyTitle').textContent=sc.title;
  $('#storyText').innerHTML=sc.text?sc.text():'';
  const i=sc.img||IMG.place; $('#storyImg').src=i.src; $('#imgLegend').textContent=i.lg||'';
  const box=$('#choices'); box.innerHTML='';
  const arr=typeof sc.choices==='function'?sc.choices():sc.choices;
  (arr||[]).forEach((c,idx)=>{
    if(c.when && !c.when()) return;
    const div=document.createElement('div'); div.className='choice';
    if(c.test && c.test.stat) div.classList.add('attr-'+c.test.stat);
    const testTags=c.test?`<span class="tag">${c.test.stat}</span><span class="tag">${c.test.skill||''}</span><span class="tag">DD ${c.test.dd}</span>`:'';
    div.innerHTML=`<strong>${idx+1}. ${c.label}</strong><small>${c.hint||''}</small><div class="tags">${testTags}</div>`;
    div.addEventListener('click',()=>handleChoice(c));
    box.appendChild(div);
  });
  bars(); renderStats(); renderInventory(); renderAscii(); $('#objectiveText').textContent=ST.objective;
}
let pending=null, roll=null, pendingOutcome=null;
function resolveSceneTarget(target,outcome){
  if(typeof target==='function'){
    return target(ST,outcome)||null;
  }
  return target||null;
}
function handleChoice(c){
  const immediateOnly = !!c.immediate && !c.go && !c.test;
  if(c.immediate) c.immediate(ST);
  if(c.go && !c.test){
    const target=resolveSceneTarget(c.go);
    if(target){
      ST.scene=target;
      const nextSc=SC[ST.scene];
      addObj('Déplacement: '+(nextSc?nextSc.title:ST.scene));
      save(); render();
      return;
    }
  }
  if(c.test){ pending=c; showTest(c); return; }
  if(immediateOnly){ save(); render(); return; }
  if(c.immediate){ save(); render(); }
}
function showTest(c){
  $('#testPanel').style.display='block';
  $('#testName').textContent=`${c.test.stat}/${c.test.skill||'-'}`;
  $('#testDD').textContent=c.test.dd;
  const fluxBox=$('#useFlux');
  const pushBox=$('#usePush');
  const fragBox=$('#useFrag');
  if(fluxBox){fluxBox.checked=false; fluxBox.disabled=ST.flux<=0;}
  if(pushBox){pushBox.checked=false;}
  if(fragBox){
    const needsFrag=!!c.test.needsFrag;
    fragBox.checked=needsFrag && ST.frag>0;
    fragBox.disabled=ST.frag<=0;
  }
  const rollBtn=$('#rollBtn');
  if(rollBtn){rollBtn.disabled=false; rollBtn.onclick=()=>startDice();}
  const resultBox=$('#testResult');
  if(resultBox){resultBox.textContent='';resultBox.classList.remove('show','success','fail');}
  updateTestHint();
}

function gatherModifiers(test){
  const result={mod:0,breakdown:[],previewParts:[],spendFlux:false,spendPush:false,spendFrag:false};
  if(!test) return result;
  if(test.stat){
    const base=ST.stats[test.stat]||0;
    result.mod+=base;
    result.breakdown.push(`Attribut ${test.stat} +${base}`);
    result.previewParts.push(`Base ${test.stat} ${base}`);
  }
  const skillName=test.skill||null;
  if(skillName){
    if(ST.skills[skillName]>0){
      result.mod+=1;
      result.breakdown.push(`Compétence ${skillName} +1`);
      result.previewParts.push(`Compétence ${skillName} +1`);
    }
    if(skillName==='Furtivité'&&ST.arch?.id==='noor'){
      result.mod+=1;
      result.breakdown.push('Noor +1 Furtivité');
      result.previewParts.push('Noor +1 Furtivité');
    }
    if(skillName==='Intimidation'&&ST.arch?.id==='milo'){
      result.mod+=1;
      result.breakdown.push('Milo +1 Intimidation');
      result.previewParts.push('Milo +1 Intimidation');
    }
    if(skillName==='Mécanique'&&ST.arch?.id==='rayan'){
      result.mod+=1;
      result.breakdown.push('Rayan +1 Mécanique');
      result.previewParts.push('Rayan +1 Mécanique');
    }
  }
  const fluxEl=$('#useFlux');
  if(fluxEl && fluxEl.checked && ST.flux>0){
    result.mod+=2;
    result.breakdown.push('Flux +2');
    result.previewParts.push('Flux +2');
    result.spendFlux=true;
  }
  const pushEl=$('#usePush');
  if(pushEl && pushEl.checked){
    result.mod+=2;
    result.breakdown.push('Chance +2');
    result.previewParts.push('Chance +2');
    result.spendPush=true;
  }
  const fragEl=$('#useFrag');
  if(fragEl && fragEl.checked && ST.frag>0){
    result.mod+=2;
    result.breakdown.push('Fragment +2 (stress +1)');
    result.previewParts.push('Fragment +2 (+1 Stress)');
    result.spendFrag=true;
  }
  return result;
}

function previewOutcome(test=pending?.test){
  if(!test) return null;
  const mods=gatherModifiers(test);
  return {
    mod:mods.mod,
    dd:test.dd||0,
    parts:mods.previewParts,
    spendFlux:mods.spendFlux,
    spendPush:mods.spendPush,
    spendFrag:mods.spendFrag
  };
}

function updateTestHint(){
  const hint=$('#testHint');
  if(!hint) return;
  const test=pending?.test;
  const rollBtn=$('#rollBtn');
  const fragEl=$('#useFrag');
  if(!test){
    hint.textContent='';
    if(rollBtn) rollBtn.disabled=false;
    return;
  }
  const needsFrag=!!test.needsFrag;
  const fragAvailable=ST.frag>0;
  if(fragEl){
    if(needsFrag){
      if(fragAvailable && !fragEl.checked){ fragEl.checked=true; }
      if(!fragAvailable){ fragEl.checked=false; }
      fragEl.disabled=!fragAvailable;
    }else{
      fragEl.disabled=ST.frag<=0;
    }
  }
  if(needsFrag && !fragAvailable){
    if(rollBtn) rollBtn.disabled=true;
    hint.textContent='Fragment requis (+1 Stress) indisponible.';
    return;
  }
  if(rollBtn) rollBtn.disabled=false;
  const preview=previewOutcome(test);
  if(!preview){
    hint.textContent='';
    return;
  }
  const parts=preview.parts.length?preview.parts:['Aucun modificateur'];
  const modSign=preview.mod>=0?`+${preview.mod}`:`${preview.mod}`;
  hint.textContent=`${parts.join(' + ')} = ${modSign} (Total cible ${preview.dd})`;
}
function startDice(){
  if(!pending) return;
  roll=null; pendingOutcome=null;
  $('#diceOverlay').style.display='flex';
  $('#d1').classList.add('anim'); $('#d2').classList.add('anim');
  $('#d1').textContent='•'; $('#d2').textContent='•';
  $('#diceInfo').innerHTML='<div class="diceSummary">Les dés roulent…</div><div class="diceBreakdown">Appuie sur « Figer le résultat » quand tu es prêt·e.</div>';
  const stop=$('#btnStopDice'), cont=$('#btnResolveDice');
  if(stop){stop.disabled=false;}
  if(cont){cont.style.display='none';}
}
function computeOutcome(){
  if(!pending||!roll) return null;
  const mods=gatherModifiers(pending.test);
  const total=roll.sum+mods.mod;
  const dd=pending.test.dd;
  const ok=total>=dd;
  return {
    mod:mods.mod,
    total,
    dd,
    ok,
    spendFlux:mods.spendFlux,
    spendFrag:mods.spendFrag,
    spendPush:mods.spendPush,
    breakdown:mods.breakdown
  };
}
function stopDice(){
  if(!pending||pendingOutcome) return;
  $('#d1').classList.remove('anim'); $('#d2').classList.remove('anim');
  const a=1+Math.floor(Math.random()*6), b=1+Math.floor(Math.random()*6);
  $('#d1').textContent=a; $('#d2').textContent=b;
  roll={a,b,sum:a+b};
  pendingOutcome=computeOutcome();
  let html=`<div class="diceSummary">Résultat : ${a} + ${b} = ${roll.sum}</div>`;
  if(pendingOutcome){
    const mods=pendingOutcome.breakdown.length?pendingOutcome.breakdown.join(' · '):'Aucun modificateur';
    html+=`<div class="diceBreakdown">Modificateurs : ${mods}</div>`;
    html+=`<div class="diceBreakdown">Total : ${roll.sum} + ${pendingOutcome.mod} = ${pendingOutcome.total}</div>`;
    html+=`<div class="diceStatus ${pendingOutcome.ok?'success':'fail'}">${pendingOutcome.ok?'Réussite':'Échec'} — ${pendingOutcome.total} (DD ${pendingOutcome.dd})</div>`;
    html+=`<div class="diceBreakdown">Clique sur « Continuer » pour résoudre ce lancer.</div>`;
  }
  $('#diceInfo').innerHTML=html;
  const stop=$('#btnStopDice'), cont=$('#btnResolveDice');
  if(stop){stop.disabled=true;}
  if(cont){cont.style.display='inline-flex';cont.focus();}
}
$('#btnStopDice').addEventListener('click', stopDice);
$('#btnResolveDice').addEventListener('click', resolveRoll);
['#useFlux','#usePush','#useFrag'].forEach(sel=>{
  const el=$(sel);
  if(el){ el.addEventListener('change', updateTestHint); }
});
function resolveRoll(){
  if(!pending||!roll||!pendingOutcome) return;
  const c=pending, outcome=pendingOutcome;
  if(outcome.spendFlux){ST.flux--;}
  if(outcome.spendFrag){ST.frag--;ST.stress=Math.min(5,ST.stress+1);log('Le fragment te mord. +1 Stress.');}
  log(`${c.test.stat}/${c.test.skill||'-'} DD${outcome.dd} — ${roll.a}+${roll.b}=${roll.sum} + ${outcome.mod} = ${outcome.total} → ${outcome.ok?'Réussite':'Échec'}`);
  let next=null;
  if(outcome.ok){
    if(c.test.ok) c.test.ok(ST);
    next=resolveSceneTarget(c.goOK||c.go,outcome);
  }else{
    if(c.test.ko) c.test.ko(ST);
    next=resolveSceneTarget(c.goKO||c.go,outcome);
  }
  const resultBox=$('#testResult');
  if(resultBox){
    resultBox.textContent=`${outcome.ok?'Réussite':'Échec'} — ${outcome.total} (DD ${outcome.dd})`;
    resultBox.classList.remove('show','success','fail');
    resultBox.classList.add('show', outcome.ok?'success':'fail');
  }
  pending=null; roll=null; pendingOutcome=null;
  updateTestHint();
  const stop=$('#btnStopDice'), cont=$('#btnResolveDice');
  if(stop){stop.disabled=false;}
  if(cont){cont.style.display='none';}
  $('#diceOverlay').style.display='none';
  if(next){
    ST.scene=next;
    const nextSc=SC[next];
    addObj('Déplacement: '+(nextSc?nextSc.title:next));
    $('#testPanel').style.display='none';
  }
  else { $('#testPanel').style.display='block'; }
  save(); render();
}

/* ======= ARCHETYPES ======= */
$('#btnChooseArch').addEventListener('click',()=>{ $('#introModal').style.display='none'; openArch(); });
let sel=null;
function openArch(){
  const list=$('#archList'); list.innerHTML='';
  sel=ST.arch||null;
  $('#btnConfirm').disabled=!sel;
  ARCH.forEach(a=>{ const card=document.createElement('div'); card.className='arch'; card.innerHTML=`
    <img src="${a.img}" alt="${a.name}"><div class="pad"><h3>${a.name}</h3><p>${a.back}</p>
    <div class="statrow"><span class="b">NEU ${a.stats.NEU}</span><span class="b">VOL ${a.stats.VOL}</span><span class="b">SOM ${a.stats.SOM}</span><span class="b">CIN ${a.stats.CIN}</span></div></div>`;
    card.setAttribute('role','button');
    card.setAttribute('tabindex','0');
    card.setAttribute('aria-selected','false');
    card.addEventListener('click',()=>selectArch(a,card));
    card.addEventListener('keydown',e=>{
      if(e.key==='Enter'||e.key===' '||e.key==='Spacebar'){e.preventDefault();selectArch(a,card);} });
    if(ST.arch && ST.arch.id===a.id){ sel=a; card.setAttribute('aria-selected','true'); $('#btnConfirm').disabled=false; }
    list.appendChild(card); });
  $('#archModal').style.display='flex';
}
function selectArch(a,card){ sel=a; document.querySelectorAll('.arch').forEach(x=>x.setAttribute('aria-selected','false')); card.setAttribute('aria-selected','true'); $('#btnConfirm').disabled=false; }
$('#btnRandom').addEventListener('click',()=>{const i=Math.floor(Math.random()*ARCH.length);selectArch(ARCH[i], document.querySelectorAll('.arch')[i])});
$('#btnConfirm').addEventListener('click',()=>{ ST.arch=sel; ST.stats={...sel.stats}; ST.skills={...sel.skills}; ST.inv=[...sel.start];
  addObj('Archétype: '+sel.name); $('#archModal').style.display='none'; save(); render(); });

/* ======= INIT ======= */
setupNav(); // header + mobile bar
const mobileMq=window.matchMedia ? window.matchMedia('(max-width: 900px)') : null;
const syncView=e=>{
  if(!e.matches && document.body.getAttribute('data-view')!=='all'){
    setView('all');
  }
};
if(mobileMq){
  syncView(mobileMq);
  if(mobileMq.addEventListener){ mobileMq.addEventListener('change',syncView); }
  else if(mobileMq.addListener){ mobileMq.addListener(syncView); }
}
setView(document.body.getAttribute('data-view')||'all');
load();
renderStats(); renderInventory(); renderAscii(); renderTimeline(); bars(); render();
if(!ST.arch){ $('#introModal').style.display='flex'; }
</script>
</body>
</html>
